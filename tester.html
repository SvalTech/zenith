<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KOTA HOD: Cyberpunk Protocol v3.0</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Marked for Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- KaTeX for Math Rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Fonts: Orbitron for HUD, Rajdhani for text -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --neon-red: #ff003c;
            --neon-blue: #00f3ff;
            --neon-green: #00ff41;
            --bg-dark: #050505;
            --grid-color: rgba(0, 243, 255, 0.1);
        }

        body {
            background-color: var(--bg-dark);
            color: #e0f7fa;
            font-family: 'Rajdhani', sans-serif;
            overflow: hidden;
            height: 100vh;
        }

        /* --- Cyberpunk Grid Background --- */
        .cyber-grid {
            position: fixed;
            width: 200%;
            height: 200%;
            top: -50%;
            left: -50%;
            background-image: 
                linear-gradient(var(--grid-color) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid-color) 1px, transparent 1px);
            background-size: 50px 50px;
            transform: perspective(500px) rotateX(60deg);
            animation: grid-move 20s linear infinite;
            z-index: 0;
            pointer-events: none;
            opacity: 0.5;
        }

        @keyframes grid-move {
            0% { transform: perspective(500px) rotateX(60deg) translateY(0); }
            100% { transform: perspective(500px) rotateX(60deg) translateY(50px); }
        }

        /* --- CRT Scanlines --- */
        .scanlines {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%;
            z-index: 50;
            pointer-events: none;
        }

        /* --- HUD Elements --- */
        .hud-border {
            border: 1px solid var(--neon-blue);
            box-shadow: 0 0 5px var(--neon-blue), inset 0 0 10px rgba(0, 243, 255, 0.2);
            backdrop-filter: blur(5px);
            background: rgba(5, 5, 5, 0.8);
        }

        .hud-text {
            font-family: 'Orbitron', sans-serif;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .hud-red {
            border-color: var(--neon-red);
            box-shadow: 0 0 5px var(--neon-red), inset 0 0 10px rgba(255, 0, 60, 0.2);
            color: var(--neon-red);
        }

        /* --- Glitch Effect --- */
        .glitch {
            position: relative;
        }
        .glitch::before, .glitch::after {
            content: attr(data-text);
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
        }
        .glitch::before {
            left: 2px; text-shadow: -1px 0 red; clip: rect(24px, 550px, 90px, 0);
            animation: glitch-anim-2 3s infinite linear alternate-reverse;
        }
        .glitch::after {
            left: -2px; text-shadow: -1px 0 blue; clip: rect(85px, 550px, 140px, 0);
            animation: glitch-anim 2.5s infinite linear alternate-reverse;
        }
        @keyframes glitch-anim {
            0% { clip: rect(11px, 9999px, 81px, 0); }
            20% { clip: rect(68px, 9999px, 19px, 0); }
            40% { clip: rect(10px, 9999px, 86px, 0); }
            60% { clip: rect(44px, 9999px, 20px, 0); }
            80% { clip: rect(18px, 9999px, 49px, 0); }
            100% { clip: rect(98px, 9999px, 78px, 0); }
        }

        /* --- Chat Bubbles --- */
        .hod-message {
            border-left: 3px solid var(--neon-red);
            background: rgba(20, 0, 0, 0.6);
            clip-path: polygon(0 0, 100% 0, 100% 90%, 98% 100%, 0 100%);
        }
        .user-message {
            border-right: 3px solid var(--neon-blue);
            background: rgba(0, 20, 20, 0.6);
            clip-path: polygon(0 0, 100% 0, 100% 100%, 2% 100%, 0 90%);
            text-align: right;
            margin-left: auto;
        }

        /* --- Markdown & Math --- */
        .prose strong { color: var(--neon-blue); }
        .prose ul { list-style: none; padding-left: 0; }
        .prose li::before { content: "> "; color: var(--neon-red); }
        .katex-display { margin: 1em 0; overflow-x: auto; }
        
        /* --- Inputs --- */
        .cyber-input {
            background: rgba(0,0,0,0.8);
            border: 1px solid #333;
            color: var(--neon-blue);
            font-family: 'Rajdhani', sans-serif;
            font-size: 1.1rem;
            transition: all 0.3s;
        }
        .cyber-input:focus {
            border-color: var(--neon-blue);
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.3);
            outline: none;
        }
        
        .cyber-btn {
            background: rgba(0, 243, 255, 0.1);
            border: 1px solid var(--neon-blue);
            color: var(--neon-blue);
            font-family: 'Orbitron', sans-serif;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        .cyber-btn:hover {
            background: var(--neon-blue);
            color: #000;
            box-shadow: 0 0 20px var(--neon-blue);
        }
        .cyber-btn:active { transform: scale(0.98); }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: var(--neon-blue); }
    </style>
</head>
<body class="flex flex-col relative">

    <div class="cyber-grid"></div>
    <div class="scanlines"></div>

    <!-- HUD Header -->
    <header class="p-4 z-20 flex justify-between items-end border-b border-[#333] bg-black/80 backdrop-blur">
        <div class="flex flex-col">
            <h1 class="hud-text text-2xl font-black text-white glitch" data-text="KOTA_HOD_OS">KOTA_HOD_OS</h1>
            <div class="flex items-center space-x-2 mt-1">
                <span class="text-xs text-gray-400">TARGET:</span>
                <span class="text-xs text-[#ff003c] font-bold glow">JEE MAIN 2026</span>
            </div>
        </div>

        <!-- Rank Display -->
        <div class="hud-border px-6 py-2 flex flex-col items-center">
            <span class="text-[10px] text-gray-400 tracking-widest">CURRENT RANK</span>
            <div class="flex items-baseline space-x-2">
                <span class="text-xl text-yellow-400 font-mono">AIR</span>
                <span id="rank-display" class="text-3xl font-bold text-white font-mono glitch" data-text="150000">150,000</span>
            </div>
            <div id="rank-delta" class="h-4 text-xs font-bold"></div>
        </div>

        <!-- Stress Meter -->
        <div class="w-32">
            <div class="flex justify-between text-[10px] text-gray-400 mb-1">
                <span>STRESS</span>
                <span id="stress-val">0%</span>
            </div>
            <div class="h-2 bg-gray-900 border border-gray-700 rounded-sm overflow-hidden">
                <div id="stress-bar" class="h-full bg-[#ff003c] w-0 transition-all duration-500"></div>
            </div>
        </div>
        
        <button id="settings-btn" class="cyber-btn p-2" title="Config">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
        </button>
    </header>

    <!-- Main Chat -->
    <main id="chat-container" class="flex-1 overflow-y-auto p-6 space-y-6 z-10 scroll-smooth pb-32">
        <div id="welcome-screen" class="flex flex-col items-center justify-center h-full text-center opacity-80">
            <div class="hud-border p-10 max-w-lg relative bg-black">
                <div class="absolute top-0 left-0 w-2 h-2 bg-white"></div>
                <div class="absolute top-0 right-0 w-2 h-2 bg-white"></div>
                <div class="absolute bottom-0 left-0 w-2 h-2 bg-white"></div>
                <div class="absolute bottom-0 right-0 w-2 h-2 bg-white"></div>
                
                <h2 class="text-4xl hud-text text-[#ff003c] mb-4">SYSTEM_OFFLINE</h2>
                <p class="text-gray-400 mb-6">Connect API Key to initialize Rank Gatekeeper Protocol.</p>
                <button id="init-btn" class="cyber-btn px-8 py-3 font-bold text-lg w-full">INITIALIZE</button>
            </div>
        </div>
    </main>

    <!-- Input Deck -->
    <footer class="absolute bottom-0 w-full p-4 bg-gradient-to-t from-black via-black to-transparent z-20">
        <div class="max-w-5xl mx-auto space-y-3">
            
            <!-- Quick Actions -->
            <div class="grid grid-cols-6 gap-2">
                <button onclick="sendOption('A')" class="cyber-btn col-span-1 py-3 text-lg font-bold">A</button>
                <button onclick="sendOption('B')" class="cyber-btn col-span-1 py-3 text-lg font-bold">B</button>
                <button onclick="sendOption('C')" class="cyber-btn col-span-1 py-3 text-lg font-bold">C</button>
                <button onclick="sendOption('D')" class="cyber-btn col-span-1 py-3 text-lg font-bold">D</button>
                
                <div class="col-span-2 flex space-x-1">
                    <input type="number" id="num-input" placeholder="12.5" class="cyber-input w-full px-3 text-center font-mono">
                    <button onclick="sendNumeric()" class="cyber-btn px-4 text-[#00ff41] border-[#00ff41]">↵</button>
                </div>
            </div>

            <!-- Text Input -->
            <div class="flex space-x-2">
                <input type="text" id="text-input" placeholder="Enter topic or explanation..." class="cyber-input w-full p-4">
                <button onclick="sendText()" class="cyber-btn px-8 font-bold bg-[#ff003c] text-black border-[#ff003c] hover:text-white">SEND</button>
            </div>
        </div>
    </footer>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black/90 z-50 hidden flex items-center justify-center">
        <div class="hud-border p-8 w-full max-w-md bg-black relative">
            <h3 class="hud-text text-xl text-white mb-6 border-b border-gray-800 pb-2">SYSTEM CONFIG</h3>
            <label class="block text-[#00f3ff] text-xs uppercase tracking-widest mb-2">Gemini API Key</label>
            <input type="password" id="api-key-input" class="cyber-input w-full p-3 mb-6">
            <div class="flex justify-end space-x-4">
                <button id="close-settings" class="text-gray-500 hover:text-white uppercase text-xs font-bold tracking-wider">Cancel</button>
                <button id="save-settings" class="cyber-btn px-6 py-2 text-xs font-bold">CONNECT</button>
            </div>
        </div>
    </div>

    <script>
        // --- GAME STATE ---
        let currentRank = 150000;
        let stressLevel = 0;
        let apiKey = localStorage.getItem('gemini_api_key') || '';
        let chatHistory = [];

        // --- DOM ---
        const chatContainer = document.getElementById('chat-container');
        const welcomeScreen = document.getElementById('welcome-screen');
        const textInput = document.getElementById('text-input');
        const numInput = document.getElementById('num-input');
        const settingsModal = document.getElementById('settings-modal');
        const apiKeyInput = document.getElementById('api-key-input');
        const rankDisplay = document.getElementById('rank-display');
        const rankDelta = document.getElementById('rank-delta');
        const stressBar = document.getElementById('stress-bar');
        const stressVal = document.getElementById('stress-val');

        // --- INIT ---
        apiKeyInput.value = apiKey;
        updateUI();

        // --- EVENTS ---
        document.getElementById('settings-btn').addEventListener('click', () => settingsModal.classList.remove('hidden'));
        document.getElementById('close-settings').addEventListener('click', () => settingsModal.classList.add('hidden'));
        document.getElementById('save-settings').addEventListener('click', () => {
            apiKey = apiKeyInput.value.trim();
            localStorage.setItem('gemini_api_key', apiKey);
            settingsModal.classList.add('hidden');
            if(apiKey) alert('UPLINK ESTABLISHED');
        });
        document.getElementById('init-btn').addEventListener('click', () => {
            if (!apiKey) return alert('ERROR: MISSING API KEY');
            welcomeScreen.classList.add('hidden');
            startSession();
        });

        // --- CORE FUNCTIONS ---

        function updateUI() {
            // Rank
            if (currentRank < 1) currentRank = 1;
            rankDisplay.innerText = currentRank.toLocaleString();
            
            // Stress
            if (stressLevel < 0) stressLevel = 0;
            if (stressLevel > 100) stressLevel = 100;
            stressBar.style.width = `${stressLevel}%`;
            stressVal.innerText = `${stressLevel}%`;
            
            if (stressLevel > 80) {
                stressBar.style.backgroundColor = 'red';
                document.body.classList.add('shake-hard'); // Assuming class exists or add simpler visual
            } else {
                stressBar.style.backgroundColor = '#ff003c';
            }
        }

        function handleDelta(delta) {
            currentRank += delta;
            
            if (delta < 0) {
                // Good (Rank dropped numerically)
                rankDelta.innerText = `▲ ${Math.abs(delta)} IMPROVEMENT`;
                rankDelta.className = "text-[#00ff41] font-mono tracking-widest animate-pulse";
                stressLevel -= 15;
            } else if (delta > 0) {
                // Bad (Rank rose numerically)
                rankDelta.innerText = `▼ +${delta} PENALTY`;
                rankDelta.className = "text-[#ff003c] font-mono tracking-widest animate-pulse";
                stressLevel += 20;
            } else {
                rankDelta.innerText = "";
            }
            
            updateUI();
            setTimeout(() => rankDelta.innerText = "", 3000);
        }

        // --- GEMINI INTEGRATION ---

        const SYSTEM_PROMPT = `
        You are the "Kota HOD" (Head of Department). A cynical, elitist gatekeeper of JEE Ranks.
        TARGET EXAM: JEE MAIN 2026.
        
        **Objective:** Test user on Revised JEE Main 2026 Syllabus.
        **Rules:**
        1. Alternate between MCQ (4 options) and Numerical Value Questions.
        2. ADAPTIVE DIFFICULTY: If user answers CORRECTLY, drastically increase complexity (Rank Decider). If WRONG, mock them.
        3. NO JSON. Use the Custom Tag Protocol below for ALL responses.

        **PROTOCOL (STRICTLY FOLLOW THIS FORMAT):**
        
        <<VERDICT: CORRECT | INCORRECT | NEUTRAL>>
        <<RANK_DELTA: (integer, negative for improvement, positive for penalty)>>
        
        [Your Message Here in Markdown. Use LaTeX $...$ for math. Use **Bold** for emphasis. Structure with headers: Question, Options, Analysis.]
        `;

        async function startSession() {
            addLoader();
            try {
                const response = await callGemini("Initialize session. Demand a topic.");
                processResponse(response);
            } catch (e) {
                removeLoader();
                addMessage('system', "CONNECTION FAILED: " + e.message);
            }
        }

        async function callGemini(text) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const contents = chatHistory.map(m => ({ role: m.role, parts: [{ text: m.text }] }));
            contents.push({ role: 'user', parts: [{ text: text }] });

            const payload = {
                contents: contents,
                systemInstruction: { parts: [{ text: SYSTEM_PROMPT }] }
            };

            const req = await fetch(url, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });

            if (!req.ok) throw new Error('API Error');
            const data = await req.json();
            return data.candidates[0].content.parts[0].text;
        }

        function processResponse(rawText) {
            removeLoader();
            
            // Extract Metadata using Regex
            const verdictMatch = rawText.match(/<<VERDICT:\s*(.*?)>>/);
            const deltaMatch = rawText.match(/<<RANK_DELTA:\s*(.*?)>>/);
            
            const verdict = verdictMatch ? verdictMatch[1].trim() : 'NEUTRAL';
            const delta = deltaMatch ? parseInt(deltaMatch[1]) : 0;
            
            // Clean message for display (Remove tags)
            let cleanMessage = rawText.replace(/<<.*?>>/g, '').trim();
            
            // Logic
            if (verdict === 'CORRECT') {
                // Ensure delta is negative for improvement
                let d = delta > 0 ? -delta : delta; 
                if (d === 0) d = -500;
                handleDelta(d);
            } else if (verdict === 'INCORRECT') {
                // Ensure delta is positive for penalty
                let d = delta < 0 ? -delta : delta;
                if (d === 0) d = 2000;
                handleDelta(d);
            }
            
            addMessage('model', cleanMessage);
            chatHistory.push({ role: 'model', text: rawText });
        }

        async function handleInteraction(text) {
            addMessage('user', text);
            chatHistory.push({ role: 'user', text: text });
            addLoader();
            
            try {
                const res = await callGemini(text);
                processResponse(res);
            } catch (e) {
                removeLoader();
                addMessage('system', e.message);
            }
        }

        // --- UI HELPERS ---

        function addMessage(role, text) {
            const div = document.createElement('div');
            const isModel = role === 'model';
            div.className = `p-6 mb-4 max-w-3xl rounded-sm backdrop-blur-md relative ${
                isModel ? 'hod-message mr-auto text-gray-100' : 
                (role === 'system' ? 'bg-red-900/50 border border-red-500 text-center mx-auto' : 'user-message ml-auto text-[#00f3ff]')
            }`;

            if (role === 'system') {
                div.innerText = text;
            } else {
                div.innerHTML = marked.parse(text);
                renderMathInElement(div, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false}
                    ],
                    throwOnError: false
                });
            }
            chatContainer.appendChild(div);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function addLoader() {
            const div = document.createElement('div');
            div.id = 'loader';
            div.className = 'flex items-center space-x-2 text-[#ff003c] p-4 animate-pulse font-mono text-sm';
            div.innerHTML = `<span>HOD_PROCESSING</span><span class="text-xs">[///]</span>`;
            chatContainer.appendChild(div);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function removeLoader() {
            const el = document.getElementById('loader');
            if (el) el.remove();
        }

        // --- INPUTS ---
        function sendText() {
            const val = textInput.value.trim();
            if(val) { handleInteraction(val); textInput.value = ''; }
        }
        function sendOption(opt) { handleInteraction(`Option ${opt}`); }
        function sendNumeric() {
            const val = numInput.value.trim();
            if(val) { handleInteraction(val); numInput.value = ''; }
        }
        
        textInput.addEventListener('keypress', e => { if(e.key === 'Enter') sendText(); });
        numInput.addEventListener('keypress', e => { if(e.key === 'Enter') sendNumeric(); });

    </script>
</body>
</html>
