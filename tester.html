<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KOTA HOD: Rank Gatekeeper v2.4 (Adaptive)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Marked for Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- KaTeX for Math Rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Google Fonts: JetBrains Mono for numbers/code, Inter for readability -->
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #0a0a0a; /* Slightly lighter black for comfort */
            --terminal-green: #33ff00;
            --terminal-red: #ff3333;
        }

        body {
            background-color: var(--bg-color);
            color: #f3f4f6;
            font-family: 'Inter', sans-serif; /* Readable font for text */
            overflow: hidden;
            line-height: 1.6;
        }

        .font-mono {
            font-family: 'JetBrains Mono', monospace; /* Maintain numeric aesthetic */
        }

        /* --- CRT Effects (Subtler) --- */
        .scanlines {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                to bottom,
                rgba(255,255,255,0),
                rgba(255,255,255,0) 50%,
                rgba(0,0,0,0.05) 50%, /* Much lighter opacity */
                rgba(0,0,0,0.05)
            );
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 50;
        }
        
        .vignette {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(0,0,0,0) 70%, rgba(0,0,0,0.4) 100%); /* Softer vignette */
            pointer-events: none;
            z-index: 49;
        }

        /* --- Animations --- */
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }

        .shake-hard {
            animation: shake 0.4s;
            border: 2px solid rgba(239, 68, 68, 0.5);
        }

        @keyframes flash-green {
            0% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.4); }
            100% { box-shadow: 0 0 0 20px rgba(74, 222, 128, 0); }
        }

        .flash-success {
            animation: flash-green 0.8s;
            border: 1px solid rgba(74, 222, 128, 0.5);
        }

        /* --- Chat Styling --- */
        .hod-message {
            border-left: 4px solid #ef4444;
            background-color: #171717;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        .user-message {
            border-right: 4px solid #3b82f6;
            background-color: #1e293b;
            text-align: right;
            margin-left: auto;
        }

        /* Markdown Styles within Chat */
        .prose strong {
            color: #fff;
            font-weight: 700;
        }
        .prose ul {
            list-style-type: disc;
            padding-left: 1.5rem;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .prose li {
            margin-bottom: 0.25rem;
        }
        .prose p {
            margin-bottom: 0.75rem;
        }
        .prose p:last-child {
            margin-bottom: 0;
        }
        .prose blockquote {
            border-left: 3px solid #4b5563;
            padding-left: 1rem;
            color: #9ca3af;
            font-style: italic;
        }
        .prose code {
            background-color: #333;
            padding: 0.2rem 0.4rem;
            border-radius: 0.25rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9em;
        }

        /* Math Styling */
        .katex-display {
            margin: 1em 0;
            overflow-x: auto;
            overflow-y: hidden;
            padding: 0.5rem 0;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0a0a0a; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #444; }
    </style>
</head>
<body class="flex flex-col h-screen">

    <!-- Overlays -->
    <div class="scanlines"></div>
    <div class="vignette"></div>

    <!-- HUD / Status Bar -->
    <header class="bg-[#111] border-b border-gray-800 p-4 flex justify-between items-center z-10 shadow-md">
        <div class="flex items-center space-x-6">
            <div class="flex flex-col">
                <span class="text-[10px] text-gray-500 uppercase tracking-widest font-mono">Target Exam</span>
                <span class="text-red-500 font-bold tracking-wide text-sm md:text-base font-mono">JEE MAIN 2026</span>
            </div>
            <div class="h-8 w-px bg-gray-800"></div>
            <div class="flex flex-col">
                <span class="text-[10px] text-gray-500 uppercase tracking-widest font-mono">Current Rank (AIR)</span>
                <span id="rank-display" class="text-white font-bold text-xl tabular-nums font-mono">150,000</span>
            </div>
            <div id="rank-delta" class="text-sm font-bold opacity-0 transition-opacity duration-500 font-mono"></div>
        </div>
        
        <div class="flex items-center space-x-6">
             <div class="flex flex-col items-end">
                <span class="text-[10px] text-gray-500 uppercase tracking-widest font-mono">Streak</span>
                <div class="flex space-x-1" id="streak-container">
                    <span class="w-2 h-2 bg-gray-800 rounded-full"></span>
                    <span class="w-2 h-2 bg-gray-800 rounded-full"></span>
                    <span class="w-2 h-2 bg-gray-800 rounded-full"></span>
                </div>
            </div>
            <button id="settings-btn" class="p-2 text-gray-400 hover:text-white hover:bg-gray-800 rounded transition" title="Settings">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
            </button>
        </div>
    </header>

    <!-- Chat Area -->
    <main id="chat-container" class="flex-1 overflow-y-auto p-4 md:p-6 space-y-6 relative z-10 scroll-smooth">
        
        <!-- Empty State -->
        <div id="welcome-screen" class="absolute inset-0 flex flex-col items-center justify-center text-center p-6 z-0">
            <h1 class="text-5xl font-bold text-red-600 mb-2 tracking-tighter uppercase font-mono">Rank Gatekeeper</h1>
            <p class="text-gray-400 mb-8 max-w-md text-lg">
                14 Lakh aspirants. 10,000 Seats.<br>
                <span class="text-sm text-gray-600">The clock is already ticking for 2026.</span>
            </p>
            <button id="init-btn" class="px-8 py-3 bg-red-600 hover:bg-red-700 text-white font-bold rounded border-b-4 border-red-800 active:border-b-0 active:translate-y-1 transition-all uppercase tracking-widest text-sm font-mono shadow-lg">
                Start Session
            </button>
            <p class="text-xs text-gray-600 mt-6 font-mono">Ensure API Key is configured in settings</p>
        </div>

    </main>

    <!-- Controls -->
    <footer class="bg-[#111] border-t border-gray-800 p-4 pb-6 z-20">
        <div class="max-w-4xl mx-auto space-y-3">
            
            <!-- Quick Inputs -->
            <div class="grid grid-cols-6 gap-3">
                <button onclick="sendOption('A')" class="col-span-1 py-3 bg-gray-800 hover:bg-gray-700 border border-gray-700 hover:border-blue-500 text-blue-400 font-bold rounded transition transform active:scale-95 font-mono shadow-sm">A</button>
                <button onclick="sendOption('B')" class="col-span-1 py-3 bg-gray-800 hover:bg-gray-700 border border-gray-700 hover:border-blue-500 text-blue-400 font-bold rounded transition transform active:scale-95 font-mono shadow-sm">B</button>
                <button onclick="sendOption('C')" class="col-span-1 py-3 bg-gray-800 hover:bg-gray-700 border border-gray-700 hover:border-blue-500 text-blue-400 font-bold rounded transition transform active:scale-95 font-mono shadow-sm">C</button>
                <button onclick="sendOption('D')" class="col-span-1 py-3 bg-gray-800 hover:bg-gray-700 border border-gray-700 hover:border-blue-500 text-blue-400 font-bold rounded transition transform active:scale-95 font-mono shadow-sm">D</button>
                
                <div class="col-span-2 flex space-x-2">
                    <input type="number" id="num-input" placeholder="12.5" class="w-full bg-[#0a0a0a] border border-gray-700 text-white px-3 rounded focus:outline-none focus:border-red-500 text-center font-mono placeholder-gray-700">
                    <button onclick="sendNumeric()" class="px-4 bg-gray-800 border border-gray-700 text-green-500 hover:bg-gray-700 rounded transition transform active:scale-95 font-bold">↵</button>
                </div>
            </div>

            <!-- Main Input -->
            <div class="flex space-x-3">
                <div class="relative flex-1">
                    <input type="text" id="text-input" placeholder="Explain your logic or pick a topic..." class="w-full bg-[#0a0a0a] border border-gray-700 text-white p-3 rounded focus:outline-none focus:border-red-500 transition font-sans placeholder-gray-600 shadow-inner">
                </div>
                <button onclick="sendText()" class="px-6 bg-red-600 hover:bg-red-700 text-white font-bold rounded transition shadow-lg border-b-4 border-red-800 active:border-b-0 active:translate-y-1 font-mono uppercase text-sm">SEND</button>
            </div>
        </div>
    </footer>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black/90 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-[#111] border border-gray-800 p-8 rounded-lg max-w-md w-full shadow-2xl relative">
            <h3 class="text-xl font-bold text-white mb-6 tracking-wide font-mono uppercase border-b border-gray-800 pb-2">System Config</h3>
            
            <label class="block text-gray-400 text-xs uppercase tracking-widest mb-2 font-mono">Gemini API Key</label>
            <input type="password" id="api-key-input" class="w-full bg-black border border-gray-700 text-white p-3 rounded mb-6 focus:border-red-500 outline-none font-mono text-sm shadow-inner transition-colors">
            
            <div class="flex justify-end space-x-3">
                <button id="close-settings" class="px-4 py-2 text-gray-400 hover:text-white uppercase text-xs font-bold tracking-wider font-mono">Cancel</button>
                <button id="save-settings" class="px-6 py-2 bg-red-600 text-white rounded hover:bg-red-700 uppercase text-xs font-bold tracking-wider shadow-lg font-mono">Connect</button>
            </div>
        </div>
    </div>

    <script>
        /* --- GAMIFICATION LOGIC --- */
        let currentRank = 150000;
        let streak = 0;
        
        // --- PERSONA PROMPT REFINED FOR READABILITY & JSON ---
        const SYSTEM_INSTRUCTION = `
            You are the "Kota HOD" (Head of Department). A cynical, extremely elitist gatekeeper of the JEE Rank.
            
            **Objective:** Test the user on the **Revised JEE Main 2026 Syllabus**. Be extremely passive agressive, compare user to other students in his elitist kota coaching institute who have been studying there since 6th.
            
            **Syllabus Rules:**
            1. **Strict Adherence:** Stick to the reduced NTA syllabus for 2026.
            2. **Deleted Topics:** ABSOLUTELY NO questions on Potentiometer, Rolling Motion (pure dynamics), Doppler Effect, Transistors, Communication Systems, Tangent Galvanometer, Quality Factor, etc.
            3. **Focus:** Core concepts, Rank Decider problems, and tricky calculations.

            **Question Protocol (Adaptive Difficulty):**
            1. **Mix Formats:** Randomly alternate between **MCQ (Single Correct)** and **Numerical Value Type** (Integer/Decimal answer).
            2. **Ramp Up Complexity:** - Start with "Standard" JEE Main questions.
               - **If the user answers CORRECTLY:** Increase difficulty immediately. Introduce multi-concept problems (e.g., Electrostatics + SHM), tricky calculus, or trap options. Push them towards "Advanced" level concepts disguised as Main questions.
               - **If INCORRECT:** Drop level slightly to basics, then mock them for not knowing fundamentals.
            3. **Numerical Questions:** These should be calculation-intensive or require precise conceptual application.
            
            **Formatting Rules (IMPORTANT for Readability):**
            Format the 'message' field in your JSON response using clear Markdown:
            - Use bold headers: **Question**, **Type** (MCQ/Numerical), **Options** (if MCQ), **Verdict**, **Analysis**.
            - Use bullet points for options.
            - Use LaTeX for all math formulas ($...$ for inline, $$...$$ for block).
            - Keep the "Question" distinct from the "Options".
            
            **CRITICAL OUTPUT RULE:**
            You MUST output your response in valid JSON format ONLY.
            Structure:
            {
                "verdict": "CORRECT" | "INCORRECT" | "NEUTRAL", 
                "rank_delta": (integer), // Use negative (-) for improvement, positive (+) for penalty
                "message": "(Markdown string)"
            }

            **Behavioral Guidelines:**
            1. **Neutral (Start/Topic Selection):** Ask for a chapter. Warn them 2026 is closer than they think.
            2. **Correct Answer:** "Adequate." Unimpressed. Small rank improvement. Next question immediately.
            3. **Incorrect Answer:** Brutal. "Wrong." Big rank penalty. Explain the specific trap they fell into. Next question.
            4. **Question Style:** Rank Deciders. Combining concepts.
        `;

        // --- STATE & API ---
        let apiKey = localStorage.getItem('gemini_api_key') || '';
        let chatHistory = []; 
        
        const chatContainer = document.getElementById('chat-container');
        const welcomeScreen = document.getElementById('welcome-screen');
        const textInput = document.getElementById('text-input');
        const numInput = document.getElementById('num-input');
        const settingsModal = document.getElementById('settings-modal');
        const apiKeyInput = document.getElementById('api-key-input');
        const rankDisplay = document.getElementById('rank-display');
        const rankDelta = document.getElementById('rank-delta');
        const streakContainer = document.getElementById('streak-container');

        // --- INIT ---
        apiKeyInput.value = apiKey;
        updateRankDisplay(0);
        updateStreakDisplay();

        // --- EVENTS ---
        document.getElementById('settings-btn').addEventListener('click', () => settingsModal.classList.remove('hidden'));
        document.getElementById('close-settings').addEventListener('click', () => settingsModal.classList.add('hidden'));
        document.getElementById('save-settings').addEventListener('click', () => {
            apiKey = apiKeyInput.value.trim();
            localStorage.setItem('gemini_api_key', apiKey);
            settingsModal.classList.add('hidden');
            if(apiKey) alert('System Connected.');
        });
        document.getElementById('init-btn').addEventListener('click', () => {
            if (!apiKey) return alert('ACCESS DENIED: API Key Missing');
            welcomeScreen.classList.add('hidden');
            startSession();
        });

        // --- GAMIFICATION FUNCTIONS ---
        function updateRankDisplay(delta) {
            currentRank += delta;
            if (currentRank < 1) currentRank = 1; 
            if (currentRank > 1500000) currentRank = 1500000; 

            rankDisplay.innerText = currentRank.toLocaleString();

            if (delta !== 0) {
                // In JEE, Negative delta = Green (Good), Positive delta = Red (Bad)
                const isImprovement = delta < 0;
                
                // Show delta with correct sign and color
                // If delta is -500 (improved), show "-500" in green
                // If delta is +2000 (worse), show "+2000" in red
                rankDelta.innerText = delta > 0 ? `▼ +${delta.toLocaleString()}` : `▲ ${delta.toLocaleString()}`;
                rankDelta.className = `text-xs font-bold transition-opacity duration-1000 ${isImprovement ? 'text-green-500' : 'text-red-500'} opacity-100 font-mono`;
                
                setTimeout(() => {
                    rankDelta.classList.remove('opacity-100');
                    rankDelta.classList.add('opacity-0');
                }, 2000);
            }
            
            if (delta > 0) {
                // Rank got numerically larger (Worse) -> BAD
                document.body.classList.add('shake-hard');
                setTimeout(() => document.body.classList.remove('shake-hard'), 400);
            } else if (delta < 0) {
                // Rank got numerically smaller (Better) -> GOOD
                chatContainer.classList.add('flash-success');
                setTimeout(() => chatContainer.classList.remove('flash-success'), 800);
            }
        }

        function updateStreak(isCorrect) {
            if (isCorrect) streak++;
            else streak = 0;
            updateStreakDisplay();
        }

        function updateStreakDisplay() {
            streakContainer.innerHTML = '';
            for (let i = 0; i < 5; i++) {
                const dot = document.createElement('span');
                dot.className = `w-2 h-2 rounded-full ${i < streak ? 'bg-green-500 shadow-[0_0_8px_#4ade80]' : 'bg-gray-800'}`;
                streakContainer.appendChild(dot);
            }
            if (streak > 5) {
                const extra = document.createElement('span');
                extra.className = 'text-xs text-green-500 font-bold ml-1 font-mono';
                extra.innerText = `+${streak-5}`;
                streakContainer.appendChild(extra);
            }
        }

        // --- GEMINI LOGIC ---
        async function startSession() {
            addLoadingIndicator();
            try {
                const response = await callGemini("Initialize session. Demand a topic.");
                processResponse(response);
            } catch (error) {
                removeLoadingIndicator();
                addMessage('system', 'Connection Failure: ' + error.message);
            }
        }

        async function callGemini(userText) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const contents = chatHistory.map(msg => ({
                role: msg.role === 'model' ? 'model' : 'user',
                parts: [{ text: msg.text }]
            }));
            
            contents.push({ role: 'user', parts: [{ text: userText }] });

            const payload = {
                contents: contents,
                systemInstruction: { parts: [{ text: SYSTEM_INSTRUCTION }] },
                generationConfig: { responseMimeType: "application/json" }
            };

            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) throw new Error('API Error');
            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        }

        function processResponse(jsonString) {
            removeLoadingIndicator();
            try {
                // CLEAN UP: Remove code blocks if present
                let cleanJson = jsonString.trim();
                cleanJson = cleanJson.replace(/^```json\s*/, '').replace(/^```\s*/, '').replace(/\s*```$/, '');
                
                const data = JSON.parse(cleanJson);
                
                if (data.verdict === 'CORRECT') {
                    // Force delta to be negative for CORRECT answers (Improvement towards AIR 1)
                    let delta = Math.abs(data.rank_delta) * -1;
                    if (delta === 0) delta = -100; // Fallback
                    
                    updateRankDisplay(delta); 
                    updateStreak(true);
                } else if (data.verdict === 'INCORRECT') {
                    // Force delta to be positive for INCORRECT answers (Worsening towards AIR 15L)
                    let delta = Math.abs(data.rank_delta);
                    if (delta === 0) delta = 5000; // Fallback

                    updateRankDisplay(delta);
                    updateStreak(false);
                } else {
                    updateRankDisplay(0);
                }

                addMessage('model', data.message);
                chatHistory.push({ role: 'model', text: JSON.stringify(data) });

            } catch (e) {
                console.error("JSON Parse Error", e);
                // Fallback: try to find valid JSON inside the string
                try {
                    const startIndex = jsonString.indexOf('{');
                    const endIndex = jsonString.lastIndexOf('}');
                    if(startIndex !== -1 && endIndex !== -1) {
                         const clean = jsonString.substring(startIndex, endIndex + 1);
                         const data = JSON.parse(clean);
                         // Recurse manually with safe logic
                         if (data.verdict === 'CORRECT') { 
                            let delta = Math.abs(data.rank_delta) * -1;
                            updateRankDisplay(delta); 
                            updateStreak(true); 
                         } else if (data.verdict === 'INCORRECT') { 
                            let delta = Math.abs(data.rank_delta);
                            updateRankDisplay(delta); 
                            updateStreak(false); 
                         } else { 
                            updateRankDisplay(0); 
                         }
                         addMessage('model', data.message);
                         chatHistory.push({ role: 'model', text: JSON.stringify(data) });
                         return;
                    }
                } catch(e2) {
                    // Ignore, fallback to raw
                }
                
                // Absolute fallback
                addMessage('model', jsonString);
                chatHistory.push({ role: 'model', text: jsonString });
            }
        }

        async function handleInteraction(userText) {
            addMessage('user', userText);
            chatHistory.push({ role: 'user', text: userText });
            
            addLoadingIndicator();
            try {
                const response = await callGemini(userText);
                processResponse(response);
            } catch (error) {
                removeLoadingIndicator();
                addMessage('system', error.message);
            }
        }

        // --- UI HELPERS ---
        function addMessage(role, text) {
            const div = document.createElement('div');
            // Enhanced message styling for readability
            div.className = `p-5 rounded-lg mb-6 max-w-3xl text-[15px] md:text-base leading-relaxed prose prose-invert ${
                role === 'model' ? 'hod-message mr-auto text-gray-200' : 
                (role === 'system' ? 'bg-red-900/20 border border-red-500 text-red-400 text-center mx-auto w-full' : 'user-message text-blue-100')
            }`;
            
            if (role === 'system') {
                div.innerHTML = `<span class="font-bold font-mono">SYSTEM:</span> ${text}`;
            } else {
                const rawHtml = marked.parse(text);
                div.innerHTML = rawHtml;
                renderMathInElement(div, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false},
                        {left: '\\(', right: '\\)', display: false},
                        {left: '\\[', right: '\\]', display: true}
                    ],
                    throwOnError: false
                });
            }
            chatContainer.appendChild(div);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function addLoadingIndicator() {
            const div = document.createElement('div');
            div.id = 'loading-indicator';
            div.className = 'flex items-center space-x-2 p-4 text-red-500 font-mono text-xs';
            div.innerHTML = `
                <span class="animate-pulse">EVALUATING</span>
                <div class="flex space-x-1">
                    <span class="w-1.5 h-1.5 bg-red-500 rounded-full typing-dot"></span>
                    <span class="w-1.5 h-1.5 bg-red-500 rounded-full typing-dot"></span>
                    <span class="w-1.5 h-1.5 bg-red-500 rounded-full typing-dot"></span>
                </div>
            `;
            chatContainer.appendChild(div);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function removeLoadingIndicator() {
            const loader = document.getElementById('loading-indicator');
            if (loader) loader.remove();
        }

        // --- INPUT HANDLERS ---
        function sendText() {
            const val = textInput.value.trim();
            if (val) {
                handleInteraction(val);
                textInput.value = '';
            }
        }
        function sendOption(opt) { handleInteraction(`Option ${opt}`); }
        function sendNumeric() {
            const val = numInput.value.trim();
            if (val) {
                handleInteraction(val);
                numInput.value = '';
            }
        }
        
        textInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendText(); });
        numInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendNumeric(); });

        // Animation for typing dots
        const style = document.createElement('style');
        style.innerHTML = `
            .typing-dot { animation: blink 1.4s infinite both; }
            .typing-dot:nth-child(2) { animation-delay: 0.2s; }
            .typing-dot:nth-child(3) { animation-delay: 0.4s; }
            @keyframes blink { 0% { opacity: 0.2; } 20% { opacity: 1; } 100% { opacity: 0.2; } }
        `;
        document.head.appendChild(style);

    </script>
</body>
</html>