<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HOD GATEKEEPER - JEE MAIN</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Marked for Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- KaTeX for Math Rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        :root { --bg-color: #050505; }
        body { background-color: var(--bg-color); color: #f3f4f6; font-family: 'Inter', sans-serif; overflow: hidden; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }

        /* CRT Scanline Effect */
        .scanlines {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.02) 50%, rgba(0,0,0,0.02));
            background-size: 100% 4px; pointer-events: none; z-index: 50;
        }

        /* Message Styling */
        .hod-message { border-left: 3px solid #ef4444; background-color: #111; }
        .user-message { border-right: 3px solid #3b82f6; background-color: #1e293b; text-align: right; margin-left: auto; }

        /* Question Card */
        .question-card {
            background: #0f172a; border: 1px solid #1e293b; border-radius: 12px;
            overflow: hidden; margin-top: 1rem; box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }
        
        /* Option Buttons */
        .option-btn {
            text-align: left; transition: all 0.2s; position: relative; overflow: hidden;
            border: 1px solid #374151; background: #1a2336;
        }
        .option-btn:hover:not(:disabled) { background-color: #1e293b; border-color: #3b82f6; transform: translateX(4px); }
        .option-btn:disabled { opacity: 0.6; cursor: not-allowed; filter: grayscale(0.8); }
        
        .option-key {
            font-family: 'JetBrains Mono', monospace; background: rgba(255,255,255,0.05);
            width: 28px; height: 28px; display: inline-flex; align-items: center; justify-content: center;
            border-radius: 4px; margin-right: 12px; font-size: 12px; font-weight: bold; flex-shrink: 0;
        }

        /* Markdown & Math Tweaks */
        .prose p { margin-bottom: 0.5rem; }
        .katex-display { overflow-x: auto; padding: 0.5rem 0; margin: 0.5rem 0; }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #050505; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }

        /* Loading Dots */
        .dot-flashing {
            position: relative; width: 6px; height: 6px; border-radius: 5px;
            background-color: #ef4444; color: #ef4444; animation: dot-flashing 1s infinite linear alternate;
            animation-delay: 0.5s;
        }
        .dot-flashing::before, .dot-flashing::after {
            content: ""; display: inline-block; position: absolute; top: 0;
            width: 6px; height: 6px; border-radius: 5px; background-color: #ef4444; color: #ef4444;
            animation: dot-flashing 1s infinite alternate;
        }
        .dot-flashing::before { left: -10px; animation-delay: 0s; }
        .dot-flashing::after { left: 10px; animation-delay: 1s; }
        @keyframes dot-flashing { 0% { background-color: #ef4444; } 50%, 100% { background-color: #330000; } }
    </style>
</head>
<body class="flex flex-col h-screen">

    <div class="scanlines"></div>

    <!-- Header -->
    <header class="bg-[#0a0a0a] border-b border-gray-800 p-4 flex justify-between items-center z-10">
        <div class="flex items-center space-x-6">
            <div class="flex flex-col">
                <span class="text-[10px] text-gray-500 uppercase tracking-widest font-mono">Exam</span>
                <span class="text-red-500 font-bold tracking-wide text-sm font-mono">JEE MAIN 2026</span>
            </div>
            <div class="h-8 w-px bg-gray-800"></div>
            <div class="flex flex-col">
                <span class="text-[10px] text-gray-500 uppercase tracking-widest font-mono">AIR Rank</span>
                <div class="flex items-baseline gap-2">
                    <span id="rank-display" class="text-white font-bold text-xl tabular-nums font-mono">150,000</span>
                    <span id="rank-delta" class="text-xs font-bold font-mono opacity-0 transition-opacity duration-500"></span>
                </div>
            </div>
        </div>
        
        <button id="settings-btn" class="p-2 text-gray-400 hover:text-white transition">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
        </button>
    </header>

    <!-- Chat Area -->
    <main id="chat-container" class="flex-1 overflow-y-auto p-4 md:p-6 space-y-6 relative z-10 scroll-smooth pb-24">
        <!-- Welcome Screen -->
        <div id="welcome-screen" class="absolute inset-0 flex flex-col items-center justify-center text-center p-6 z-0">
            <h1 class="text-5xl md:text-6xl font-black text-red-600 mb-2 tracking-tighter uppercase font-mono">HOD<br><span class="text-white text-2xl md:text-3xl tracking-widest">GATEKEEPER</span></h1>
            <p class="text-gray-500 mb-8 max-w-md font-mono text-sm">> TARGET: 99.9%ILE</p>
            <button id="init-btn" class="px-8 py-3 bg-red-600 hover:bg-red-700 text-white font-bold rounded border-b-4 border-red-800 active:border-b-0 active:translate-y-1 transition-all uppercase tracking-widest text-sm font-mono shadow-[0_0_20px_rgba(220,38,38,0.5)]">
                Enter Cabin
            </button>
        </div>
    </main>

    <!-- Controls -->
    <footer class="bg-[#0a0a0a] border-t border-gray-800 p-4 z-20">
        <div class="max-w-4xl mx-auto flex space-x-3">
            <div class="relative flex-1">
                <input type="text" id="text-input" placeholder="Type answer or chat..." class="w-full bg-[#111] border border-gray-700 text-white p-3 rounded-lg focus:outline-none focus:border-red-500 transition font-sans placeholder-gray-600 font-medium">
            </div>
            <button onclick="sendText()" class="px-6 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg transition shadow-lg border-b-4 border-red-800 active:border-b-0 active:translate-y-1 font-mono uppercase text-sm">SEND</button>
        </div>
    </footer>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black/90 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-[#111] border border-gray-800 p-8 rounded-xl max-w-md w-full shadow-2xl relative">
            <h3 class="text-xl font-bold text-white mb-6 tracking-wide font-mono uppercase border-b border-gray-800 pb-2">System Config</h3>
            <label class="block text-gray-500 text-xs uppercase tracking-widest mb-2 font-mono">Gemini API Key</label>
            <input type="password" id="api-key-input" class="w-full bg-black border border-gray-700 text-white p-3 rounded mb-6 focus:border-red-500 outline-none font-mono text-sm shadow-inner">
            <div class="flex justify-end space-x-3">
                <button id="close-settings" class="px-4 py-2 text-gray-400 hover:text-white uppercase text-xs font-bold tracking-wider font-mono">Cancel</button>
                <button id="save-settings" class="px-6 py-2 bg-red-600 text-white rounded hover:bg-red-700 uppercase text-xs font-bold tracking-wider shadow-lg font-mono">Connect</button>
            </div>
        </div>
    </div>

    <script>
        /* --- STATE --- */
        let currentRank = 150000;
        let apiKey = localStorage.getItem('gemini_api_key') || '';
        let chatHistory = []; 

        /* --- PROMPT --- */
        const SYSTEM_INSTRUCTION = `
            You are the "Kota HOD" (Head of Department) for JEE Main Physics/Maths/Chemistry.
            **Persona:** Cynical, brutal, elitist. You believe only the top 0.1% matter. You roast students who give wrong answers or ask stupid questions.
            
            **INSTRUCTIONS:**
            1. Respond naturally in Markdown to the user. Explain concepts if they ask, or roast them if they are wrong.
            2. IF AND ONLY IF you want to update the rank or pose a new question, you must append a special hidden data block at the very end of your response.
            3. Do NOT output raw JSON by itself. Always start with text commentary.
            4. Keep mind of JEE Syllabus, if user claims something is out of syllabus, apologise and move on to next question.
            5. Answer of numerical type should be integral (0-999)
            6. ALTERNATE BETWEEN MCQ AND NUMERICAL (IMPORTANT)
            
            **DATA BLOCK FORMAT:**
            At the end of your response, wrap the game data in <DATA> tags.
            
            <DATA>
            {
              "rank_delta": (integer, negative for good, positive for bad),
              "quiz_data": { 
                  "question_text": "Markdown/LaTeX Question string",
                  "type": "MCQ" | "NUMERICAL",
                  "options": ["A) ...", "B) ..."] (Optional for Numerical)
              }
            }
            </DATA>

            **IMPORTANT LATEX RULE:**
            Inside the <DATA> JSON block, you MUST double-escape backslashes. 
            Example: Write "\\\\frac{1}{2}" instead of "\\frac{1}{2}".
            In the main text commentary, normal LaTeX (single backslash) is fine.
            
            **EXAMPLE RESPONSE:**
            You absolute buffoon. That formula is for kinematics, not dynamics.
            <DATA>
            {
              "rank_delta": 500,
              "quiz_data": {
                "question_text": "Calculate the work done by a variable force $F=3x^2$ from $x=0$ to $x=2$.",
                "type": "NUMERICAL"
              }
            }
            </DATA>
        `;

        /* --- DOM ELEMENTS --- */
        const chatContainer = document.getElementById('chat-container');
        const welcomeScreen = document.getElementById('welcome-screen');
        const textInput = document.getElementById('text-input');
        const settingsModal = document.getElementById('settings-modal');
        const apiKeyInput = document.getElementById('api-key-input');
        const rankDisplay = document.getElementById('rank-display');
        const rankDelta = document.getElementById('rank-delta');

        /* --- INIT --- */
        apiKeyInput.value = apiKey;
        updateRankDisplay(0);

        /* --- EVENTS --- */
        document.getElementById('settings-btn').addEventListener('click', () => settingsModal.classList.remove('hidden'));
        document.getElementById('close-settings').addEventListener('click', () => settingsModal.classList.add('hidden'));
        document.getElementById('save-settings').addEventListener('click', () => {
            apiKey = apiKeyInput.value.trim();
            localStorage.setItem('gemini_api_key', apiKey);
            settingsModal.classList.add('hidden');
            if(apiKey) alert('System Connected.');
        });
        document.getElementById('init-btn').addEventListener('click', () => {
            if (!apiKey) return alert('ACCESS DENIED: API Key Missing');
            welcomeScreen.classList.add('hidden');
            startSession();
        });

        /* --- LOGIC --- */
        function updateRankDisplay(delta) {
            currentRank += delta;
            if (currentRank < 1) currentRank = 1;
            if (currentRank > 1500000) currentRank = 1500000;
            rankDisplay.innerText = currentRank.toLocaleString();

            if (delta !== 0) {
                const isGood = delta < 0;
                rankDelta.innerText = delta > 0 ? `▼ +${delta}` : `▲ ${delta}`;
                rankDelta.className = `text-xs font-bold font-mono transition-opacity duration-1000 ${isGood ? 'text-green-500' : 'text-red-500'} opacity-100`;
                setTimeout(() => rankDelta.classList.replace('opacity-100', 'opacity-0'), 2000);
            }
        }

        /* --- HYBRID PARSER --- */
        function processHybridResponse(fullText) {
            // 1. Separate Visible Text from Hidden Data
            const dataRegex = /<DATA>([\s\S]*?)<\/DATA>/;
            const match = fullText.match(dataRegex);

            let visibleText = fullText;
            let hiddenData = null;

            if (match) {
                visibleText = fullText.replace(match[0], '').trim();
                const jsonString = match[1];
                try {
                    // Attempt to clean basic JSON issues before parsing
                    const cleanedJson = jsonString.replace(/\\(?![/u"bfnrt\\])/g, "\\\\");
                    hiddenData = JSON.parse(cleanedJson);
                } catch (e) {
                    console.error("Data Parse Failed:", e);
                }
            }

            // 2. Render Text
            if (visibleText) {
                addMessage('model', visibleText);
            }

            // 3. Process Data (if valid)
            if (hiddenData) {
                if (hiddenData.rank_delta) updateRankDisplay(hiddenData.rank_delta);
                if (hiddenData.quiz_data) addQuestionCard(hiddenData.quiz_data);
            }

            // 4. Save to history (we save the full raw text so the model has context of its own data)
            chatHistory.push({ role: 'model', text: fullText });
        }

        /* --- API INTERACTION --- */
        async function startSession() {
            addLoadingIndicator();
            try {
                // We send this initial prompt, but we handle history carefully in callGemini
                const response = await callGemini("Initialize session. Give me a hard question immediately.");
                processHybridResponse(response);
            } catch (error) {
                removeLoadingIndicator();
                addSystemMessage('Connection Failure: ' + error.message);
            }
        }

        async function callGemini(userText) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            // Build contents from history
            const contents = chatHistory.map(msg => ({
                role: msg.role === 'model' ? 'model' : 'user',
                parts: [{ text: msg.text }]
            }));

            // FIX: Only append userText if it is NOT already the last message in chatHistory
            // This handles two cases:
            // 1. startSession (history is empty, we must send "Initialize...") -> Appends
            // 2. handleInteraction (history already has "4", userText is "4") -> Skips append (prevents "44" bug)
            const lastMsg = chatHistory.length > 0 ? chatHistory[chatHistory.length - 1] : null;
            if (userText && (!lastMsg || lastMsg.text !== userText)) {
                contents.push({ role: 'user', parts: [{ text: userText }] });
            }

            const payload = {
                contents: contents,
                systemInstruction: { parts: [{ text: SYSTEM_INSTRUCTION }] }
            };

            let attempts = 0;
            const maxAttempts = 3;
            let delay = 2000;

            while (attempts < maxAttempts) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429) {
                        attempts++;
                        await new Promise(r => setTimeout(r, delay));
                        delay *= 2;
                        continue;
                    }

                    if (!response.ok) throw new Error(`API Error: ${response.status}`);
                    
                    const data = await response.json();
                    if (!data.candidates || !data.candidates[0].content) throw new Error("Empty response from AI");
                    
                    return data.candidates[0].content.parts[0].text;

                } catch (error) {
                    if (attempts >= maxAttempts - 1) throw error;
                    attempts++;
                    await new Promise(r => setTimeout(r, delay));
                }
            }
        }

        async function handleInteraction(userText) {
            addMessage('user', userText);
            // We add to history immediately for UI/State consistency
            chatHistory.push({ role: 'user', text: userText });
            addLoadingIndicator();
            
            try {
                // Pass userText, but callGemini will smartly decide whether to append it to payload
                const response = await callGemini(userText);
                processHybridResponse(response);
            } catch (error) {
                removeLoadingIndicator();
                addSystemMessage(error.message);
            }
        }

        /* --- RENDERING --- */
        function renderMarkdown(element, text) {
            if(!text) return;
            // Parse Markdown
            element.innerHTML = marked.parse(text);
            
            // Parse Math (KaTeX)
            renderMathInElement(element, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false},
                    {left: '\\(', right: '\\)', display: false},
                    {left: '\\[', right: '\\]', display: true}
                ],
                throwOnError: false,
                output: 'html', 
                strict: false
            });
        }

        function addMessage(role, text) {
            removeLoadingIndicator();
            
            const div = document.createElement('div');
            div.className = `p-4 rounded-lg mb-4 max-w-3xl text-sm md:text-base leading-relaxed animate-in fade-in slide-in-from-bottom-2 duration-300 ${
                role === 'model' ? 'hod-message mr-auto text-gray-200 shadow-md' : 'user-message text-blue-100 shadow-sm'
            }`;
            renderMarkdown(div, text);
            chatContainer.appendChild(div);
            scrollToBottom();
        }

        function addQuestionCard(quizData) {
            const card = document.createElement('div');
            card.className = 'question-card mb-6 animate-in fade-in zoom-in-95 duration-500';

            // Question Text
            const qText = document.createElement('div');
            qText.className = 'p-5 border-b border-gray-800 bg-[#151d2e]';
            qText.innerHTML = `<span class="text-xs text-blue-400 font-bold font-mono block mb-2 tracking-widest">RANK DECIDER // ${quizData.type}</span>`;
            const contentDiv = document.createElement('div');
            renderMarkdown(contentDiv, quizData.question_text);
            qText.appendChild(contentDiv);
            card.appendChild(qText);

            // Actions Area
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'p-4 bg-[#0f172a]';

            if (quizData.type === 'MCQ' && quizData.options && Array.isArray(quizData.options)) {
                const grid = document.createElement('div');
                grid.className = 'grid grid-cols-1 gap-2';
                
                quizData.options.forEach((opt, idx) => {
                    const btn = document.createElement('button');
                    btn.className = 'option-btn w-full p-3 rounded-lg flex items-center group';
                    const letter = String.fromCharCode(65 + idx);
                    
                    const keySpan = document.createElement('span');
                    keySpan.className = 'option-key group-hover:bg-blue-600 group-hover:text-white transition-colors';
                    keySpan.innerText = letter;

                    const textSpan = document.createElement('span');
                    textSpan.className = 'flex-1';
                    // Render markdown/math inside button
                    renderMarkdown(textSpan, opt);
                    
                    // Cleanup P tags inside buttons
                    const p = textSpan.querySelector('p');
                    if(p) textSpan.innerHTML = p.innerHTML;

                    btn.appendChild(keySpan);
                    btn.appendChild(textSpan);
                    
                    btn.onclick = function() {
                        const allBtns = grid.querySelectorAll('button');
                        allBtns.forEach(b => b.disabled = true);
                        btn.style.borderColor = '#3b82f6';
                        btn.style.backgroundColor = '#1e3a8a';
                        handleInteraction(`I choose Option ${letter}`);
                    };
                    grid.appendChild(btn);
                });
                actionsDiv.appendChild(grid);
            } else {
                // Numerical Input
                actionsDiv.innerHTML = `
                    <div class="flex-1 text-gray-500 italic text-sm flex items-center justify-center border border-dashed border-gray-700 rounded p-4 bg-[#0a0a0a]">
                        Type your numerical answer in the chat box below...
                    </div>
                `;
            }
            
            card.appendChild(actionsDiv);
            chatContainer.appendChild(card);
            scrollToBottom();
        }

        function addSystemMessage(text) {
            const div = document.createElement('div');
            div.className = 'bg-red-900/20 border border-red-500/50 text-red-400 text-center mx-auto w-full max-w-lg p-2 rounded mb-4 text-xs font-mono';
            div.innerHTML = `[SYSTEM] ${text}`;
            chatContainer.appendChild(div);
            scrollToBottom();
        }

        function addLoadingIndicator() {
            if(document.getElementById('loading-indicator')) return;
            
            const div = document.createElement('div');
            div.id = 'loading-indicator';
            div.className = 'flex items-center space-x-2 p-4 text-red-500 font-mono text-xs ml-2';
            div.innerHTML = `<span>EVALUATING</span><div class="dot-flashing ml-3"></div>`;
            chatContainer.appendChild(div);
            scrollToBottom();
        }

        function removeLoadingIndicator() {
            const loader = document.getElementById('loading-indicator');
            if (loader) loader.remove();
        }

        function scrollToBottom() {
            setTimeout(() => { chatContainer.scrollTop = chatContainer.scrollHeight; }, 50);
        }

        /* --- INPUT --- */
        function sendText() {
            const val = textInput.value.trim();
            if (val) {
                textInput.value = '';
                handleInteraction(val);
            }
        }
        textInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendText(); });

    </script>
</body>
</html>
