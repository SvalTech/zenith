<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zenith | SvalTech</title>
    <meta name="description" content="A group study timer web app.">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        gray: { 50: '#f7f7f8', 100: '#e3e3e6', 200: '#c8c8d0', 300: '#a4a4b2', 400: '#7f7f98', 500: '#5f5f7a', 600: '#48485d', 700: '#333345', 800: '#262635', 900: '#1a1a24', 950: '#111117' },
                        indigo: { 300: '#a5b4fc', 400: '#818cf8', 500: '#6366f1', 600: '#4f46e5' },
                        purple: { 400: '#c084fc', 500: '#a855f7', 600: '#9333ea' },
                        teal: { 300: '#5eead4', 400: '#2dd4bf' }
                    },
                    keyframes: {
                        'fade-in-up': { '0%': { opacity: '0', transform: 'translateY(20px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        'pulse-glow': { '0%, 100%': { boxShadow: '0 0 0 0 rgba(99, 102, 241, 0.7)' }, '50%': { boxShadow: '0 0 0 8px rgba(99, 102, 241, 0)' } },
                        'slide-in-bottom': { '0%': { transform: 'translateY(100%)' }, '100%': { transform: 'translateY(0)' } },
                    },
                    animation: {
                        'fade-in-up': 'fade-in-up 0.5s ease-out forwards',
                        'pulse-glow': 'pulse-glow 2s infinite',
                        'slide-in-bottom': 'slide-in-bottom 0.3s ease-out forwards',
                    },
                }
            }
        }
    </script>
    <style id="custom-styles">
        body { font-family: 'Inter', sans-serif; background-color: #111117; color: #e3e3e6; overflow-x: hidden; }
        body::before { content: ''; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-image: radial-gradient(circle at 10% 10%, #4f46e520 0%, transparent 30%), radial-gradient(circle at 90% 80%, #a855f720 0%, transparent 30%); z-index: -1; pointer-events: none; }
        .card { background-color: rgba(26, 26, 36, 0.6); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border: 1px solid rgba(51, 51, 69, 0.5); border-radius: 1.5rem; transition: all 0.3s ease; }
        .card:hover:not(.no-hover) { border-color: rgba(79, 70, 229, 0.5); transform: translateY(-4px); box-shadow: 0 8px 30px rgba(0,0,0,0.2); }
        .form-input, .form-select { background-color: #1a1a24; border: 1px solid #333345; border-radius: 0.75rem; color: #e3e3e6; padding: 1rem; width: 100%; font-size: 1rem; transition: border-color .2s, box-shadow .2s; }
        .form-input::placeholder { color: #5f5f7a; }
        .form-input:focus, .form-select:focus { outline: 0; border-color: #6366f1; box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3); }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; font-weight: 600; border-radius: 0.75rem; padding: 0.875rem 1.25rem; transition: all .25s ease; border: 1px solid transparent; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn:not(:disabled) { cursor: pointer; }
        .btn:not(:disabled):hover { transform: translateY(-3px) scale(1.02); box-shadow: 0 4px 15px rgba(0, 0, 0, .4); }
        .btn:not(:disabled):active { transform: translateY(-1px) scale(0.98); }
        .btn-primary { background-image: linear-gradient(to right, #6366f1, #a855f7); background-size: 200% auto; color: #ffffff; border: none; }
        .btn-primary:not(:disabled):hover { background-position: right center; }
        .gradient-text { background: linear-gradient(to right, #a855f7, #6366f1); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .member-card { transition: all .3s ease; border-width: 2px; border-color: #33334580; }
        .member-card.is-studying { border-color: #6366f1; box-shadow: 0 0 25px rgba(99, 102, 241, 0.25); background-color: rgba(38, 38, 53, 0.8); }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; }
        .status-dot.studying { background-color: #6366f1; animation: pulse-glow 1.5s infinite; }
        .status-dot.idle { background-color: #22c55e; }
        .status-dot.offline { background-color: #5f5f7a; }
        .spinner { width: 32px; height: 32px; border: 4px solid #333345; border-left-color: #6366f1; border-radius: 50%; animation: rotation 0.8s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg) } 100% { transform: rotate(360deg) } }
        .modal-overlay { position: fixed; inset: 0; background-color: rgba(0, 0, 0, .7); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); display: flex; align-items: center; justify-content: center; z-index: 50; opacity: 0; transition: opacity .3s; pointer-events: none; }
        .modal-overlay:not(.hidden) { opacity: 1; pointer-events: auto; }
        .modal-overlay > .modal-card { transform: scale(.95) translateY(10px); opacity: 0; transition: transform .3s ease, opacity .3s ease; width: 90%; max-width: 28rem; background-color: rgba(26, 26, 36, 0.8); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px); border: 1px solid #333345; border-radius: 1.5rem; padding: 2rem; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .modal-overlay:not(.hidden) > .modal-card { transform: scale(1) translateY(0); opacity: 1; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        /* Mobile Nav */
        .mobile-nav-btn { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 0.5rem 0; color: #7f7f98; transition: all .2s ease; }
        .mobile-nav-btn.active { color: #6366f1; }
        .mobile-nav-btn.active .nav-icon { transform: scale(1.1); }
        .mobile-nav-btn .nav-text { font-size: 0.75rem; font-weight: 600; margin-top: 2px; }
        /* Tab buttons */
        .tab-btn { padding: 0.5rem 1rem; font-weight: 600; color: #a4a4b2; border-radius: 0.75rem; transition: all .2s ease; }
        .tab-btn.active { background-color: #6366f1; color: white; }
    </style>
</head>
<body class="antialiased pb-24 lg:pb-0">
    
    <header class="container mx-auto px-4 py-5 max-w-7xl">
        <div class="flex justify-between items-center">
            <h1 class="text-3xl sm:text-4xl font-black gradient-text">Zenith</h1>
            <div class="flex items-center gap-2 sm:gap-4">
                <span id="sync-status" class="text-xs text-gray-500 opacity-0 transition-opacity"></span>
                <div id="streak-container" class="hidden items-center gap-1 font-bold text-orange-400" title="Your current study streak!">
                    ðŸ”¥
                    <span id="streak-count">0</span>
                </div>
                <div id="admin-btn-container"></div>
                <div id="auth-container"></div>
            </div>
        </div>
    </header>
    
    <div id="loading-view" class="fixed inset-0 flex items-center justify-center z-50 bg-gray-950"><div class="text-center py-10"><div class="spinner mb-4 mx-auto"></div><p class="text-lg text-gray-400">Loading Zenith...</p></div></div>
    <div id="login-view" class="hidden fixed inset-0 flex items-center justify-center z-40 bg-gray-950 p-4"><div class="text-center p-8 card max-w-md mx-auto animate-fade-in-up"><h2 class="text-3xl font-bold mb-4 text-gray-100">Welcome to <span class="gradient-text">Zenith</span></h2><p id="login-message" class="text-gray-300 mb-8">Sign in to begin your study journey.</p><button id="sign-in-btn-main" class="btn btn-primary w-full text-lg shadow-lg shadow-indigo-500/20"><svg class="w-6 h-6" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M47.532 24.552c0-1.566-.14-3.084-.404-4.548H24.5v8.58h12.944c-.566 2.76-2.213 5.108-4.72 6.708v5.524h7.112c4.162-3.832 6.596-9.42 6.596-16.264z" fill="#4285F4"/><path d="M24.5 48c6.48 0 11.944-2.14 15.928-5.788l-7.112-5.524c-2.14 1.44-4.884 2.292-7.816 2.292-6.004 0-11.084-4.04-12.9-9.492H4.42v5.7c3.48 6.912 10.32 11.532 18.08 11.532l2 .28z" fill="#34A853"/><path d="M11.6 28.98c-.34-.996-.54-2.052-.54-3.144s.2-2.148.54-3.144V16.992H4.42C2.852 20.04 2 23.436 2 27.024c0 3.588.852 6.984 2.42 10.032l7.18-5.7v-.376z" fill="#FBBC05"/><path d="M24.5 9.8c3.516 0 6.66 1.212 9.128 3.54l6.32-6.32C36.44.88 30.98 0 24.5 0 16.74 0 9.9 4.62 6.42 11.532l7.18 5.7c1.816-5.452 6.896-9.432 12.9-9.432z" fill="#EA4335"/></svg><span>Sign In with Google</span></button></div></div>

    <!-- This div holds the live component DOM nodes. They will be moved by JS into the correct layout. -->
    <div id="component-source" class="hidden">
        <div id="source-study-controls">
            <div id="study-controls-wrapper" class="space-y-8">
                <div id="study-controls-card" class="card p-4 lg:p-6 lg:sticky top-6 no-hover">
                    <h2 class="text-xl font-bold mb-5 text-gray-100 lg:block hidden">Study Session</h2>
                    <div class="space-y-4 lg:space-y-5">
                        <div class="hidden lg:block">
                            <label for="subject-input" class="block text-sm font-medium text-gray-300 mb-2">Subject</label>
                            <input type="text" id="subject-input" list="subject-list" class="form-input" placeholder="e.g., Quantum Physics">
                            <datalist id="subject-list"><option>Physics</option><option>Chemistry</option><option>Maths</option><option>Biology</option><option>History</option><option>Computer Science</option><option>Reading</option><option>Other</option></datalist>
                        </div>
                        <div class="hidden lg:block">
                            <label for="status-input" class="block text-sm font-medium text-gray-300 mb-2">Status (Optional)</label>
                            <input type="text" id="status-input" placeholder="e.g., Solving Problems" class="form-input">
                        </div>
                        <div class="flex items-center justify-between gap-4">
                            <div class="flex-grow lg:hidden">
                                <input type="text" id="mobile-subject-input" list="subject-list" class="form-input !p-3 text-sm" placeholder="Subject...">
                            </div>
                            <button id="start-study-btn" class="btn btn-primary w-full lg:w-auto flex-grow lg:flex-grow-0 lg:!py-4 text-base lg:text-lg shadow-lg shadow-indigo-500/30"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg><span class="hidden sm:inline">Start Studying</span></button>
                            <button id="stop-study-btn" class="btn btn-danger hidden w-full lg:w-auto flex-grow lg:flex-grow-0 lg:!py-4 text-base lg:text-lg"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg><span class="hidden sm:inline">Stop Studying</span></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="source-group-view">
            <div id="group-view-wrapper" class="space-y-8">
                <div id="group-view-card" class="card p-6">
                    <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-6 gap-4">
                        <div class="flex items-center gap-3 min-w-0">
                            <h2 id="group-name-title" class="text-3xl font-bold truncate text-gray-100" title="Select a Group">Select a Group</h2>
                            <button id="share-group-btn" class="hidden btn btn-secondary btn-sm !p-2" title="Share Group"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"><path fill="currentColor" d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/></svg></button>
                        </div>
                        <div id="group-actions-container" class="hidden flex-shrink-0 flex gap-2"><button id="leave-group-btn" class="btn btn-secondary btn-sm text-red-400 border-red-400/50 hover:bg-red-400/10">Leave</button><button id="delete-group-btn" class="btn btn-danger btn-sm font-semibold">Delete</button></div>
                    </div>
                    <div id="member-list-container" class="space-y-4"></div>
                </div>
            </div>
        </div>
        <div id="source-my-groups">
             <div id="my-groups-wrapper" class="space-y-8">
                <div id="my-groups-card" class="card p-6">
                    <h2 class="text-xl font-bold mb-4 text-gray-100">My Groups</h2>
                    <div id="my-groups-list" class="space-y-2 mb-4 max-h-60 overflow-y-auto no-scrollbar pr-1"></div>
                    <button id="manage-groups-btn" class="btn btn-secondary w-full"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg><span>Manage Groups</span></button>
                </div>
            </div>
        </div>
        <div id="source-discover">
             <div id="discover-wrapper" class="space-y-8">
                <div id="public-groups-card" class="card p-6 relative">
                    <div id="new-user-badge" class="hidden absolute -top-3 -right-3 px-3 py-1.5 bg-indigo-500 text-white text-xs font-bold rounded-full shadow-lg animate-pulse">Start Here!</div>
                    <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold text-gray-100">Discover</h2><button id="see-all-groups-btn" class="btn btn-secondary btn-sm px-3 py-1">See All</button></div>
                    <div id="public-groups-list-main" class="space-y-3 max-h-60 overflow-y-auto no-scrollbar pr-1"><p id="public-groups-loading-main" class="text-gray-400 text-center py-4">Loading...</p></div>
                </div>
            </div>
        </div>
        <div id="source-analytics">
             <div id="analytics-wrapper" class="space-y-8">
                <div id="analytics-card" class="card p-6 lg:sticky top-[10.5rem] no-hover">
                    <h2 class="text-xl font-bold mb-5 text-gray-100">Personal Analytics</h2>
                    <div class="mb-5 border-b border-gray-700"><div class="flex -mb-px"><button id="analytics-week-btn" class="py-3 px-1 mr-4 font-semibold border-b-2">This Week</button><button id="analytics-month-btn" class="py-3 px-1 font-semibold border-b-2">This Month</button></div></div>
                    <div class="text-center"><p class="text-6xl font-extrabold bg-clip-text text-transparent bg-gradient-to-r from-teal-300 to-indigo-400 mb-1" id="analytics-time-display">0m</p><p class="text-sm text-gray-400" id="analytics-range-display"></p></div>
                </div>
            </div>
        </div>
    </div>
    
    <main id="app-view" class="hidden container mx-auto px-4 max-w-7xl">
        <div class="hidden lg:grid lg:grid-cols-12 gap-8">
            <div class="lg:col-span-3 space-y-8" id="desktop-left-col"></div>
            <div class="lg:col-span-6 space-y-8" id="desktop-middle-col"></div>
            <div class="lg:col-span-3 space-y-8" id="desktop-right-col"></div>
        </div>
        <div id="mobile-views-container" class="lg:hidden space-y-8"></div>
    </main>

    <nav id="mobile-nav" class="lg:hidden fixed bottom-0 left-0 right-0 h-20 bg-gray-900/80 backdrop-blur-lg border-t border-gray-700/50 flex items-center z-30 animate-slide-in-bottom">
        <button id="mobile-nav-study" class="mobile-nav-btn"><svg class="nav-icon w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><span class="nav-text">Study</span></button>
        <button id="mobile-nav-groups" class="mobile-nav-btn"><svg class="nav-icon w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg><span class="nav-text">Groups</span></button>
        <button id="mobile-nav-leaderboard" class="mobile-nav-btn"><svg class="nav-icon w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg><span class="nav-text">Leaderboard</span></button>
    </nav>
    
    <!-- Modals -->
    <div id="group-modal" class="modal-overlay hidden"><div class="modal-card"><button id="close-group-modal-btn" class="absolute top-5 right-5 text-gray-500 hover:text-gray-100 p-1 rounded-full"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button><h2 class="text-2xl font-bold mb-6 text-gray-100">Manage Groups</h2><form id="create-group-form" class="space-y-4 mb-6 pb-6 border-b border-gray-700"><h3 class="text-lg font-semibold text-gray-100">Create a New Group</h3><input type="text" id="new-group-name" placeholder="New Group Name" class="form-input" required><select id="new-group-visibility" class="form-select"><option value="public">Public</option><option value="private">Private</option></select><button type="submit" class="btn btn-primary w-full">Create</button></form><form id="join-group-form" class="space-y-4"><h3 class="text-lg font-semibold text-gray-100">Join a Private Group</h3><input type="text" id="join-group-id" placeholder="Enter Group ID" class="form-input" required><button type="submit" class="btn btn-secondary w-full">Join</button></form><div class="mt-6 pt-6 border-t border-gray-700"><button id="browse-public-groups-btn" class="btn btn-secondary w-full">Browse Public Groups</button></div></div></div>
    <div id="public-groups-modal" class="modal-overlay hidden"><div class="modal-card"><button id="close-public-groups-modal-btn" class="absolute top-5 right-5 text-gray-500 hover:text-gray-100 p-1 rounded-full"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button><h2 class="text-2xl font-bold mb-6 text-gray-100">Browse Public Groups</h2><div id="public-groups-list-modal" class="space-y-3 max-h-96 overflow-y-auto no-scrollbar pr-1"><p id="public-groups-loading-modal" class="text-gray-400 text-center py-4">Loading...</p></div></div></div>
    <div id="share-group-modal" class="modal-overlay hidden"><div class="modal-card text-center"><button id="close-share-modal-btn" class="absolute top-5 right-5 text-gray-500 hover:text-gray-100 p-1 rounded-full"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button><h2 class="text-2xl font-bold mb-2 text-gray-100">Share Group</h2><p id="share-group-name" class="text-gray-300 mb-5"></p><div class="flex justify-center mb-5"><img id="share-qr-code" src="" alt="QR Code" class="rounded-lg w-48 h-48 bg-white p-2"></div><p class="text-xs text-gray-500 mb-2">Or copy the invite link:</p><div class="flex gap-2"><input type="text" id="share-link-input" class="form-input text-sm p-2 w-full !bg-gray-950" readonly><button id="copy-share-link-btn" class="btn btn-primary px-4 py-2 text-sm flex-shrink-0">Copy</button></div></div></div>
    <div id="alert-modal" class="modal-overlay hidden"><div class="modal-card text-center max-w-sm"><h2 id="alert-title" class="text-xl font-bold mb-3"></h2><p id="alert-message" class="text-gray-300 mb-6"></p><button id="alert-ok-btn" class="btn btn-primary w-full">OK</button></div></div>
    <div id="confirm-modal" class="modal-overlay hidden"><div class="modal-card max-w-sm"><h2 id="confirm-title" class="text-xl font-bold mb-3"></h2><p id="confirm-message" class="text-gray-300 mb-6"></p><div class="flex gap-3"><button id="confirm-cancel-btn" class="btn btn-secondary w-full">Cancel</button><button id="confirm-ok-btn" class="btn btn-primary w-full">Confirm</button></div></div></div>
    <div id="prompt-modal" class="modal-overlay hidden"><div class="modal-card max-w-sm"><h2 id="prompt-title" class="text-xl font-bold mb-3"></h2><p id="prompt-message" class="text-gray-300 mb-4"></p><p id="prompt-match-text" class="font-mono text-lg text-indigo-300 bg-gray-950 p-2 rounded-lg mb-4"></p><input type="text" id="prompt-input" class="form-input w-full mb-6" autocomplete="off"><div class="flex gap-3"><button id="prompt-cancel-btn" class="btn btn-secondary w-full">Cancel</button><button id="prompt-ok-btn" class="btn btn-danger w-full">Delete</button></div></div></div>
    <div id="name-change-modal" class="modal-overlay hidden"><div class="modal-card max-w-sm"><h2 class="text-xl font-bold mb-4">Change Display Name</h2><p class="text-gray-300 mb-4 text-sm">Visible to all group members.</p><form id="name-change-form"><input type="text" id="new-name-input" class="form-input w-full mb-6" required minlength="3" maxlength="30"><div class="flex gap-3"><button type="button" id="name-change-cancel-btn" class="btn btn-secondary w-full">Cancel</button><button type="submit" id="name-change-save-btn" class="btn btn-primary w-full">Save</button></div></form></div></div>
    <div id="group-goal-modal" class="modal-overlay hidden"><div class="modal-card max-w-sm"><h2 class="text-xl font-bold mb-4">Set Group Goal</h2><p class="text-gray-300 mb-4 text-sm">Set a short goal or message for the group.</p><form id="group-goal-form"><input type="text" id="group-goal-input" class="form-input w-full mb-6" maxlength="100" placeholder="e.g., Finish Chapter 5"><div class="flex gap-3"><button type="button" id="group-goal-cancel-btn" class="btn btn-secondary w-full">Cancel</button><button type="submit" id="group-goal-save-btn" class="btn btn-primary w-full">Set Goal</button></div></form></div></div>
    <div id="admin-modal" class="modal-overlay hidden"><div class="modal-card !max-w-3xl"><button id="close-admin-modal-btn" class="absolute top-5 right-5 text-gray-500 hover:text-gray-100 p-1 rounded-full"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button><h2 class="text-2xl font-bold mb-6">Admin Panel</h2><div class="card p-4 mb-6"><h3 class="text-lg font-semibold mb-2">App Stats</h3><div id="admin-stats-card" class="text-gray-300"><div class="spinner mx-auto"></div></div></div><div class="grid md:grid-cols-2 gap-6 max-h-[60vh] overflow-y-auto pr-2 no-scrollbar"><div><h3 class="text-lg font-semibold">Groups</h3><input type="text" id="admin-group-search" class="form-input" placeholder="Search..."><div id="admin-groups-list" class="space-y-2 max-h-96 overflow-y-auto no-scrollbar pr-1"></div></div><div><h3 class="text-lg font-semibold">Users</h3><input type="text" id="admin-user-search" class="form-input" placeholder="Search..."><div id="admin-users-list" class="space-y-2 max-h-96 overflow-y-auto no-scrollbar pr-1"></div></div></div></div></div>

    <script>
    document.addEventListener("DOMContentLoaded", () => {
        // --- FIREBASE & GLOBAL VARS ---
        const firebaseConfig = { apiKey: "AIzaSyAO9ya8gHtVbMfxcnAAJrz6FdYWvIRqgBY", authDomain: "studydashboard-2a3eb.firebaseapp.com", projectId: "studydashboard-2a3eb", storageBucket: "studydashboard-2a3eb.firebasestorage.app", messagingSenderId: "79210973277", appId: "1:79210973277:web:cc0a5fa86729fd6d3f65b4" };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const fieldValue = firebase.firestore.FieldValue;
        
        const dom = {
            appView: document.getElementById("app-view"), loadingView: document.getElementById("loading-view"), loginView: document.getElementById("login-view"),
            authContainer: document.getElementById("auth-container"), signInBtnMain: document.getElementById("sign-in-btn-main"), syncStatus: document.getElementById("sync-status"),
            mobileNav: document.getElementById("mobile-nav"), mobileNavStudy: document.getElementById("mobile-nav-study"), mobileNavGroups: document.getElementById("mobile-nav-groups"), mobileNavLeaderboard: document.getElementById("mobile-nav-leaderboard"),
            mobileViewsContainer: document.getElementById("mobile-views-container"),
            desktopLeftCol: document.getElementById("desktop-left-col"), desktopMiddleCol: document.getElementById("desktop-middle-col"), desktopRightCol: document.getElementById("desktop-right-col"),
            streakContainer: document.getElementById("streak-container"), streakCount: document.getElementById("streak-count"),
            groupModal: document.getElementById("group-modal"), closeGroupModalBtn: document.getElementById("close-group-modal-btn"), createGroupForm: document.getElementById("create-group-form"), joinGroupForm: document.getElementById("join-group-form"),
            publicGroupsModal: document.getElementById("public-groups-modal"), closePublicGroupsModalBtn: document.getElementById("close-public-groups-modal-btn"), browsePublicGroupsBtn: document.getElementById("browse-public-groups-btn"), publicGroupsListModal: document.getElementById("public-groups-list-modal"), publicGroupsLoadingModal: document.getElementById("public-groups-loading-modal"),
            shareGroupModal: document.getElementById("share-group-modal"), closeShareModalBtn: document.getElementById("close-share-modal-btn"), shareGroupName: document.getElementById("share-group-name"), shareQrCode: document.getElementById("share-qr-code"), shareLinkInput: document.getElementById("share-link-input"), copyShareLinkBtn: document.getElementById("copy-share-link-btn"),
            groupGoalModal: document.getElementById("group-goal-modal"), groupGoalForm: document.getElementById("group-goal-form"), groupGoalInput: document.getElementById("group-goal-input"), groupGoalCancelBtn: document.getElementById("group-goal-cancel-btn"), groupGoalSaveBtn: document.getElementById("group-goal-save-btn"),
            nameChangeModal: document.getElementById("name-change-modal"), nameChangeForm: document.getElementById("name-change-form"), newNameInput: document.getElementById("new-name-input"), nameChangeCancelBtn: document.getElementById("name-change-cancel-btn"), nameChangeSaveBtn: document.getElementById("name-change-save-btn"),
            alertModal: document.getElementById("alert-modal"), confirmModal: document.getElementById("confirm-modal"), promptModal: document.getElementById("prompt-modal"),
            // Component Wrappers
            studyControls: document.getElementById("study-controls-wrapper"), groupView: document.getElementById("group-view-wrapper"), myGroups: document.getElementById("my-groups-wrapper"), discover: document.getElementById("discover-wrapper"), analytics: document.getElementById("analytics-wrapper"),
        };

        let currentUser = null, currentUserProfile = null, currentGroupId = null, myGroups = new Map();
        let studyState = { isRunning: false }, groupListenerUnsubscribe = null, myGroupsListenerUnsubscribe = null, animationFrameId = null;
        let userStudyLogs = [], analyticsListenerUnsubscribe = null, appInitialized = false;

        // --- UTILITY & MODAL FUNCTIONS ---
        const escapeHTML = (str) => (typeof str !== 'string') ? '' : str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]);
        const formatTimeReadable = (s) => { const h=Math.floor(s/3600), m=Math.floor(s%3600/60); return h > 0 ? `${h}h ${m}m` : (m > 0 ? `${m}m` : `${Math.floor(s%60)}s`); };
        const formatTimeHHMMSS = (s) => `${Math.floor(s/3600).toString().padStart(2,"0")}:${Math.floor(s%3600/60).toString().padStart(2,"0")}:${Math.floor(s%60).toString().padStart(2,"0")}`;
        const showAlert = (message, title = "Alert") => { const el=dom.alertModal; el.querySelector("#alert-title").textContent=title; el.querySelector("#alert-message").textContent=message; el.classList.remove("hidden"); el.querySelector("#alert-ok-btn").onclick=()=>el.classList.add("hidden"); };
        const showConfirm = (message, title = "Are you sure?") => new Promise(resolve => { const el=dom.confirmModal; el.querySelector("#confirm-title").textContent=title; el.querySelector("#confirm-message").textContent=message; el.classList.remove("hidden"); el.querySelector("#confirm-ok-btn").onclick=()=>{el.classList.add("hidden");resolve(true);}; el.querySelector("#confirm-cancel-btn").onclick=()=>{el.classList.add("hidden");resolve(false);}; });
        const showPrompt = (message, title, match) => new Promise(resolve => { const el=dom.promptModal; el.querySelector("#prompt-title").textContent=title; el.querySelector("#prompt-message").textContent=message; el.querySelector("#prompt-match-text").textContent=match; el.querySelector("#prompt-input").value=""; el.classList.remove("hidden"); el.querySelector("#prompt-ok-btn").onclick=()=>{if(el.querySelector("#prompt-input").value===match){el.classList.add("hidden");resolve(true);}}; el.querySelector("#prompt-cancel-btn").onclick=()=>{el.classList.add("hidden");resolve(false);}; });

        // --- EVENT LISTENER ATTACHER (FIX) ---
        const attachAllEventListeners = () => {
            document.getElementById('start-study-btn')?.addEventListener('click', startStudy);
            document.getElementById('stop-study-btn')?.addEventListener('click', stopStudy);
            document.getElementById('manage-groups-btn')?.addEventListener('click', () => dom.groupModal.classList.remove('hidden'));
            document.getElementById('see-all-groups-btn')?.addEventListener('click', () => dom.browsePublicGroupsBtn.click());
            document.getElementById('share-group-btn')?.addEventListener('click', openShareModal);
            document.getElementById('leave-group-btn')?.addEventListener('click', leaveGroup);
            document.getElementById('delete-group-btn')?.addEventListener('click', handleDeleteGroup);
            document.getElementById('analytics-week-btn')?.addEventListener('click', () => renderAnalytics('week'));
            document.getElementById('analytics-month-btn')?.addEventListener('click', () => renderAnalytics('month'));
            document.getElementById('public-groups-list-main')?.addEventListener('click', handlePublicGroupJoin);
            dom.publicGroupsListModal?.addEventListener('click', handlePublicGroupJoin);
        };

        // --- DYNAMIC LAYOUT ENGINE ---
        const detachAllComponents = () => {
            document.getElementById('source-study-controls').appendChild(dom.studyControls);
            document.getElementById('source-group-view').appendChild(dom.groupView);
            document.getElementById('source-my-groups').appendChild(dom.myGroups);
            document.getElementById('source-discover').appendChild(dom.discover);
            document.getElementById('source-analytics').appendChild(dom.analytics);
        };

        const renderDesktopLayout = () => {
            detachAllComponents();
            dom.desktopLeftCol.appendChild(dom.myGroups);
            dom.desktopLeftCol.appendChild(dom.discover);
            dom.desktopMiddleCol.appendChild(dom.groupView);
            dom.desktopRightCol.appendChild(dom.studyControls);
            dom.desktopRightCol.appendChild(dom.analytics);
            dom.mobileViewsContainer.innerHTML = '';
            dom.mobileNav.classList.add('hidden');
            attachAllEventListeners();
        };

        const switchMobileView = (view) => {
            detachAllComponents();
            dom.desktopLeftCol.innerHTML = ''; dom.desktopMiddleCol.innerHTML = ''; dom.desktopRightCol.innerHTML = '';
            dom.mobileViewsContainer.innerHTML = '';
            dom.mobileNav.classList.remove('hidden');

            dom.mobileNav.querySelectorAll('.mobile-nav-btn').forEach(btn => btn.classList.remove('active'));
            if (view === 'study') { dom.mobileNavStudy.classList.add('active'); dom.mobileViewsContainer.appendChild(dom.studyControls); dom.mobileViewsContainer.appendChild(dom.groupView); }
            else if (view === 'groups') { dom.mobileNavGroups.classList.add('active'); dom.mobileViewsContainer.appendChild(dom.myGroups); dom.mobileViewsContainer.appendChild(dom.discover); }
            else if (view === 'leaderboard') { dom.mobileNavLeaderboard.classList.add('active'); const el = document.createElement('div'); el.id="leaderboard-view-container"; el.className="card p-6 space-y-4"; dom.mobileViewsContainer.appendChild(el); renderLeaderboardView(); }
            attachAllEventListeners();
        };
        
        // --- AUTH & INITIALIZATION ---
        auth.onAuthStateChanged(async user => {
            dom.loadingView.classList.add("hidden");
            if (user) {
                currentUser = user; dom.appView.classList.remove("hidden"); dom.loginView.classList.add("hidden"); await initUser(user);
            } else {
                currentUser = null; appInitialized = false; if(groupListenerUnsubscribe) groupListenerUnsubscribe(); if(myGroupsListenerUnsubscribe) myGroupsListenerUnsubscribe();
                dom.appView.classList.add("hidden"); dom.loginView.classList.remove("hidden"); updateAuthUI(null);
            }
        });

        const initUser = async (user) => {
            if (appInitialized) return; appInitialized = true;
            
            const userDocRef = db.doc(`zenith_users/${user.uid}`);
            const userDoc = await userDocRef.get();
            if (!userDoc.exists) await userDocRef.set({ uid: user.uid, displayName: user.displayName, photoURL: user.photoURL, currentGroupId: null, streak: 0, lastStudiedTimestamp: null });
            
            userDocRef.onSnapshot(doc => { if(!doc.exists) return; currentUserProfile = doc.data(); updateAuthUI(currentUser, currentUserProfile); updateStreakDisplay(currentUserProfile.streak || 0); });
            currentGroupId = (await userDocRef.get()).data().currentGroupId || null;
            
            if (window.innerWidth >= 1024) renderDesktopLayout(); else switchMobileView('study');

            attachMyGroupsListener(user.uid);
            attachAnalyticsListener(user.uid);
            renderPublicGroups(document.getElementById('public-groups-list-main'), document.getElementById('public-groups-loading-main'), 5, false);
        };

        const updateAuthUI = (user, profile) => {
            if(user && profile) {
                dom.authContainer.innerHTML = `<div class="relative"><button id="user-menu-button" class="flex items-center gap-2 h-10 rounded-full transition-colors hover:bg-gray-800 p-1"><img src="${escapeHTML(profile.photoURL)}" alt="" class="w-8 h-8 rounded-full"/><span class="text-sm font-semibold hidden sm:inline text-gray-100 pr-2">${escapeHTML(profile.displayName.split(" ")[0])}</span></button><div id="user-menu-dropdown" class="card absolute right-0 mt-2 w-48 p-2 hidden z-50"><div class="px-2 py-1 mb-1 border-b border-gray-700"><p class="text-sm font-semibold truncate text-gray-100">${escapeHTML(profile.displayName)}</p></div><button id="change-name-btn" class="w-full text-left flex items-center gap-2 p-2 rounded-lg hover:bg-gray-800">Change Name</button><button id="sign-out-btn" class="w-full text-left flex items-center gap-2 p-2 rounded-lg hover:bg-gray-800">Sign Out</button></div></div>`;
                dom.authContainer.querySelector("#user-menu-button").onclick = (e) => { e.stopPropagation(); dom.authContainer.querySelector("#user-menu-dropdown").classList.toggle("hidden"); };
                dom.authContainer.querySelector("#sign-out-btn").onclick = async () => { if(studyState.isRunning) await stopStudy(); auth.signOut(); };
                dom.authContainer.querySelector("#change-name-btn").onclick = () => { dom.newNameInput.value = profile.displayName; dom.nameChangeModal.classList.remove("hidden"); };
            } else { dom.authContainer.innerHTML = `<button id="sign-in-btn-auth" class="btn btn-primary btn-sm">Sign In</button>`; dom.authContainer.querySelector("#sign-in-btn-auth").onclick = () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }
        };

        // --- FEATURES (STREAKS, GOALS, LEADERBOARDS) ---
        const updateStreakDisplay = (streak) => { if (streak > 0) { dom.streakCount.textContent = streak; dom.streakContainer.classList.remove('hidden'); dom.streakContainer.classList.add('flex'); } else { dom.streakContainer.classList.add('hidden'); }};
        const handleStreakUpdate = async () => { const now = new Date(), today = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime(); const lastStudied = currentUserProfile.lastStudiedTimestamp ? currentUserProfile.lastStudiedTimestamp.toDate().getTime() : 0; const yesterday = today - 86400000; let newStreak = currentUserProfile.streak || 0; if (lastStudied < yesterday) newStreak = 1; else if (lastStudied < today) newStreak++; await db.doc(`zenith_users/${currentUser.uid}`).update({ streak: newStreak, lastStudiedTimestamp: fieldValue.serverTimestamp() }); };
        const renderGroupGoal = (goal, isOwner) => { const container = document.getElementById('group-view-card'); if(!container) return; container.querySelector('#group-goal-banner')?.remove(); if (!goal && !isOwner) return; const goalHTML = `<div id="group-goal-banner" class="p-4 mb-6 bg-indigo-500/10 border-2 border-indigo-500/30 rounded-2xl flex items-center justify-between gap-4"><div class="flex items-center gap-3"><span class="text-2xl">ðŸŽ¯</span><p class="font-semibold text-indigo-300">${goal ? escapeHTML(goal) : "No goal set."}</p></div>${isOwner ? '<button id="edit-goal-btn" class="btn btn-secondary btn-sm flex-shrink-0">Edit</button>' : ''}</div>`; container.insertAdjacentHTML('afterbegin', goalHTML); if(isOwner) document.getElementById('edit-goal-btn').onclick = () => { dom.groupGoalInput.value = myGroups.get(currentGroupId)?.groupGoal || ''; dom.groupGoalModal.classList.remove('hidden'); }; };
        const renderLeaderboardView = () => { const container = document.getElementById('leaderboard-view-container'); if (!container) return; container.innerHTML = `<div class="flex justify-between items-center"><h2 class="text-2xl font-bold">Leaderboard</h2><div id="leaderboard-tabs" class="flex bg-gray-900 p-1 rounded-xl"><button class="tab-btn active" data-period="week">Week</button><button class="tab-btn" data-period="month">Month</button></div></div><div id="leaderboard-list" class="space-y-3"></div>`; container.querySelectorAll('#leaderboard-tabs .tab-btn').forEach(btn => btn.onclick = (e) => { container.querySelectorAll('#leaderboard-tabs .tab-btn').forEach(b => b.classList.remove('active')); e.target.classList.add('active'); updateLeaderboard(e.target.dataset.period); }); updateLeaderboard('week'); };
        const updateLeaderboard = async (period) => { const listEl = document.getElementById('leaderboard-list'); if (!listEl) return; listEl.innerHTML = '<div class="spinner mx-auto my-8"></div>'; if (!currentGroupId) { listEl.innerHTML = '<p class="text-center text-gray-400 py-4">Select a group to see the leaderboard.</p>'; return; } const startDate = new Date(); startDate.setHours(0,0,0,0); if(period === 'week') startDate.setDate(startDate.getDate() - startDate.getDay()); else startDate.setDate(1); const membersSnap = await db.collection(`zenith_groups/${currentGroupId}/members`).get(); let scores = await Promise.all(membersSnap.docs.map(async doc => { const logsSnap = await db.collection(`zenith_users/${doc.id}/study_logs`).where('timestamp', '>=', startDate).get(); return { ...doc.data(), score: logsSnap.docs.reduce((sum, log) => sum + log.data().duration, 0) }; })); scores.sort((a, b) => b.score - a.score); const medal = ['ðŸ¥‡', 'ðŸ¥ˆ', 'ðŸ¥‰']; listEl.innerHTML = scores.map((mem, i) => `<div class="flex items-center gap-4 p-3 bg-gray-900 rounded-xl"><span class="text-xl font-bold w-8 text-center">${medal[i] || i + 1}</span><img src="${escapeHTML(mem.photoURL)}" class="w-10 h-10 rounded-full"><p class="flex-grow font-semibold truncate">${escapeHTML(mem.displayName)}</p><span class="font-bold text-lg">${formatTimeReadable(mem.score)}</span></div>`).join(''); };

        // --- CORE APP LOGIC (GROUPS, STUDYING, ETC.) ---
        const attachMyGroupsListener = (userId) => { if(myGroupsListenerUnsubscribe) myGroupsListenerUnsubscribe(); myGroupsListenerUnsubscribe = db.collection(`zenith_users/${userId}/groups`).onSnapshot(snapshot => { myGroups.clear(); snapshot.forEach(doc => myGroups.set(doc.id, doc.data())); renderMyGroups(); if (currentGroupId && myGroups.has(currentGroupId)) { viewGroup(currentGroupId); } else { clearGroupView(); } }); };
        const renderMyGroups = () => { const listEl = document.getElementById('my-groups-list'); if(!listEl) return; listEl.innerHTML = ""; if(myGroups.size === 0) { listEl.innerHTML = `<p class="text-sm text-gray-400 px-1">No groups yet.</p>`; return; } myGroups.forEach((data, id) => { const el = document.createElement("button"); el.className = `w-full text-left px-4 py-3 rounded-xl transition-colors ${id === currentGroupId ? 'bg-indigo-500 text-white font-semibold' : 'text-gray-300 hover:bg-gray-800'}`; el.textContent = escapeHTML(data.groupName); el.onclick = () => viewGroup(id); listEl.appendChild(el); }); };
        const viewGroup = async (groupId) => { if (studyState.isRunning) await stopStudy(); currentGroupId = groupId; await db.doc(`zenith_users/${currentUser.uid}`).update({ currentGroupId }); renderMyGroups(); if (groupListenerUnsubscribe) groupListenerUnsubscribe(); groupListenerUnsubscribe = db.doc(`zenith_groups/${groupId}`).onSnapshot(doc => { if (!doc.exists) { clearGroupView(); return; } const groupData = doc.data(); const isOwner = groupData.ownerId === currentUser.uid; myGroups.set(groupId, { ...myGroups.get(groupId), groupGoal: groupData.groupGoal }); const nameTitle = document.getElementById('group-name-title'); if(nameTitle) nameTitle.textContent = escapeHTML(groupData.name); document.getElementById('group-actions-container')?.classList.remove('hidden'); document.getElementById('share-group-btn')?.classList.remove('hidden'); document.getElementById('delete-group-btn')?.classList.toggle('hidden', !isOwner); document.getElementById('leave-group-btn')?.classList.toggle('hidden', isOwner); renderGroupGoal(groupData.groupGoal, isOwner); const leaderboardTabs = document.querySelector('#leaderboard-tabs .active'); if (leaderboardTabs) updateLeaderboard(leaderboardTabs.dataset.period); db.collection(`zenith_groups/${groupId}/members`).onSnapshot(snapshot => { renderGroupMembers(snapshot.docs.map(d => ({ id: d.id, ...d.data() }))); }); }); if (animationFrameId) cancelAnimationFrame(animationFrameId); runTimerLoop(); };
        const clearGroupView = () => { currentGroupId = null; const nameTitle = document.getElementById('group-name-title'); if (nameTitle) nameTitle.textContent = "Select a Group"; document.getElementById('group-actions-container')?.classList.add('hidden'); document.getElementById('share-group-btn')?.classList.add('hidden'); const memberList = document.getElementById('member-list-container'); if(memberList) memberList.innerHTML = `<div class="text-center py-12"><svg class="mx-auto h-12 w-12 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg><h3 class="mt-2 text-lg font-medium">No Group Selected</h3><p class="mt-1 text-sm text-gray-500">Select a group to get started.</p></div>`; renderMyGroups(); };
        const renderGroupMembers = (members) => { const container = document.getElementById('member-list-container'); if(!container) return; container.innerHTML = ''; if (members.length === 0) { container.innerHTML = `<p class="text-center text-gray-400 py-8">This group has no members yet.</p>`; return; } members.sort((a,b) => (a.id===currentUser.uid)?-1:(b.id===currentUser.uid)?1:(a.isStudying&&!b.isStudying)?-1:(!a.isStudying&&b.isStudying)?1:a.displayName.localeCompare(b.displayName)); const fragment = document.createDocumentFragment(); members.forEach(member => { const el = document.createElement("div"); const isMe = member.id === currentUser.uid, isStale = (Date.now() - (member.lastHeartbeat?.toDate().getTime() || 0)) > 30000, isStudying = member.isStudying && !isStale; let statusClass = "offline", statusText = "Offline"; if (isStudying) { statusClass = "studying"; statusText = `Studying: ${escapeHTML(member.subject || 'Study')}`; if(member.status) statusText += ` - ${escapeHTML(member.status)}`; } else if (!isStale && member.lastHeartbeat) { statusClass = "idle"; statusText = "Idle"; } const dailyTotal = (member.todayString === new Date().toISOString().slice(0, 10)) ? member.dailyTotal : 0; el.className = `member-card flex items-center gap-4 p-4 rounded-2xl border-2 ${isStudying ? 'is-studying' : ''}`; el.innerHTML = `<img src="${escapeHTML(member.photoURL)}" class="w-12 h-12 rounded-full flex-shrink-0"><div class="flex-grow overflow-hidden"><div class="flex items-center gap-2.5"><span class="status-dot ${statusClass}"></span><span class="font-semibold truncate">${escapeHTML(member.displayName)} ${isMe?'(You)':''}</span></div><p class="text-sm text-gray-400 truncate">${statusText}</p></div><div class="flex-shrink-0 text-right"><div class="text-xl font-semibold tabular-nums" data-client-timer="true" data-start-time="${isStudying ? member.startTime?.toDate().getTime() : '0'}">00:00:00</div><div class="text-xs text-gray-400">Today: ${formatTimeReadable(dailyTotal)}</div></div>`; fragment.appendChild(el); }); container.appendChild(fragment); };
        const runTimerLoop = () => { document.querySelectorAll('[data-client-timer="true"]').forEach(el => { const startTime = parseInt(el.dataset.startTime, 10); if (startTime > 0) el.textContent = formatTimeHHMMSS(Math.floor(Math.max(0, Date.now() - startTime) / 1000)); }); animationFrameId = requestAnimationFrame(runTimerLoop); };
        const startStudy = async () => { if (studyState.isRunning || !currentUser || !currentGroupId) return; const subject = document.getElementById('subject-input')?.value.trim() || document.getElementById('mobile-subject-input')?.value.trim() || "Study"; const status = document.getElementById('status-input')?.value.trim(); await handleStreakUpdate(); studyState = { isRunning: true, subject, startTime: Date.now(), heartbeatIntervalId: setInterval(runHeartbeat, 29000), status: status||null }; const now = fieldValue.serverTimestamp(); await db.doc(`zenith_groups/${currentGroupId}/members/${currentUser.uid}`).update({ isStudying: true, subject, status: studyState.status, startTime: now, lastHeartbeat: now, todayString: new Date().toISOString().slice(0, 10) }); document.querySelectorAll('#start-study-btn').forEach(b=>b.classList.add('hidden')); document.querySelectorAll('#stop-study-btn').forEach(b=>b.classList.remove('hidden')); };
        const stopStudy = async () => { if (!studyState.isRunning) return; clearInterval(studyState.heartbeatIntervalId); const duration = Math.round((Date.now() - studyState.startTime) / 1000); studyState = { isRunning: false }; document.querySelectorAll('#start-study-btn').forEach(b=>b.classList.remove('hidden')); document.querySelectorAll('#stop-study-btn').forEach(b=>b.classList.add('hidden')); if (duration < 10) { showAlert("Session too short, not logged."); await db.doc(`zenith_groups/${currentGroupId}/members/${currentUser.uid}`).update({ isStudying: false, startTime: null }); return; } await db.runTransaction(async t => { const memberRef = db.doc(`zenith_groups/${currentGroupId}/members/${currentUser.uid}`); const memberDoc = await t.get(memberRef); const newTotal = (memberDoc.data().todayString === new Date().toISOString().slice(0, 10) ? memberDoc.data().dailyTotal : 0) + duration; t.update(memberRef, { isStudying: false, startTime: null, dailyTotal: newTotal, todayString: new Date().toISOString().slice(0, 10) }); t.set(db.collection(`zenith_users/${currentUser.uid}/study_logs`).doc(), { duration, subject: studyState.subject, groupId: currentGroupId, timestamp: fieldValue.serverTimestamp() }); }); };
        const runHeartbeat = async () => { if (studyState.isRunning && currentGroupId) db.doc(`zenith_groups/${currentGroupId}/members/${currentUser.uid}`).update({ lastHeartbeat: fieldValue.serverTimestamp() }); };
        const attachAnalyticsListener = (userId) => { if (analyticsListenerUnsubscribe) analyticsListenerUnsubscribe(); const ninetyDaysAgo = new Date(); ninetyDaysAgo.setDate(ninetyDaysAgo.getDate() - 90); analyticsListenerUnsubscribe = db.collection(`zenith_users/${userId}/study_logs`).where("timestamp", ">", firebase.firestore.Timestamp.fromDate(ninetyDaysAgo)).onSnapshot((snapshot) => { userStudyLogs = snapshot.docs.map(doc => doc.data()); renderAnalytics('week'); }); };
        const renderAnalytics = (filter = 'week') => { const weekBtn = document.getElementById('analytics-week-btn'); if(!weekBtn) return; const monthBtn = document.getElementById('analytics-month-btn'); const now = new Date(); let startDate = new Date(now.getFullYear(), now.getMonth(), (filter === 'week' ? now.getDate() - now.getDay() : 1)); startDate.setHours(0,0,0,0); weekBtn.style.borderColor = filter === 'week' ? '#818cf8' : 'transparent'; weekBtn.style.color = filter === 'week' ? '#e3e3e6' : '#7f7f98'; monthBtn.style.borderColor = filter === 'month' ? '#818cf8' : 'transparent'; monthBtn.style.color = filter === 'month' ? '#e3e3e6' : '#7f7f98'; const totalSeconds = userStudyLogs.filter(log => log.timestamp && log.timestamp.toDate() >= startDate).reduce((sum, log) => sum + (log.duration || 0), 0); const timeDisplay = document.getElementById('analytics-time-display'); if(timeDisplay) timeDisplay.textContent = formatTimeReadable(totalSeconds); const rangeDisplay = document.getElementById('analytics-range-display'); if(rangeDisplay) rangeDisplay.textContent = `Total study time this ${filter}`; };
        const renderPublicGroups = async (container, loader, limit, isModal) => { if (!container || !loader) return; container.innerHTML = ""; loader.style.display = 'block'; try { const snap = await db.collection("zenith_groups").where("visibility", "==", "public").limit(limit).get(); loader.style.display = 'none'; if (snap.empty) { container.innerHTML = `<p class="text-gray-400 text-center text-sm py-4">No public groups found.</p>`; return; } snap.forEach(doc => { const { name } = doc.data(); const id = doc.id; const isMember = myGroups.has(id); const el = document.createElement("div"); el.className = `flex items-center justify-between p-3 ${isModal ? 'bg-gray-800' : 'bg-gray-900'} rounded-lg`; el.innerHTML = `<div class="min-w-0"><h4 class="font-semibold truncate text-gray-100">${escapeHTML(name)}</h4>${isModal ? `<p class="text-xs text-gray-500 font-mono">${id}</p>`:''}</div><button data-group-id="${id}" data-group-name="${escapeHTML(name)}" class="btn ${isModal ? 'btn-secondary' : 'btn-primary'} btn-sm join-public-btn flex-shrink-0" ${isMember ? 'disabled' : ''}>${isMember ? 'Joined' : 'Join'}</button>`; container.appendChild(el); }); } catch (e) { loader.style.display = 'none'; container.innerHTML = `<p class="text-red-400 text-center py-4">Failed to load groups.</p>`; } };
        const handlePublicGroupJoin = async (e) => { const btn = e.target.closest(".join-public-btn"); if (btn) { btn.disabled = true; btn.textContent = "Joining..."; try { await joinGroup(btn.dataset.groupId, btn.dataset.groupName); dom.publicGroupsModal.classList.add("hidden"); } catch (error) { showAlert("Failed to join group."); btn.disabled = false; btn.textContent = "Join"; } } };
        const openShareModal = () => { const { groupName } = myGroups.get(currentGroupId); const url = `${window.location.origin}${window.location.pathname}?join=${currentGroupId}`; dom.shareGroupName.textContent = escapeHTML(groupName); dom.shareLinkInput.value = url; dom.shareQrCode.src = `https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${encodeURIComponent(url)}&bgcolor=ffffff`; dom.shareGroupModal.classList.remove("hidden"); };
        const leaveGroup = async () => { if (!currentUser || !currentGroupId || !(await showConfirm(`Leave "${escapeHTML(myGroups.get(currentGroupId).groupName)}"?`))) return; if (studyState.isRunning) await stopStudy(); const oldGroupId = currentGroupId; await db.doc(`zenith_groups/${oldGroupId}/members/${currentUser.uid}`).delete(); await db.doc(`zenith_users/${currentUser.uid}/groups/${oldGroupId}`).delete(); await db.doc(`zenith_users/${currentUser.uid}`).update({ currentGroupId: null }); clearGroupView(); showSyncStatus("Left group"); };
        const handleDeleteGroup = async () => { if (!currentUser || !currentGroupId) return; const { groupName } = myGroups.get(currentGroupId); if (!(await showPrompt(`This is permanent. Type the group name to confirm.`, "Final Confirmation", groupName))) return; const membersSnap = await db.collection(`zenith_groups/${currentGroupId}/members`).get(); const batch = db.batch(); membersSnap.forEach(doc => { batch.delete(doc.ref); batch.delete(db.doc(`zenith_users/${doc.id}/groups/${currentGroupId}`)); }); batch.delete(db.doc(`zenith_groups/${currentGroupId}`)); await batch.commit(); showSyncStatus("Group deleted."); };
        const joinGroup = async (groupId, groupName) => { if (!currentUser || !currentUserProfile) return; const { ownerId } = (await db.doc(`zenith_groups/${groupId}`).get()).data(); await db.doc(`zenith_groups/${groupId}/members/${currentUser.uid}`).set({ joinedAt: fieldValue.serverTimestamp(), displayName: currentUserProfile.displayName, photoURL: currentUserProfile.photoURL, isStudying: false, subject: null, startTime: null, lastHeartbeat: null, todayString: new Date().toISOString().slice(0, 10), dailyTotal: 0, status: null }, { merge: true }); await db.doc(`zenith_users/${currentUser.uid}/groups/${groupId}`).set({ groupName, joinedAt: fieldValue.serverTimestamp(), ownerId }); await db.doc(`zenith_users/${currentUser.uid}`).update({ currentGroupId: groupId }); showSyncStatus(`Joined: ${escapeHTML(groupName)}`); };

        // --- GLOBAL EVENT LISTENERS ---
        dom.signInBtnMain.onclick = () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
        dom.mobileNavStudy.onclick = () => switchMobileView('study');
        dom.mobileNavGroups.onclick = () => switchMobileView('groups');
        dom.mobileNavLeaderboard.onclick = () => switchMobileView('leaderboard');
        dom.closeGroupModalBtn.onclick = () => dom.groupModal.classList.add('hidden');
        dom.closePublicGroupsModalBtn.onclick = () => dom.publicGroupsModal.classList.add('hidden');
        dom.browsePublicGroupsBtn.onclick = () => { dom.publicGroupsModal.classList.remove('hidden'); renderPublicGroups(dom.publicGroupsListModal, dom.publicGroupsLoadingModal, 50, true); };
        dom.closeShareModalBtn.onclick = () => dom.shareGroupModal.classList.add('hidden');
        dom.copyShareLinkBtn.onclick = (e) => { navigator.clipboard.writeText(dom.shareLinkInput.value).then(() => { e.target.textContent = "Copied!"; setTimeout(() => e.target.textContent = "Copy", 2000); }); };
        dom.groupGoalForm.onsubmit = async (e) => { e.preventDefault(); dom.groupGoalSaveBtn.disabled = true; await db.doc(`zenith_groups/${currentGroupId}`).update({ groupGoal: dom.groupGoalInput.value.trim() }); dom.groupGoalModal.classList.add('hidden'); dom.groupGoalSaveBtn.disabled = false; };
        dom.groupGoalCancelBtn.onclick = () => dom.groupGoalModal.classList.add('hidden');
        dom.nameChangeForm.onsubmit = async (e) => { e.preventDefault(); const newName = dom.newNameInput.value.trim(); if(newName.length < 3) return; dom.nameChangeSaveBtn.disabled = true; const batch = db.batch(); batch.update(db.doc(`zenith_users/${currentUser.uid}`), {displayName: newName}); myGroups.forEach((_, id) => batch.update(db.doc(`zenith_groups/${id}/members/${currentUser.uid}`), {displayName: newName})); await batch.commit(); dom.nameChangeModal.classList.add('hidden'); dom.nameChangeSaveBtn.disabled = false; };
        dom.nameChangeCancelBtn.onclick = () => dom.nameChangeModal.classList.add('hidden');
        dom.createGroupForm.onsubmit = async (e) => { e.preventDefault(); const name = dom.createGroupForm.querySelector("#new-group-name").value.trim(); if(!name) return; const ref = await db.collection("zenith_groups").add({ name, visibility: dom.createGroupForm.querySelector("#new-group-visibility").value, ownerId: currentUser.uid, createdAt: fieldValue.serverTimestamp() }); await joinGroup(ref.id, name); dom.groupModal.classList.add('hidden'); };
        dom.joinGroupForm.onsubmit = async (e) => { e.preventDefault(); const id = dom.joinGroupForm.querySelector("#join-group-id").value.trim(); if(!id) return; try { const doc = await db.doc(`zenith_groups/${id}`).get(); if(!doc.exists) { showAlert("Group not found"); return; } await joinGroup(id, doc.data().name); dom.groupModal.classList.add('hidden'); } catch (err) { showAlert("Error joining group."); }};
        document.addEventListener("click", (e) => { const menu = document.getElementById("user-menu-dropdown"); if(menu && !menu.classList.contains("hidden") && !document.getElementById("user-menu-button")?.contains(e.target)) menu.classList.add("hidden"); });
        
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                if(!currentUser) return;
                const isDesktop = window.innerWidth >= 1024;
                if (isDesktop) { renderDesktopLayout(); }
                else { const activeTab = document.querySelector('#mobile-nav .active')?.id.replace('mobile-nav-', ''); switchMobileView(activeTab || 'study'); }
            }, 150);
        });
    });
    </script>
</body>
</html>
