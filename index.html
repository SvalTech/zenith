<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="description" content="An exam tracker for JEE & NEET aspirants. Track tasks, mocks, and progress.">
    <meta name="theme-color" content="#4f46e5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <!-- Emoji Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸŽ¯</text></svg>">
    <title>Zenith - sval.tech</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    height: {
                        screen: '100dvh', 
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'slide-up': 'slideUp 0.3s ease-out',
                        'bounce-slight': 'bounceSlight 1s infinite',
                        'spin-slow': 'spin 3s linear infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(100%)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        bounceSlight: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-3px)' },
                        }
                    },
                    boxShadow: {
                        'soft': '0 4px 30px rgba(0, 0, 0, 0.05)',
                        'glow': '0 0 20px rgba(99, 102, 241, 0.4)',
                        'glow-sm': '0 0 10px rgba(99, 102, 241, 0.3)',
                        'up': '0 -4px 20px rgba(0,0,0,0.1)',
                    },
                    screens: {
                        'xs': '380px',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none; /* Prevent rubber banding on body */
        }
        
        /* Background Image Layer */
        #app-background {
            position: fixed;
            inset: 0;
            z-index: -1;
            background-size: cover;
            background-position: center;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        /* Glassmorphism utilities */
        .glass {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        .dark .glass {
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }
        .dark .glass-card {
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .task-checkbox:checked + div {
            text-decoration: line-through;
            opacity: 0.6;
        }

        .day-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        @media (min-width: 768px) {
            .day-card:hover { transform: translateY(-4px); z-index: 10; }
        }
        
        /* Dragging Styles */
        .day-card.drag-over {
            transform: scale(1.02);
            border-color: #6366f1 !important;
            background-color: rgba(99, 102, 241, 0.1) !important;
        }
        .task-item.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }
        .task-item {
            cursor: grab;
        }
        .task-item:active {
            cursor: grabbing;
        }
        
        .modal-backdrop {
            background-color: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
        }
        
        /* Mobile Bottom Sheet Animation */
        .mobile-sheet {
            transition: transform 0.3s cubic-bezier(0.32, 0.72, 0, 1);
            transform: translateY(100%);
            border-radius: 2rem 2rem 0 0;
            touch-action: none; /* Prepare for swipe down */
        }
        .mobile-sheet.open {
            transform: translateY(0);
        }

        /* Spinner */
        .spinner {
            border: 3px solid rgba(99, 102, 241, 0.3);
            border-radius: 50%;
            border-top: 3px solid #6366f1;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        .btn-spinner {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 2px solid white;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Subject Colors - More Pastel/Modern */
        .radio-Physics:checked + div { background-color: #fee2e2; color: #b91c1c; border-color: #fca5a5; }
        .dark .radio-Physics:checked + div { background-color: rgba(185, 28, 28, 0.2); color: #fca5a5; border-color: #7f1d1d; }
        
        .radio-Chemistry:checked + div { background-color: #fef3c7; color: #b45309; border-color: #fcd34d; }
        .dark .radio-Chemistry:checked + div { background-color: rgba(180, 83, 9, 0.2); color: #fcd34d; border-color: #78350f; }
        
        .radio-Maths:checked + div { background-color: #dbeafe; color: #1d4ed8; border-color: #93c5fd; }
        .dark .radio-Maths:checked + div { background-color: rgba(29, 78, 216, 0.2); color: #93c5fd; border-color: #1e3a8a; }
        
        .radio-Biology:checked + div { background-color: #dcfce7; color: #15803d; border-color: #86efac; }
        .dark .radio-Biology:checked + div { background-color: rgba(21, 128, 61, 0.2); color: #86efac; border-color: #14532d; }

        .radio-MockTest:checked + div { background-color: #f3e8ff; color: #7e22ce; border-color: #d8b4fe; }
        .dark .radio-MockTest:checked + div { background-color: rgba(126, 34, 206, 0.2); color: #d8b4fe; border-color: #581c87; }

        .radio-Custom:checked + div { background-color: #ccfbf1; color: #0f766e; border-color: #5eead4; }
        .dark .radio-Custom:checked + div { background-color: rgba(20, 184, 166, 0.2); color: #5eead4; border-color: #134e4a; }
        
        button:disabled { opacity: 0.6; cursor: not-allowed; }

        /* Smooth inputs */
        input, textarea, select { transition: all 0.2s; }
        input:focus, textarea:focus, select:focus { transform: translateY(-1px); }

        /* Mobile specific adjustments */
        @media (max-width: 768px) {
            .mobile-bottom-nav {
                padding-bottom: env(safe-area-inset-bottom);
            }
            .mobile-content-padding {
                padding-bottom: calc(80px + env(safe-area-inset-bottom));
            }
            .no-scrollbar::-webkit-scrollbar {
                display: none;
            }
            .no-scrollbar {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
        }
        
        /* Drag Handle for Sheets */
        .drag-handle {
            width: 48px;
            height: 6px;
            background-color: #e2e8f0;
            border-radius: 9999px;
            margin: 0 auto 16px auto;
        }
        .dark .drag-handle { background-color: #334155; }

        /* --- SYLLABUS TRACKER STYLES --- */
        .chapter-leaf {
            transition: background-color 0.15s ease-out;
            cursor: pointer;
        }
        .chapter-leaf:hover {
            background-color: rgba(241, 245, 249, 0.5);
        }
        .dark .chapter-leaf:hover {
            background-color: rgba(30, 41, 59, 0.5);
        }
        .action-panel {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.2s ease-out;
            opacity: 0;
        }
        .action-panel.open {
            max-height: 500px;
            opacity: 1;
        }
        .arrow-icon { transition: transform 0.3s ease; }
        .rotate-180 { transform: rotate(180deg); }
        .columns-1 { column-count: 1; }
        @media (min-width: 1024px) {
            .columns-2 { column-count: 2; }
        }
        .break-inside-avoid { break-inside: avoid; }
        
        .badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 700;
            text-transform: uppercase;
        }
        .badge-pyq { background: rgba(16, 185, 129, 0.1); color: #10b981; border: 1px solid rgba(16, 185, 129, 0.2); }
        .dark .badge-pyq { background: rgba(16, 185, 129, 0.15); color: #34d399; }
        
        .badge-rev { background: rgba(99, 102, 241, 0.1); color: #6366f1; border: 1px solid rgba(99, 102, 241, 0.2); }
        .dark .badge-rev { background: rgba(99, 102, 241, 0.15); color: #818cf8; }
        
        .status-dot { width: 8px; height: 8px; border-radius: 50%; }
        .dot-neutral { background-color: #94a3b8; }
        .dot-yellow { background-color: #eab308; }
        .dot-green { background-color: #22c55e; }
        .dot-indigo { background-color: #6366f1; }
    </style>
</head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-TCK0S6VC58"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-TCK0S6VC58');
</script>
<body class="h-screen flex flex-col md:flex-row overflow-hidden text-slate-800 bg-slate-50 dark:bg-slate-900 dark:text-slate-100 transition-colors duration-500 selection:bg-indigo-500 selection:text-white">

    <!-- Dynamic Background -->
    <div id="app-background"></div>

    <!-- Login Screen -->
    <div id="login-screen" class="fixed inset-0 z-[70] bg-slate-50 dark:bg-slate-900 flex flex-col items-center justify-center p-6 hidden">
        <div class="max-w-md w-full fade-in bg-white dark:bg-slate-800 p-8 rounded-[2rem] shadow-2xl border border-slate-200 dark:border-slate-700 relative overflow-hidden">
             <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500"></div>
             <div class="text-center mb-8 mt-2">
                <div class="w-16 h-16 bg-indigo-100 dark:bg-indigo-900/30 rounded-2xl flex items-center justify-center mx-auto mb-4 text-3xl">ðŸŽ¯</div>
                <h1 class="text-4xl font-black text-slate-900 dark:text-white tracking-tighter mb-2 flex flex-col items-center">
                    Zenith 
                    <span class="text-sm font-medium text-slate-400 dark:text-slate-500 mt-1">by <a href="https://sval.tech" target="_blank" class="hover:text-indigo-500 underline decoration-indigo-500/30">sval.tech</a></span>
                </h1>
                <p class="text-slate-500 dark:text-slate-400 mb-6">Your workspace for success.</p>
                
                <button onclick="signInWithGoogle()" class="w-full flex items-center justify-center gap-3 bg-slate-900 dark:bg-white hover:opacity-90 text-white dark:text-slate-900 font-bold py-4 px-4 rounded-2xl transition-all shadow-xl shadow-slate-200 dark:shadow-none transform active:scale-95 group">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5" alt="Google">
                    <span>Start Your Journey</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 z-[60] bg-white dark:bg-slate-900 flex items-center justify-center transition-opacity duration-500">
        <div class="flex flex-col items-center gap-4">
            <div class="spinner w-10 h-10 border-indigo-500"></div>
            <p class="text-sm font-medium text-slate-500 dark:text-slate-400 animate-pulse">Setting up your space...</p>
        </div>
    </div>

    <!-- Desktop Sidebar (Hidden on Mobile) -->
    <aside class="hidden md:flex w-80 bg-white/95 dark:bg-slate-900/95 backdrop-blur-md border-r border-slate-200 dark:border-slate-800 flex-col shrink-0 z-[50] shadow-none relative h-full transition-transform duration-300" id="desktop-sidebar">
        <!-- Header -->
        <div class="p-6 shrink-0">
            <div class="flex items-center justify-between mb-8">
                <div>
                    <h1 class="text-2xl font-black text-slate-900 dark:text-white flex items-center gap-2 tracking-tight">
                        <span class="text-indigo-600 dark:text-indigo-400">Zenith</span>
                    </h1>
                    <div class="text-xs font-medium text-slate-400 dark:text-slate-500 mt-0.5">by <a href="https://sval.tech" target="_blank" class="hover:text-indigo-500 transition-colors">sval.tech</a></div>
                </div>
                <button onclick="openSettings()" class="p-2 text-slate-400 hover:text-indigo-600 dark:hover:text-indigo-400 hover:bg-slate-50 dark:hover:bg-slate-800 rounded-xl transition-colors"><i data-lucide="settings" class="w-5 h-5"></i></button>
            </div>

            <!-- Countdown Card -->
            <div id="desktop-countdown-card" class="bg-gradient-to-br from-indigo-500 to-purple-600 rounded-3xl p-5 shadow-lg shadow-indigo-500/20 relative overflow-hidden group mb-6 text-white transition-all duration-300">
                <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><i data-lucide="hourglass" class="w-16 h-16 text-white"></i></div>
                <div class="text-indigo-100 text-[10px] font-bold mb-1 uppercase tracking-wider">Time Remaining</div>
                <div class="flex items-baseline gap-1 mb-1"><span id="days-left-desktop" class="text-5xl font-black tracking-tight">--</span><span class="text-sm font-medium opacity-80">Days</span></div>
                <div id="target-date-display-desktop" class="text-[10px] text-white/80 font-mono bg-white/20 inline-block px-2 py-0.5 rounded backdrop-blur-sm">Target: --</div>
            </div>

            <!-- Navigation Tabs -->
            <nav class="flex flex-col gap-1 p-1 bg-slate-100 dark:bg-slate-800/50 rounded-2xl mb-6">
                <div class="flex w-full">
                    <button onclick="switchView('calendar')" id="nav-desktop-calendar" class="flex-1 py-2 text-xs font-bold rounded-xl transition-all flex items-center justify-center gap-2 bg-white dark:bg-slate-700 shadow-sm text-indigo-600 dark:text-indigo-300"><i data-lucide="calendar" class="w-4 h-4"></i> Planner</button>
                    <button onclick="switchView('weekly')" id="nav-desktop-weekly" class="flex-1 py-2 text-xs font-bold rounded-xl transition-all flex items-center justify-center gap-2 text-slate-500 dark:text-slate-400 hover:text-slate-700"><i data-lucide="crosshair" class="w-4 h-4"></i> Targets</button>
                </div>
                <div class="flex w-full mt-1">
                    <button onclick="switchView('timer')" id="nav-desktop-timer" class="flex-1 py-2 text-xs font-bold rounded-xl transition-all flex items-center justify-center gap-2 text-slate-500 dark:text-slate-400 hover:text-slate-700"><i data-lucide="timer" class="w-4 h-4"></i> Timer</button>
                    <button onclick="switchView('stats')" id="nav-desktop-stats" class="flex-1 py-2 text-xs font-bold rounded-xl transition-all flex items-center justify-center gap-2 text-slate-500 dark:text-slate-400 hover:text-slate-700"><i data-lucide="bar-chart-2" class="w-4 h-4"></i> Stats</button>
                    <button onclick="switchView('syllabus')" id="nav-desktop-syllabus" class="flex-1 py-2 text-xs font-bold rounded-xl transition-all flex items-center justify-center gap-2 text-slate-500 dark:text-slate-400 hover:text-slate-700"><i data-lucide="book-open" class="w-4 h-4"></i> Syllabus</button>
                </div>
            </nav>
        </div>

        <!-- Add Task Form Container (Restored) -->
        <div id="desktop-add-task-container" class="flex-1 overflow-y-auto px-6 pb-6 space-y-6 custom-scrollbar">
            <h2 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 flex items-center gap-2"><i data-lucide="plus-square" class="w-3 h-3"></i> Quick Add Task</h2>
            <form id="add-task-form" class="space-y-4">
                <input type="date" id="task-date" class="w-full bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 outline-none dark:text-white transition-all">
                
                <div>
                    <div class="flex justify-between items-center mb-2">
                         <label class="block text-xs font-medium text-slate-500 dark:text-slate-400">Subject</label>
                         <button type="button" onclick="openCustomSubjectModal()" class="text-[10px] font-bold text-indigo-500 hover:text-indigo-600 bg-indigo-50 dark:bg-indigo-900/20 px-2 py-1 rounded-md transition-colors">+ Manage Subjects</button>
                    </div>
                    <div id="subject-selector" class="grid grid-cols-2 gap-2"></div>
                </div>
                
                <!-- Dynamic Mock Fields -->
                <div id="mock-fields-container" class="hidden animate-slide-up space-y-3 p-4 bg-purple-50 dark:bg-purple-900/10 rounded-2xl border border-purple-100 dark:border-purple-900/30">
                    <div class="flex items-center gap-2 mb-1 text-purple-700 dark:text-purple-300">
                        <i data-lucide="trophy" class="w-3.5 h-3.5"></i>
                        <span class="text-xs font-bold">Score (Optional)</span>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-[10px] font-bold text-purple-600 dark:text-purple-400 mb-1 uppercase">Obtained</label>
                            <input type="number" id="task-marks" placeholder="--" class="w-full bg-white dark:bg-slate-800 border border-purple-200 dark:border-slate-600 rounded-lg px-3 py-2 text-sm outline-none dark:text-white font-bold text-purple-600 focus:ring-2 focus:ring-purple-500 text-center">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-purple-600 dark:text-purple-400 mb-1 uppercase">Total</label>
                            <input type="number" id="task-max-marks" placeholder="300" class="w-full bg-white dark:bg-slate-800 border border-purple-200 dark:border-slate-600 rounded-lg px-3 py-2 text-sm outline-none dark:text-white font-bold text-purple-600 focus:ring-2 focus:ring-purple-500 text-center">
                        </div>
                    </div>
                </div>

                <textarea id="task-input" rows="2" placeholder="What's the goal?" class="w-full bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 outline-none dark:text-white resize-none transition-all"></textarea>
                
                <button id="btn-add-task" type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-indigo-500/20 transition-all active:scale-95 flex items-center justify-center gap-2 hover:translate-y-[-2px]">
                    <i data-lucide="plus" class="w-5 h-5"></i> <span>Add to Plan</span>
                </button>
            </form>
        </div>

        <!-- Footer -->
        <div class="p-5 border-t border-slate-100 dark:border-slate-800 bg-slate-50/50 dark:bg-slate-900/50">
            <div class="flex items-center gap-3">
                <div id="user-avatar-desktop" class="w-9 h-9 rounded-full bg-indigo-100 dark:bg-indigo-900 flex items-center justify-center text-indigo-600 dark:text-indigo-400 font-bold text-sm ring-2 ring-white dark:ring-slate-700 shadow-sm">U</div>
                <div class="flex-1 min-w-0"><p id="user-name-desktop" class="text-xs font-bold text-slate-900 dark:text-white truncate">User</p><p id="user-email-desktop" class="text-[10px] text-slate-500 truncate">Syncing...</p></div>
                <button onclick="handleSignOut()" class="p-2 text-slate-400 hover:text-rose-500 hover:bg-rose-50 dark:hover:bg-rose-900/20 rounded-lg transition-colors" title="Sign Out"><i data-lucide="log-out" class="w-4 h-4"></i></button>
            </div>
        </div>
    

    </aside>

    <!-- Main Content Area -->
    <main id="main-content-area" class="flex-1 flex flex-col h-full overflow-hidden relative bg-slate-50/50 dark:bg-slate-900/50 mobile-content-padding touch-pan-x">
        
        <!-- Mobile Header -->
        <div class="md:hidden glass border-b border-slate-200 dark:border-slate-800 p-4 flex justify-between items-center z-20 sticky top-0 shadow-sm">
            <div>
                <h1 class="font-black text-xl text-slate-800 dark:text-white flex items-center gap-2 tracking-tight">
                    <span class="text-indigo-600 dark:text-indigo-400">Zenith</span>
                </h1>
                <div class="text-[10px] font-medium text-slate-400 dark:text-slate-500 -mt-0.5">by sval.tech</div>
            </div>
            <!-- Mobile Countdown Pill -->
            <div id="mobile-countdown-pill" class="hidden px-3 py-1 bg-indigo-100 dark:bg-indigo-900/30 rounded-full flex items-center gap-1.5">
                <i data-lucide="hourglass" class="w-3 h-3 text-indigo-600 dark:text-indigo-400"></i>
                <span id="days-left-mobile" class="text-xs font-bold text-indigo-700 dark:text-indigo-300">-- days</span>
            </div>
            <button onclick="openSettings()" class="p-2 bg-white dark:bg-slate-800 rounded-xl text-slate-600 dark:text-slate-300 shadow-sm border border-slate-100 dark:border-slate-700 active:scale-95 transition-transform"><i data-lucide="settings" class="w-5 h-5"></i></button>
        </div>

        <!-- Calendar View -->
        <div id="view-container-calendar" class="view-section flex-1 flex flex-col h-full overflow-hidden">
            <div id="toolbar-calendar" class="px-4 md:px-6 py-4 md:py-6 flex items-center justify-between shrink-0">
                <div class="flex items-center gap-3 md:gap-4">
                    <div class="flex gap-1 bg-white dark:bg-slate-800 rounded-full p-1 border border-slate-200 dark:border-slate-700 shadow-sm">
                        <button onclick="changeMonth(-1)" class="p-2 md:p-1.5 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-full transition-colors active:scale-95"><i data-lucide="chevron-left" class="w-5 h-5 md:w-4 md:h-4"></i></button>
                        <button onclick="changeMonth(1)" class="p-2 md:p-1.5 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-full transition-colors active:scale-95"><i data-lucide="chevron-right" class="w-5 h-5 md:w-4 md:h-4"></i></button>
                    </div>
                    <h2 id="current-month-display" class="text-xl md:text-3xl font-black text-slate-800 dark:text-white tracking-tight">--</h2>
                </div>
                <button onclick="goToToday()" class="text-xs font-bold bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 px-4 py-2 rounded-full hover:bg-indigo-100 transition-colors shadow-sm flex items-center gap-2 active:scale-95"><i data-lucide="calendar" class="w-3 h-3"></i> Today</button>
            </div>
            
            <div class="flex-1 overflow-y-auto px-4 md:px-6 pb-24 md:pb-10 scroll-smooth custom-scrollbar no-scrollbar">
                <div id="calendar-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 md:gap-4 pb-20 md:pb-0"></div>
            </div>
        </div>

        <!-- Weekly Goals View -->
        <div id="view-container-weekly" class="view-section hidden flex-1 flex flex-col h-full overflow-hidden">
             <div class="px-4 md:px-6 py-4 md:py-6 shrink-0 bg-white/50 dark:bg-slate-900/50 backdrop-blur-sm border-b border-slate-200 dark:border-slate-800">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <div>
                        <h2 class="text-2xl font-black text-slate-800 dark:text-white tracking-tight flex items-center gap-2">Weekly Targets <span class="hidden md:inline-flex text-xs font-medium px-2 py-1 bg-amber-100 text-amber-700 rounded-full">High Priority</span></h2>
                        <!-- <p class="text-xs md:text-sm text-slate-500 dark:text-slate-400 mt-1">Focus on big chapters rather than small tasks.</p> -->
                    </div>
                    <div class="flex items-center gap-3 bg-white dark:bg-slate-800 p-1.5 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 self-start md:self-auto">
                        <button onclick="changeWeek(-1)" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-xl transition-colors active:scale-95"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
                        <div class="text-center min-w-[120px] md:min-w-[140px]">
                            <div class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Week Of</div>
                            <div id="weekly-date-range" class="text-sm font-bold text-slate-800 dark:text-white">--</div>
                        </div>
                        <button onclick="changeWeek(1)" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-xl transition-colors active:scale-95"><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
                    </div>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-4 md:p-6 custom-scrollbar no-scrollbar pb-24">
                <div class="max-w-4xl mx-auto space-y-6 md:space-y-8">
                    <!-- Progress Card -->
                    <div class="glass-card p-5 md:p-6 rounded-3xl flex items-center justify-between relative overflow-hidden">
                        <div class="relative z-10">
                            <div class="text-xs md:text-sm font-medium text-slate-500 dark:text-slate-400 mb-1">Weekly Progress</div>
                            <div id="weekly-progress-text" class="text-3xl md:text-4xl font-black text-indigo-600 dark:text-indigo-400">0%</div>
                            <p class="text-xs text-slate-400 mt-2" id="weekly-count-text">0/0 Targets Completed</p>
                        </div>
                        <div class="w-20 h-20 md:w-24 md:h-24 relative">
                            <svg class="w-full h-full transform -rotate-90"><circle cx="50%" cy="50%" r="40%" stroke="currentColor" stroke-width="8" fill="transparent" class="text-slate-100 dark:text-slate-700" /><circle id="weekly-ring" cx="50%" cy="50%" r="40%" stroke="currentColor" stroke-width="8" fill="transparent" stroke-dasharray="251.2" stroke-dashoffset="251.2" class="text-indigo-500 transition-all duration-1000 ease-out" stroke-linecap="round" /></svg>
                        </div>
                    </div>

                    <!-- Input -->
                    <div class="flex gap-2">
                        <input type="text" id="target-input" placeholder="e.g. Electrostatics + 50 PYQs" class="flex-1 bg-white dark:bg-slate-800 border-none shadow-soft rounded-2xl px-5 py-4 text-sm focus:ring-2 focus:ring-indigo-500/20 outline-none dark:text-white appearance-none">
                        <button onclick="addWeeklyTarget()" class="bg-slate-900 dark:bg-white text-white dark:text-slate-900 px-4 md:px-6 rounded-2xl font-bold shadow-lg active:scale-95 transition-transform flex items-center justify-center"><i data-lucide="plus" class="w-6 h-6 md:w-5 md:h-5"></i></button>
                    </div>

                    <!-- List -->
                    <div id="weekly-list" class="space-y-3 pb-20"></div>
                </div>
            </div>
        </div>

        <!-- Timer View (New) -->
        <div id="view-container-timer" class="view-section hidden flex-1 flex flex-col h-full overflow-hidden">
            <div class="flex-1 overflow-y-auto p-4 md:p-6 custom-scrollbar no-scrollbar">
                <div class="max-w-2xl mx-auto pb-24 space-y-6">
                    <!-- Main Timer Card -->
                    <div class="glass-card p-6 md:p-10 rounded-[2.5rem] text-center relative overflow-hidden">
                        <div class="absolute inset-0 bg-gradient-to-b from-indigo-500/5 to-transparent pointer-events-none"></div>
                        
                        <div class="mb-6">
                             <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2 block">Focus Subject</label>
                             <div id="timer-subject-selector" class="flex flex-wrap gap-2 justify-center">
                                 <!-- Injected via JS -->
                             </div>
                        </div>

                        <div class="relative w-80 h-80 md:w-96 md:h-96 mx-auto mb-8 flex items-center justify-center">
                            <div class="absolute inset-0 rounded-full border-4 border-slate-100 dark:border-slate-800"></div>
                            <div id="timer-active-ring" class="absolute inset-0 rounded-full border-4 border-indigo-500 border-t-transparent opacity-0 transition-opacity duration-300"></div>
                            
                            <div class="text-6xl md:text-7xl font-black text-slate-800 dark:text-white tabular-nums tracking-tighter" id="timer-display">
                                00:00:00
                            </div>
                        </div>

                        <div class="flex items-center justify-center gap-4">
                            <button id="btn-timer-toggle" onclick="toggleTimer()" class="w-16 h-16 rounded-2xl bg-indigo-600 hover:bg-indigo-700 text-white flex items-center justify-center shadow-lg shadow-indigo-500/30 active:scale-95 transition-all">
                                <i data-lucide="play" class="w-8 h-8 fill-current"></i>
                            </button>
                            <button id="btn-timer-stop" onclick="stopTimer()" disabled class="w-16 h-16 rounded-2xl bg-rose-50 dark:bg-rose-900/20 text-rose-500 disabled:opacity-50 disabled:cursor-not-allowed hover:bg-rose-100 dark:hover:bg-rose-900/40 flex items-center justify-center transition-all active:scale-95">
                                <i data-lucide="square" class="w-6 h-6 fill-current"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Stats Row -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="glass-card p-4 rounded-2xl flex items-center gap-3">
                            <div class="w-10 h-10 rounded-xl bg-orange-100 dark:bg-orange-900/30 flex items-center justify-center text-orange-600 dark:text-orange-400">
                                <i data-lucide="flame" class="w-5 h-5"></i>
                            </div>
                            <div>
                                <div class="text-[10px] font-bold text-slate-400 uppercase">Streak</div>
                                <div class="text-xl font-black text-slate-800 dark:text-white"><span id="streak-count">0</span> Days</div>
                            </div>
                        </div>
                        <div class="glass-card p-4 rounded-2xl flex items-center gap-3">
                            <div class="w-10 h-10 rounded-xl bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center text-blue-600 dark:text-blue-400">
                                <i data-lucide="clock" class="w-5 h-5"></i>
                            </div>
                            <div>
                                <div class="text-[10px] font-bold text-slate-400 uppercase">Today</div>
                                <div class="text-xl font-black text-slate-800 dark:text-white"><span id="today-total">0</span>m</div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Logs -->
                    <div>
                        <div class="flex items-center justify-between mb-3 px-1">
                            <h3 class="text-sm font-bold text-slate-700 dark:text-slate-300">Today's Logs</h3>
                            <button onclick="openManualLogModal()" class="text-xs font-bold text-indigo-500 hover:text-indigo-600 px-2 py-1 rounded bg-indigo-50 dark:bg-indigo-900/20">+ Add Manual Log</button>
                        </div>
                        <div id="timer-logs-list" class="space-y-3">
                            <!-- Logs injected here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats View -->
        <div id="view-container-stats" class="view-section hidden flex-1 overflow-y-auto p-4 md:p-6 custom-scrollbar no-scrollbar">
            <div class="max-w-5xl mx-auto pb-24">
                <h2 class="text-2xl font-black text-slate-900 dark:text-white mb-6 tracking-tight">Analytics</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4 mb-6 md:mb-8">
                    <div class="glass-card p-4 md:p-5 rounded-3xl"><div class="text-[10px] md:text-xs text-slate-500 uppercase font-bold tracking-wider mb-1">Tests Taken</div><div id="stats-total-tests" class="text-2xl md:text-3xl font-black text-slate-800 dark:text-white">0</div></div>
                    <div class="glass-card p-4 md:p-5 rounded-3xl"><div class="text-[10px] md:text-xs text-slate-500 uppercase font-bold tracking-wider mb-1">Avg Score</div><div id="stats-avg-score" class="text-2xl md:text-3xl font-black text-indigo-600 dark:text-indigo-400">0</div></div>
                    <div class="glass-card p-4 md:p-5 rounded-3xl"><div class="text-[10px] md:text-xs text-slate-500 uppercase font-bold tracking-wider mb-1">Best Score</div><div id="stats-max-score" class="text-2xl md:text-3xl font-black text-emerald-500">0</div></div>
                    <div class="glass-card p-4 md:p-5 rounded-3xl"><div class="text-[10px] md:text-xs text-slate-500 uppercase font-bold tracking-wider mb-1">Recent Trend</div><div id="stats-last-5" class="text-2xl md:text-3xl font-black text-purple-500">0</div></div>
                </div>
                
                <div class="glass-card p-4 md:p-8 rounded-[2rem] shadow-soft mb-8">
                    <div class="flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4">
                        <h3 class="text-sm font-bold text-slate-700 dark:text-slate-300">Mock Test History</h3>
                        <div id="chart-filters" class="flex flex-wrap gap-2"></div>
                    </div>
                    <div class="relative h-64 md:h-72 w-full">
                        <canvas id="mockChart"></canvas>
                    </div>
                </div>
                
                <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-4">Recent Logs</h3>
                <div id="mock-history-list" class="space-y-3 pb-12"></div>
            </div>
        </div>

        <!-- Syllabus View -->
        <div id="view-container-syllabus" class="view-section hidden flex-1 flex flex-col h-full overflow-hidden">
            <div class="flex-1 overflow-y-auto p-4 md:p-6 custom-scrollbar no-scrollbar">
                <div class="max-w-6xl mx-auto pb-24">
                    <div class="flex flex-col lg:flex-row gap-6">
                        <!-- Syllabus Sidebar: Overall Stats -->
                        <div class="w-full lg:w-80 shrink-0">
                            <div class="glass-card p-5 rounded-3xl sticky top-4">
                                <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-4">Syllabus Progress</h3>
                                <div id="overall-progress-data"></div>
                                
                                <div class="mt-6 pt-4 border-t border-slate-200 dark:border-slate-700">
                                    <div class="relative mb-3">
                                        <input type="text" id="syllabus-search" placeholder="Search chapters..." class="w-full pl-9 p-2.5 rounded-xl bg-slate-100 dark:bg-slate-700/50 text-slate-900 dark:text-white placeholder-slate-500 text-sm focus:ring-2 focus:ring-indigo-500/20 outline-none transition-all">
                                        <i data-lucide="search" class="w-4 h-4 absolute left-3 top-3 text-slate-400"></i>
                                    </div>
                                    <button id="btn-reset-syllabus" class="w-full py-2 text-xs font-bold text-rose-500 hover:bg-rose-50 dark:hover:bg-rose-900/20 rounded-lg transition-colors border border-rose-100 dark:border-rose-900/30">Reset Syllabus Data</button>
                                </div>
                            </div>
                        </div>

                        <!-- Syllabus Content -->
                        <div id="syllabus-content" class="flex-1 columns-1 lg:columns-2 gap-6 space-y-6">
                            <!-- Cards Injected Here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Floating Action Button (Mobile Only) -->
        <button onclick="openAddTaskModal()" class="md:hidden fixed bottom-24 right-5 w-14 h-14 bg-indigo-600 rounded-full text-white shadow-xl shadow-indigo-600/30 flex items-center justify-center z-40 active:scale-90 transition-transform">
            <i data-lucide="plus" class="w-8 h-8"></i>
        </button>

        <!-- Mobile Bottom Navigation -->
        <div id="mobile-bottom-nav" class="md:hidden fixed bottom-0 left-0 w-full glass border-t border-slate-200 dark:border-slate-800 z-50 mobile-bottom-nav">
            <div class="flex justify-around items-center h-16 px-1">
                <button onclick="switchView('calendar')" id="nav-mobile-calendar" class="flex flex-col items-center justify-center w-full h-full gap-1 text-indigo-600 dark:text-indigo-400">
                    <i data-lucide="calendar" class="w-5 h-5"></i>
                    <span class="text-[10px] font-bold">Planner</span>
                </button>
                <button onclick="switchView('weekly')" id="nav-mobile-weekly" class="flex flex-col items-center justify-center w-full h-full gap-1 text-slate-400 dark:text-slate-500">
                    <i data-lucide="crosshair" class="w-5 h-5"></i>
                    <span class="text-[10px] font-bold">Targets</span>
                </button>
                 <button onclick="switchView('timer')" id="nav-mobile-timer" class="flex flex-col items-center justify-center w-full h-full gap-1 text-slate-400 dark:text-slate-500">
                    <i data-lucide="timer" class="w-5 h-5"></i>
                    <span class="text-[10px] font-bold">Timer</span>
                </button>
                <button onclick="switchView('stats')" id="nav-mobile-stats" class="flex flex-col items-center justify-center w-full h-full gap-1 text-slate-400 dark:text-slate-500">
                    <i data-lucide="bar-chart-2" class="w-5 h-5"></i>
                    <span class="text-[10px] font-bold">Stats</span>
                </button>
                <button onclick="switchView('syllabus')" id="nav-mobile-syllabus" class="flex flex-col items-center justify-center w-full h-full gap-1 text-slate-400 dark:text-slate-500">
                    <i data-lucide="book-open" class="w-5 h-5"></i>
                    <span class="text-[10px] font-bold">Syllabus</span>
                </button>
            </div>
        </div>
        
    </main>

    <!-- Modals -->

    <!-- Manual Log Modal -->
    <div id="manual-log-modal" class="fixed inset-0 z-[120] flex items-center justify-center modal-backdrop hidden opacity-0 transition-opacity duration-200 px-4">
        <div class="bg-white dark:bg-slate-800 rounded-[2rem] shadow-2xl p-6 w-full max-w-sm transform scale-95 transition-transform duration-200 border border-slate-200 dark:border-slate-700">
            <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-4">Add Study Log</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">Subject</label>
                    <select id="manual-log-subject" class="w-full bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl px-3 py-2 text-sm outline-none dark:text-white">
                        <!-- Populated dynamically -->
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">Duration (Minutes)</label>
                    <input type="number" id="manual-log-duration" class="w-full bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl px-3 py-2 text-sm outline-none dark:text-white" placeholder="e.g. 60">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">Notes</label>
                    <textarea id="manual-log-notes" rows="2" class="w-full bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl px-3 py-2 text-sm outline-none dark:text-white" placeholder="Optional notes..."></textarea>
                </div>
            </div>
            <div class="flex gap-3 justify-end mt-6">
                <button onclick="closeManualLogModal()" class="px-4 py-2 rounded-xl text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-700/50 font-medium text-sm transition-colors">Cancel</button>
                <button onclick="saveManualLog()" class="px-6 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white font-bold text-sm shadow-lg shadow-indigo-500/20 transition-all">Save Log</button>
            </div>
        </div>
    </div>

    <!-- Add Task Modal (Bottom Sheet on Mobile, Centered on Desktop) -->
    <div id="add-task-modal" class="fixed inset-0 z-[100] flex items-end md:items-center justify-center modal-backdrop hidden opacity-0 transition-opacity duration-300">
        <div class="bg-white dark:bg-slate-900 w-full md:w-[450px] md:rounded-[2rem] mobile-sheet md:transform md:scale-95 transition-transform duration-300 shadow-2xl h-[75vh] md:h-[80vh] border-t md:border border-slate-200 dark:border-slate-800 flex flex-col relative">
            <div class="md:hidden pt-3 pb-1" id="add-task-drag-handle">
                <div class="drag-handle"></div>
            </div>
            <div class="p-6 md:p-8 flex-1 overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-slate-900 dark:text-white flex items-center gap-2"><i data-lucide="plus-square" class="w-5 h-5 text-indigo-500"></i> Add New Task</h2>
                    <button onclick="closeAddTaskModal()" class="p-2 bg-slate-100 dark:bg-slate-800 rounded-full text-slate-400 hover:text-rose-500 transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>

                <form id="add-task-form-mobile" class="space-y-4">
                    <input type="date" id="task-date-mobile" class="w-full bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-4 text-base focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 outline-none dark:text-white transition-all appearance-none">
                    
                    <div>
                        <div class="flex justify-between items-center mb-3">
                             <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase">Subject</label>
                             <button type="button" onclick="openCustomSubjectModal()" class="text-[10px] font-bold text-indigo-500 bg-indigo-50 dark:bg-indigo-900/20 px-2 py-1 rounded-md border border-indigo-100 dark:border-indigo-900/50">+ Custom</button>
                        </div>
                        <div id="subject-selector-mobile" class="grid grid-cols-2 gap-3"></div>
                    </div>
                    
                    <!-- Dynamic Mock Fields -->
                    <div id="mock-fields-container-mobile" class="hidden animate-slide-up space-y-3 p-4 bg-purple-50 dark:bg-purple-900/10 rounded-2xl border border-purple-100 dark:border-purple-900/30">
                        <div class="flex items-center gap-2 mb-1 text-purple-700 dark:text-purple-300">
                            <i data-lucide="trophy" class="w-4 h-4"></i>
                            <span class="text-xs font-bold">Score (Optional)</span>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-[10px] font-bold text-purple-600 dark:text-purple-400 mb-1 uppercase">Obtained</label>
                                <input type="number" id="task-marks-mobile" placeholder="--" class="w-full bg-white dark:bg-slate-800 border border-purple-200 dark:border-slate-600 rounded-xl px-3 py-3 text-base outline-none dark:text-white font-bold text-purple-600 focus:ring-2 focus:ring-purple-500 text-center appearance-none">
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-purple-600 dark:text-purple-400 mb-1 uppercase">Total</label>
                                <input type="number" id="task-max-marks-mobile" placeholder="300" class="w-full bg-white dark:bg-slate-800 border border-purple-200 dark:border-slate-600 rounded-xl px-3 py-3 text-base outline-none dark:text-white font-bold text-purple-600 focus:ring-2 focus:ring-purple-500 text-center appearance-none">
                            </div>
                        </div>
                    </div>

                    <textarea id="task-input-mobile" rows="3" placeholder="What's the goal?" class="w-full bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 text-base focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 outline-none dark:text-white resize-none transition-all appearance-none"></textarea>
                    
                    <button id="btn-add-task-mobile" type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-xl shadow-lg shadow-indigo-500/20 transition-all active:scale-95 flex items-center justify-center gap-2 text-lg mt-4">
                        <i data-lucide="plus" class="w-6 h-6"></i> <span>Add to Plan</span>
                    </button>
                    <div class="h-10 md:hidden"></div> <!-- Spacer for mobile bottom nav -->
                </form>
            </div>
        </div>
    </div>

    <!-- Day View Modal -->
    <div id="day-view-modal" class="fixed inset-0 z-[110] flex items-end md:items-center justify-center modal-backdrop hidden opacity-0 transition-opacity duration-300">
        <div class="bg-white dark:bg-slate-900 w-full md:w-[450px] md:rounded-[2rem] mobile-sheet md:transform md:scale-95 transition-transform duration-300 shadow-2xl h-[75vh] md:h-auto md:max-h-[85vh] border-t md:border border-slate-200 dark:border-slate-800 flex flex-col relative overflow-hidden">
            <div class="md:hidden pt-3 pb-1" id="day-view-drag-handle">
                <div class="drag-handle"></div>
            </div>
            <div class="p-6 md:p-8 flex flex-col h-full overflow-hidden">
                <div class="flex justify-between items-start mb-6">
                    <div><h2 id="day-view-date" class="text-2xl md:text-3xl font-black text-slate-900 dark:text-white tracking-tight">--</h2><p class="text-sm text-slate-500 font-medium">Your daily focus</p></div>
                    <button onclick="closeDayView()" class="p-2 bg-slate-100 dark:bg-slate-800 rounded-full text-slate-400 hover:text-rose-500 transition-colors"><i data-lucide="x" class="w-6 h-6"></i></button>
                </div>
                <div id="day-view-tasks" class="space-y-3 overflow-y-auto pr-2 custom-scrollbar flex-1 min-h-0 touch-pan-y"></div>
                <button onclick="addTaskFromDayView()" class="w-full py-4 mt-4 bg-indigo-50 dark:bg-indigo-900/20 text-indigo-600 dark:text-indigo-400 font-bold rounded-2xl flex items-center justify-center gap-2 active:scale-95 transition-transform border border-indigo-100 dark:border-indigo-900/50">
                    <i data-lucide="plus" class="w-5 h-5"></i> Add Task for this Day
                </button>
                <div class="h-6 md:hidden"></div>
            </div>
        </div>
    </div>

    <!-- Custom Subject Modal -->
    <div id="custom-subject-modal" class="fixed inset-0 z-[120] flex items-center justify-center modal-backdrop hidden opacity-0 transition-opacity duration-200 px-4">
        <div class="bg-white dark:bg-slate-800 rounded-[2rem] shadow-2xl p-6 w-full max-w-sm transform scale-95 transition-transform duration-200 border border-slate-200 dark:border-slate-700">
            <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-4">Manage Subjects</h3>
            
            <input type="text" id="custom-subject-input" placeholder="New Subject Name (e.g. History)" class="w-full bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl px-4 py-3 text-base focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 outline-none dark:text-white mb-3 appearance-none">
            
            <div class="flex gap-3 justify-end mb-6">
                <button onclick="closeCustomSubjectModal()" class="px-4 py-2 rounded-xl text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-700/50 font-medium text-sm transition-colors">Cancel</button>
                <button onclick="confirmAddSubject()" class="px-6 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white font-bold text-sm shadow-lg shadow-indigo-500/20 transition-all">Add</button>
            </div>

            <div class="border-t border-slate-100 dark:border-slate-700 pt-4">
                <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Your Custom Subjects</label>
                <div id="custom-subjects-list" class="space-y-2 max-h-[150px] overflow-y-auto custom-scrollbar pr-1">
                    </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 z-[110] flex items-end md:items-center justify-center modal-backdrop hidden opacity-0 transition-opacity duration-200">
        <div class="bg-white dark:bg-slate-800 w-full md:w-[480px] md:rounded-[2rem] mobile-sheet md:transform md:scale-95 transition-transform duration-200 border-t md:border border-slate-200 dark:border-slate-700 h-[85vh] flex flex-col">
            <!-- Modal Header -->
            <div class="p-6 pb-2 shrink-0 flex justify-between items-center">
                <h3 class="text-xl font-bold text-slate-900 dark:text-white">Settings</h3>
                <button onclick="closeSettings()" class="text-slate-400 hover:text-slate-600 p-2"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            
            <!-- Modal Body (Scrollable) -->
            <div class="p-6 pt-2 space-y-6 flex-1 overflow-y-auto custom-scrollbar">
                
                <div class="p-4 bg-slate-50 dark:bg-slate-700/30 rounded-2xl flex items-center justify-between border border-transparent dark:border-slate-700">
                    <span class="font-medium text-slate-700 dark:text-slate-200">Dark Mode</span>
                    <button id="theme-toggle" onclick="toggleTheme()" class="relative w-12 h-7 bg-slate-200 dark:bg-slate-600 rounded-full transition-all duration-300"><div id="theme-knob" class="absolute left-1 top-1 w-5 h-5 bg-white rounded-full transition-transform shadow-sm"></div></button>
                </div>
                
                <!-- Toggle for Countdown -->
                <div class="p-4 bg-slate-50 dark:bg-slate-700/30 rounded-2xl flex items-center justify-between border border-transparent dark:border-slate-700">
                    <span class="font-medium text-slate-700 dark:text-slate-200">Show Countdown</span>
                    <button id="countdown-toggle" onclick="toggleCountdownSetting()" class="relative w-12 h-7 bg-slate-200 dark:bg-slate-600 rounded-full transition-all duration-300"><div id="countdown-knob" class="absolute left-1 top-1 w-5 h-5 bg-white rounded-full transition-transform shadow-sm"></div></button>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Background</label>
                    <div class="flex gap-2 mb-3 overflow-x-auto pb-2 scrollbar-hide no-scrollbar -mx-2 px-2">
                        <button onclick="setPresetBg('')" class="shrink-0 px-4 py-3 rounded-xl bg-slate-100 text-xs font-bold text-slate-600 border border-transparent hover:border-indigo-500 transition-all">None</button>
                        <button onclick="setPresetBg('https://images.unsplash.com/photo-1494438639946-1ebd1d20bf85?auto=format&fit=crop&w=1920&q=80')" class="shrink-0 px-4 py-3 rounded-xl bg-indigo-50 text-xs font-bold text-indigo-700 border border-transparent hover:border-indigo-500 transition-all">Minimal</button>
                        <button onclick="setPresetBg('https://images.unsplash.com/photo-1451187580459-43490279c0fa?auto=format&fit=crop&w=1920&q=80')" class="shrink-0 px-4 py-3 rounded-xl bg-slate-800 text-xs font-bold text-white border border-transparent hover:border-indigo-500 transition-all">Space</button>
                        <button onclick="setPresetBg('https://images.unsplash.com/photo-1472214103451-9374bd1c798e?auto=format&fit=crop&w=1920&q=80')" class="shrink-0 px-4 py-3 rounded-xl bg-emerald-100 text-xs font-bold text-emerald-800 border border-transparent hover:border-emerald-500 transition-all">Nature</button>
                        <button onclick="setPresetBg('https://images.unsplash.com/photo-1550751827-4bd374c3f58b?auto=format&fit=crop&w=1920&q=80')" class="shrink-0 px-4 py-3 rounded-xl bg-fuchsia-100 text-xs font-bold text-fuchsia-800 border border-transparent hover:border-fuchsia-500 transition-all">Cyber</button>
                        <button onclick="setPresetBg('https://images.unsplash.com/photo-1472120435266-53107fd0c44a?auto=format&fit=crop&w=1920&q=80')" class="shrink-0 px-4 py-3 rounded-xl bg-amber-100 text-xs font-bold text-amber-800 border border-transparent hover:border-amber-500 transition-all">Sunset</button>
                        <button onclick="setPresetBg('https://images.unsplash.com/photo-1541701494587-cb58502866ab?auto=format&fit=crop&w=1920&q=80')" class="shrink-0 px-4 py-3 rounded-xl bg-sky-100 text-xs font-bold text-sky-800 border border-transparent hover:border-sky-500 transition-all">Abstract</button>
                    </div>
                    <input type="text" id="settings-bg-url" oninput="markSettingsDirty()" placeholder="Custom Image URL..." class="w-full bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl px-4 py-3 text-sm outline-none dark:text-white appearance-none">
                </div>
                <hr class="border-slate-100 dark:border-slate-700">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Exam Target</label>
                    <div class="grid grid-cols-2 gap-2 mb-3">
                        <button onclick="setExamType('JEE Main')" id="btn-jee" class="p-3 rounded-xl text-xs font-bold border hover:bg-indigo-50 transition-colors">JEE Main</button>
                        <button onclick="setExamType('NEET')" id="btn-neet" class="p-3 rounded-xl text-xs font-bold border hover:bg-indigo-50 transition-colors">NEET</button>
                        <button onclick="setExamType('JEE Advanced')" id="btn-jeeadv" class="p-3 rounded-xl text-xs font-bold border hover:bg-indigo-50 transition-colors">JEE Adv</button>
                        <button onclick="setExamType('Custom')" id="btn-custom" class="p-3 rounded-xl text-xs font-bold border hover:bg-indigo-50 transition-colors">Custom</button>
                    </div>
                    
                    <!-- JEE Main Sessions Container -->
                    <div id="jee-session-container" class="hidden mb-3 bg-indigo-50 dark:bg-indigo-900/10 p-3 rounded-xl border border-indigo-100 dark:border-indigo-900/30 animate-slide-up">
                        <label class="block text-[10px] font-bold text-indigo-700 dark:text-indigo-300 uppercase mb-2">Target Session</label>
                        <div class="flex gap-2">
                            <button onclick="setSession('Jan')" id="btn-session-jan" class="flex-1 py-2 rounded-lg text-xs font-bold border transition-colors">Jan (21st)</button>
                            <button onclick="setSession('Apr')" id="btn-session-apr" class="flex-1 py-2 rounded-lg text-xs font-bold border transition-colors">April</button>
                        </div>
                    </div>
                    <div id="custom-date-container" class="hidden mb-3 bg-slate-50 dark:bg-slate-700/30 p-3 rounded-xl border border-slate-200 dark:border-slate-700 animate-slide-up">
                        <label class="block text-[10px] font-bold text-slate-500 uppercase mb-2">Manual Target Date</label>
                        <input type="date" id="settings-custom-date" onchange="markSettingsDirty()" class="w-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg px-3 py-2 text-sm outline-none dark:text-white">
                    </div>
                    <select id="settings-year" onchange="updateTargetDateConfig(); markSettingsDirty()" class="w-full bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl px-4 py-3 text-sm outline-none dark:text-white appearance-none">
                        <option value="2026">2026</option>
                        <option value="2027">2027</option>
                        <option value="2028">2028</option>
                    </select>
                </div>
                
                <hr class="border-slate-100 dark:border-slate-700">
                <button onclick="handleSignOut()" class="w-full py-4 text-rose-500 font-bold bg-rose-50 dark:bg-rose-900/20 rounded-2xl flex items-center justify-center gap-2 border border-rose-100 dark:border-rose-900/50 active:scale-95 transition-transform"><i data-lucide="log-out" class="w-5 h-5"></i> Sign Out</button>
                <div class="h-10 md:hidden"></div>
            </div>

            <!-- Sticky Footer for Save Action -->
            <div class="p-6 border-t border-slate-100 dark:border-slate-700 bg-white dark:bg-slate-800 shrink-0 mb-safe">
                <div id="unsaved-changes-indicator" class="hidden flex items-center gap-2 mb-3 text-amber-500 dark:text-amber-400 text-xs font-bold justify-center animate-bounce-slight">
                    <i data-lucide="alert-circle" class="w-3 h-3"></i> Unsaved Changes
                </div>
                <button id="save-settings-btn" onclick="saveSettings()" class="w-full bg-slate-900 dark:bg-slate-700 text-white dark:text-slate-200 font-bold py-4 rounded-xl shadow-lg transition-all active:scale-95">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirm-modal" class="fixed inset-0 z-[120] flex items-center justify-center modal-backdrop hidden opacity-0 transition-opacity duration-200 px-4">
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-6 w-full max-w-sm transform scale-95 transition-transform duration-200">
            <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-2">Delete Item?</h3>
            <p class="text-slate-500 text-sm mb-6">This action cannot be undone.</p>
            <div class="flex gap-3 justify-end"><button onclick="closeConfirmModal()" class="px-4 py-2 rounded-lg text-slate-600 hover:bg-slate-100 font-medium">Cancel</button><button id="confirm-delete-btn" class="px-4 py-2 rounded-lg bg-rose-500 text-white font-medium shadow-lg shadow-rose-500/30">Delete</button></div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed top-6 md:top-auto md:bottom-6 left-1/2 md:left-auto md:right-6 transform -translate-x-1/2 md:translate-x-0 bg-slate-900 dark:bg-white text-white dark:text-slate-900 text-sm font-bold px-6 py-3 rounded-full md:rounded-xl shadow-2xl opacity-0 translate-y-[-20px] md:translate-y-4 transition-all duration-300 pointer-events-none flex items-center gap-2 z-[150]">
        <i data-lucide="check-circle" class="w-4 h-4 text-green-400 dark:text-green-600"></i><span id="toast-msg">Success</span>
    </div>

    <div id="edit-mock-modal" class="fixed inset-0 z-[130] flex items-center justify-center modal-backdrop hidden opacity-0 transition-opacity duration-200 px-4">
        <div class="bg-white dark:bg-slate-800 rounded-[2rem] shadow-2xl p-6 w-full max-w-sm transform scale-95 transition-transform duration-200 border border-slate-200 dark:border-slate-700">
            <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-1">Edit Score Breakdown</h3>
            <p class="text-xs text-slate-500 mb-4" id="edit-mock-title">Update subject marks</p>
            
            <input type="hidden" id="edit-mock-id">

            <div id="edit-mock-inputs" class="grid grid-cols-3 gap-3 mb-4">
                </div>

            <div class="bg-indigo-50 dark:bg-indigo-900/20 p-3 rounded-xl flex justify-between items-center mb-6">
                <span class="text-xs font-bold text-indigo-900 dark:text-indigo-300 uppercase">Total Score</span>
                <span id="edit-mock-total" class="text-xl font-black text-indigo-600 dark:text-indigo-400">0</span>
            </div>

            <div class="flex gap-3 justify-end">
                <button onclick="closeEditMockModal()" class="px-4 py-2 rounded-xl text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-700/50 font-medium text-sm transition-colors">Cancel</button>
                <button onclick="saveMockBreakdown()" class="px-6 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white font-bold text-sm shadow-lg shadow-indigo-500/20 transition-all">Update</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, updateDoc, deleteDoc, enableIndexedDbPersistence, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CONFIG
        const firebaseConfig = { apiKey: "AIzaSyAO9ya8gHtVbMfxcnAAJrz6FdYWvIRqgBY", authDomain: "studydashboard-2a3eb.firebaseapp.com", projectId: "studydashboard-2a3eb", storageBucket: "studydashboard-2a3eb.firebasestorage.app", messagingSenderId: "79210973277", appId: "1:79210973277:web:cc0a5fa86729fd6d3f65b4" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        enableIndexedDbPersistence(db).catch(err => console.log(err.code));

        // STATE
        let currentUser = null;
        let mockChartInstance = null;
        let itemToDelete = null;
        let draggedTaskId = null; 
        let currentDayViewDate = null; 
        let isSettingsDirty = false;
        
        let timerInterval = null;
        let timerSeconds = 0;
        let isTimerRunning = false;
        let timerSubject = "Physics"; // Default
        
        let state = {
            tasks: [],
            targets: [], // Weekly targets
            studyLogs: [], // New Study Logs
            viewDate: new Date(),
            weeklyViewDate: new Date(),
            currentView: 'calendar',
            settings: { examType: 'JEE Main', session: 'Jan', targetYear: 2026, targetDate: '2026-01-21', customSubjects: [], theme: 'light', bgUrl: '', showCountdown: true },
            syllabusData: { status: {}, meta: {} },
            syllabusOpenStates: {} // Local UI state
        };
        let tempSettings = {};

        // Syllabus DB
        const syllabus = [
            { subject: "Physics", units: [
                { unitName: "Mechanics I", chapters: [{ id: "PHY_B_11", name: "Motion In One Dimension", priority: 'B' }, { id: "PHY_D_01", name: "Motion In Two Dimensions", priority: 'D' }, { id: "PHY_B_10", name: "Laws of Motion", priority: 'B' }, { id: "PHY_B_07", name: "Work Power Energy", priority: 'B' }, { id: "PHY_D_05", name: "Center of Mass Momentum", priority: 'D' }, { id: "PHY_B_03", name: "Rotational Motion", priority: 'B' }] },
                { unitName: "Mechanics II & Waves", chapters: [{ id: "PHY_B_04", name: "Gravitation", priority: 'B' }, { id: "PHY_D_02", name: "Mechanical Properties of Solids", priority: 'D' }, { id: "PHY_B_05", name: "Mechanical Properties of Fluids", priority: 'B' }, { id: "PHY_C_06", name: "Oscillations", priority: 'C' }, { id: "PHY_D_03", name: "Waves and Sound", priority: 'D' }] },
                { unitName: "Thermodynamics", chapters: [{ id: "PHY_D_06", name: "Thermal Properties", priority: 'D' }, { id: "PHY_A_05", name: "Thermodynamics", priority: 'A' }, { id: "PHY_C_05", name: "Kinetic Theory of Gases", priority: 'C' }] },
                { unitName: "Electromagnetism", chapters: [{ id: "PHY_A_02", name: "Electrostatics", priority: 'A' }, { id: "PHY_C_02", name: "Capacitance", priority: 'C' }, { id: "PHY_A_01", name: "Current Electricity", priority: 'A' }, { id: "PHY_A_04", name: "Magnetic Effects of Current", priority: 'A' }, { id: "PHY_D_07", name: "Magnetism & Matter", priority: 'D' }, { id: "PHY_C_03", name: "EMI", priority: 'C' }, { id: "PHY_C_01", name: "Alternating Current", priority: 'C' }, { id: "PHY_C_07", name: "EM Waves", priority: 'C' }] },
                { unitName: "Optics & Modern", chapters: [{ id: "PHY_A_03", name: "Ray Optics", priority: 'A' }, { id: "PHY_B_09", name: "Wave Optics", priority: 'B' }, { id: "PHY_A_06", name: "Dual Nature of Matter", priority: 'A' }, { id: "PHY_A_07", name: "Atoms", priority: 'A' }, { id: "PHY_C_04", name: "Nuclei", priority: 'C' }, { id: "PHY_B_06", name: "Semiconductors", priority: 'B' }] },
                { unitName: "Experimental", chapters: [{ id: "PHY_B_08", name: "Units and Dimensions", priority: 'B' }, { id: "PHY_D_08", name: "Experimental Physics", priority: 'D' }] }
            ]},
            { subject: "Chemistry", units: [
                { unitName: "Physical Chem", chapters: [{ id: "CHE_C_01", name: "Mole Concept", priority: 'C' }, { id: "CHE_B_01", name: "Structure of Atom", priority: 'B' }, { id: "CHE_A_03", name: "Chemical Bonding", priority: 'A' }, { id: "CHE_A_05", name: "Thermodynamics", priority: 'A' }, { id: "CHE_D_05", name: "Chemical Equilibrium", priority: 'D' }, { id: "CHE_D_03", name: "Ionic Equilibrium", priority: 'D' }, { id: "CHE_B_02", name: "Solutions", priority: 'B' }, { id: "CHE_D_04", name: "Redox Reactions", priority: 'D' }, { id: "CHE_A_06", name: "Electrochemistry", priority: 'A' }, { id: "CHE_B_06", name: "Chemical Kinetics", priority: 'B' }] },
                { unitName: "Inorganic Chem", chapters: [{ id: "CHE_C_03", name: "Periodic Table", priority: 'C' }, { id: "CHE_B_05", name: "p-Block Elements", priority: 'B' }, { id: "CHE_A_04", name: "d and f Block", priority: 'A' }, { id: "CHE_A_02", name: "Coordination Compounds", priority: 'A' }, { id: "CHE_C_06", name: "Salt Analysis", priority: 'C' }] },
                { unitName: "Organic Chem", chapters: [{ id: "CHE_A_01", name: "GOC", priority: 'A' }, { id: "CHE_B_03", name: "Hydrocarbons", priority: 'B' }, { id: "CHE_C_04", name: "Haloalkanes/Haloarenes", priority: 'C' }, { id: "CHE_C_05", name: "Alcohols, Phenols, Ethers", priority: 'C' }, { id: "CHE_C_02", name: "Aldehydes & Ketones", priority: 'C' }, { id: "CHE_D_02", name: "Carboxylic Acids", priority: 'D' }, { id: "CHE_B_04", name: "Amines", priority: 'B' }, { id: "CHE_B_07", name: "Biomolecules", priority: 'B' }] }
            ]},
            { subject: "Mathematics", units: [
                { unitName: "Algebra", chapters: [{ id: "MAT_B_07", name: "Sets and Relations", priority: 'B' }, { id: "MAT_B_08", name: "Quadratic Equation", priority: 'B' }, { id: "MAT_B_05", name: "Complex Number", priority: 'B' }, { id: "MAT_A_03", name: "Matrices Determinants", priority: 'A' }, { id: "MAT_B_02", name: "Permutation Combination", priority: 'B' }, { id: "MAT_A_07", name: "Binomial Theorem", priority: 'A' }, { id: "MAT_A_02", name: "Sequence and Series", priority: 'A' }, { id: "MAT_B_01", name: "Probability", priority: 'B' }] },
                { unitName: "Calculus", chapters: [{ id: "MAT_A_06", name: "Functions", priority: 'A' }, { id: "MAT_C_03", name: "Limits", priority: 'C' }, { id: "MAT_C_06", name: "Continuity & Diff.", priority: 'C' }, { id: "MAT_D_04", name: "Differentiation", priority: 'D' }, { id: "MAT_B_06", name: "AOD", priority: 'B' }, { id: "MAT_D_02", name: "Indefinite Integration", priority: 'D' }, { id: "MAT_A_05", name: "Definite Integration", priority: 'A' }, { id: "MAT_B_04", name: "Area Under Curves", priority: 'B' }, { id: "MAT_A_08", name: "Differential Equations", priority: 'A' }] },
                { unitName: "Coordinate & Vectors", chapters: [{ id: "MAT_B_03", name: "Straight Lines", priority: 'B' }, { id: "MAT_C_01", name: "Circle", priority: 'C' }, { id: "MAT_C_04", name: "Parabola", priority: 'C' }, { id: "MAT_C_07", name: "Ellipse", priority: 'C' }, { id: "MAT_C_05", name: "Hyperbola", priority: 'C' }, { id: "MAT_A_01", name: "3D Geometry", priority: 'A' }, { id: "MAT_A_04", name: "Vector Algebra", priority: 'A' }] },
                { unitName: "Trigonometry & Stats", chapters: [{ id: "MAT_D_05", name: "Trig Ratios & Identities", priority: 'D' }, { id: "MAT_D_03", name: "Trig Equations", priority: 'D' }, { id: "MAT_D_01", name: "ITF", priority: 'D' }, { id: "MAT_C_02", name: "Statistics", priority: 'C' }] }
            ]},
            { subject: "Biology", units: [
                { unitName: "Diversity & Structure", chapters: [{id: "BIO_A_01", name: "Living World", priority: "A"}, {id: "BIO_A_02", name: "Biological Classification", priority: "A"}, {id: "BIO_A_03", name: "Plant Kingdom", priority: "A"}, {id: "BIO_A_04", name: "Animal Kingdom", priority: "A"}, {id: "BIO_A_05", name: "Morphology of Flowering Plants", priority: "A"}, {id: "BIO_A_06", name: "Anatomy of Flowering Plants", priority: "A"}, {id: "BIO_A_07", name: "Structural Org in Animals", priority: "A"}] },
                { unitName: "Cell Structure & Function", chapters: [{id: "BIO_B_01", name: "Cell: The Unit of Life", priority: "B"}, {id: "BIO_B_02", name: "Biomolecules", priority: "B"}, {id: "BIO_B_03", name: "Cell Cycle and Cell Division", priority: "B"}] },
                { unitName: "Plant Physiology", chapters: [{id: "BIO_C_01", name: "Photosynthesis", priority: "C"}, {id: "BIO_C_02", name: "Respiration in Plants", priority: "C"}, {id: "BIO_C_03", name: "Plant Growth & Development", priority: "C"}] },
                { unitName: "Human Physiology", chapters: [{id: "BIO_D_01", name: "Breathing & Exchange", priority: "D"}, {id: "BIO_D_02", name: "Body Fluids & Circulation", priority: "D"}, {id: "BIO_D_03", name: "Excretory Products", priority: "D"}, {id: "BIO_D_04", name: "Locomotion & Movement", priority: "D"}, {id: "BIO_D_05", name: "Neural Control", priority: "D"}, {id: "BIO_D_06", name: "Chemical Coordination", priority: "D"}] },
                { unitName: "Reproduction & Genetics", chapters: [{id: "BIO_E_01", name: "Sexual Repr. in Flowering Plants", priority: "A"}, {id: "BIO_E_02", name: "Human Reproduction", priority: "A"}, {id: "BIO_E_03", name: "Reproductive Health", priority: "A"}, {id: "BIO_E_04", name: "Principles of Inheritance", priority: "A"}, {id: "BIO_E_05", name: "Molecular Basis of Inheritance", priority: "A"}, {id: "BIO_E_06", name: "Evolution", priority: "B"}] },
                { unitName: "Biology in Human Welfare", chapters: [{id: "BIO_F_01", name: "Human Health & Disease", priority: "B"}, {id: "BIO_F_02", name: "Microbes in Human Welfare", priority: "C"}] },
                { unitName: "Biotech & Ecology", chapters: [{id: "BIO_G_01", name: "Biotech: Principles", priority: "A"}, {id: "BIO_G_02", name: "Biotech: Applications", priority: "A"}, {id: "BIO_G_03", name: "Organisms & Populations", priority: "B"}, {id: "BIO_G_04", name: "Ecosystem", priority: "B"}, {id: "BIO_G_05", name: "Biodiversity", priority: "B"}] }
            ]}
        ];

        // Subject Styles (Pastel/Modern)
        const subjectColors = {
            Physics: { light: 'bg-rose-50 text-rose-700 border-rose-200', dark: 'dark:bg-rose-900/30 dark:text-rose-300 dark:border-rose-800' },
            Chemistry: { light: 'bg-amber-50 text-amber-700 border-amber-200', dark: 'dark:bg-amber-900/30 dark:text-amber-300 dark:border-amber-800' },
            Maths: { light: 'bg-blue-50 text-blue-700 border-blue-200', dark: 'dark:bg-blue-900/30 dark:text-blue-300 dark:border-blue-800' },
            Biology: { light: 'bg-emerald-50 text-emerald-700 border-emerald-200', dark: 'dark:bg-emerald-900/30 dark:text-emerald-300 dark:border-emerald-800' },
            MockTest: { light: 'bg-purple-50 text-purple-700 border-purple-200 font-bold', dark: 'dark:bg-purple-900/30 dark:text-purple-300 dark:border-purple-800 font-bold' },
            Custom: { light: 'bg-teal-50 text-teal-700 border-teal-200', dark: 'dark:bg-teal-900/30 dark:text-teal-300 dark:border-teal-800' }
        };

        const syllabusStatusConfig = {
            'not-started': { text: 'To Do', color: 'text-slate-500', bg: 'bg-slate-100 dark:bg-slate-800', border: 'border-slate-200 dark:border-slate-700', weight: 0, dot: 'dot-neutral' },
            'in-progress': { text: 'Doing', color: 'text-yellow-600 dark:text-yellow-400', bg: 'bg-yellow-50 dark:bg-yellow-900/20', border: 'border-yellow-200 dark:border-yellow-800', weight: 0.5, dot: 'dot-yellow' },
            'completed': { text: 'Done', color: 'text-green-600 dark:text-green-400', bg: 'bg-green-50 dark:bg-green-900/20', border: 'border-green-200 dark:border-green-800', weight: 1, dot: 'dot-green' },
            'mastered': { text: 'Mastered', color: 'text-indigo-600 dark:text-indigo-400', bg: 'bg-indigo-50 dark:bg-indigo-900/20', border: 'border-indigo-200 dark:border-indigo-800', weight: 1, dot: 'dot-indigo' }
        };

        // --- AUTH ---
        async function initAuth() {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
            onAuthStateChanged(auth, (user) => {
                if (user) { 
                    currentUser = user; 
                    updateProfileUI(user);
                    setupListeners(user); 
                    toggleAppVisibility(true);
                    document.getElementById('login-screen').classList.add('hidden');
                } else { 
                    toggleAppVisibility(false);
                    document.getElementById('loading-overlay').classList.add('opacity-0', 'pointer-events-none');
                    document.getElementById('login-screen').classList.remove('hidden'); 
                }
            });
            // Initialize Interactions
            setupKeyboardShortcuts();
            setupTouchGestures();
        }

        function toggleAppVisibility(show) {
            const sidebar = document.getElementById('desktop-sidebar');
            const main = document.querySelector('main');
            if(show) {
                // Remove inline style to revert to CSS classes (flex/hidden based on media query)
                sidebar.style.display = ''; 
                main.style.display = '';
            } else {
                sidebar.style.display = 'none';
                main.style.display = 'none';
            }
        }

        function updateProfileUI(user) {
            // Desktop
            document.getElementById('user-email-desktop').innerText = user.email;
            document.getElementById('user-name-desktop').innerText = user.displayName || "Aspirant";
            if(user.photoURL) document.getElementById('user-avatar-desktop').innerHTML = `<img src="${user.photoURL}" class="w-full h-full rounded-full object-cover">`;
        }

        window.signInWithGoogle = async () => { const provider = new GoogleAuthProvider(); await signInWithPopup(auth, provider).catch(console.error); };
        window.handleSignOut = async () => { await signOut(auth); window.location.reload(); };

        // --- FIRESTORE LISTENERS ---
        function setupListeners(user) {
            // Settings
            onSnapshot(doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'config'), (snap) => {
                if(snap.exists()) {
                    state.settings = { ...state.settings, ...snap.data() };
                    if (state.settings.showCountdown === undefined) state.settings.showCountdown = true;
                    
                    applyTheme(state.settings.theme);
                    applyBackground(state.settings.bgUrl);
                    updateSubjectSelectors(); 
                    renderCountdown();
                    if(state.currentView === 'calendar') renderCalendar();
                    if(state.currentView === 'syllabus') renderSyllabusView(); 
                    if(state.currentView === 'timer') { updateSubjectSelectors(); updateTimerStats(); }
                } else setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'config'), state.settings);
                document.getElementById('loading-overlay').classList.add('opacity-0', 'pointer-events-none');
            });

            // Tasks
            onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'tasks'), (snap) => {
                state.tasks = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                if(state.currentView === 'calendar') renderCalendar();
                if(state.currentView === 'stats') renderMockStats();
                updateStats();
                
                // Refresh modal if open
                if(currentDayViewDate && !document.getElementById('day-view-modal').classList.contains('hidden')) {
                    openDayView(currentDayViewDate);
                }
            });

            // Weekly Targets
            onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'weeklyTargets'), (snap) => {
                state.targets = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                if(state.currentView === 'weekly') renderWeeklyView();
            });
            
            // Study Logs (New)
            onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'studyLogs'), (snap) => {
                state.studyLogs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                if(state.currentView === 'timer') {
                    renderRecentLogs();
                    updateTimerStats();
                }
            });

            // Syllabus Data (Single Document for Efficiency)
            onSnapshot(doc(db, 'artifacts', appId, 'users', user.uid, 'syllabus', 'progress'), (snap) => {
                if(snap.exists()) {
                    state.syllabusData = snap.data();
                    if(!state.syllabusData.status) state.syllabusData.status = {};
                    if(!state.syllabusData.meta) state.syllabusData.meta = {};
                } else {
                    state.syllabusData = { status: {}, meta: {} };
                }
                
                if(state.currentView === 'syllabus') renderSyllabusView();
            });
        }
        
        // --- TIMER LOGIC ---
        
        window.toggleTimer = function() {
            if(isTimerRunning) {
                // Pause
                clearInterval(timerInterval);
                isTimerRunning = false;
                document.getElementById('btn-timer-toggle').innerHTML = `<i data-lucide="play" class="w-8 h-8 fill-current"></i>`;
                document.getElementById('btn-timer-stop').disabled = false;
                document.getElementById('timer-active-ring').classList.remove('opacity-100', 'animate-spin-slow');
                document.getElementById('timer-active-ring').classList.add('opacity-0');
            } else {
                // Start
                isTimerRunning = true;
                timerInterval = setInterval(() => {
                    timerSeconds++;
                    updateTimerDisplay();
                }, 1000);
                document.getElementById('btn-timer-toggle').innerHTML = `<i data-lucide="pause" class="w-8 h-8 fill-current"></i>`;
                document.getElementById('btn-timer-stop').disabled = false;
                document.getElementById('timer-active-ring').classList.remove('opacity-0');
                document.getElementById('timer-active-ring').classList.add('opacity-100', 'animate-spin-slow');
            }
            lucide.createIcons();
        }
        
        window.stopTimer = async function() {
            if(timerSeconds < 60) {
                if(!confirm("Less than 1 minute logged. Discard session?")) return;
                resetTimer();
                return;
            }
            
            // Save log
            const duration = Math.round(timerSeconds / 60);
            const log = {
                subject: timerSubject,
                durationMinutes: duration,
                date: getLocalISODate(new Date()),
                timestamp: new Date().toISOString(),
                type: 'timer'
            };
            
            try {
                await setDoc(doc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'studyLogs')), log);
                showToast(`Logged ${duration}m of ${timerSubject}`);
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }, colors: ['#6366f1', '#a855f7'] });
            } catch(e) { console.error(e); }
            
            resetTimer();
        }
        
        function resetTimer() {
            clearInterval(timerInterval);
            isTimerRunning = false;
            timerSeconds = 0;
            updateTimerDisplay();
            document.getElementById('btn-timer-toggle').innerHTML = `<i data-lucide="play" class="w-8 h-8 fill-current"></i>`;
            document.getElementById('btn-timer-stop').disabled = true;
            document.getElementById('timer-active-ring').classList.remove('opacity-100', 'animate-spin-slow');
            document.getElementById('timer-active-ring').classList.add('opacity-0');
            lucide.createIcons();
        }
        
        function updateTimerDisplay() {
            const h = Math.floor(timerSeconds / 3600).toString().padStart(2, '0');
            const m = Math.floor((timerSeconds % 3600) / 60).toString().padStart(2, '0');
            const s = (timerSeconds % 60).toString().padStart(2, '0');
            document.getElementById('timer-display').innerText = `${h}:${m}:${s}`;
        }
        
        window.setTimerSubject = function(sub) {
            timerSubject = sub;
            // Visual update
            document.querySelectorAll('.timer-subject-pill').forEach(el => {
                if(el.dataset.sub === sub) {
                    el.classList.add('bg-indigo-600', 'text-white', 'border-indigo-600');
                    el.classList.remove('bg-white', 'dark:bg-slate-800', 'text-slate-500', 'dark:text-slate-400', 'hover:bg-slate-50');
                } else {
                    el.classList.remove('bg-indigo-600', 'text-white', 'border-indigo-600');
                    el.classList.add('bg-white', 'dark:bg-slate-800', 'text-slate-500', 'dark:text-slate-400', 'hover:bg-slate-50');
                }
            });
        }
        
        function updateTimerStats() {
            const today = getLocalISODate(new Date());
            
            // 1. Calculate Today's Total
            const todayLogs = state.studyLogs.filter(l => l.date === today);
            const totalMins = todayLogs.reduce((acc, curr) => acc + (curr.durationMinutes || 0), 0);
            
            let displayTime = `${totalMins}m`;
            if (totalMins > 60) {
                 displayTime = `${(totalMins/60).toFixed(1)}h`;
            }
            document.getElementById('today-total').innerText = displayTime;
            
            // 2. Calculate Streak
            const dates = [...new Set(state.studyLogs.map(l => l.date))].sort().reverse();
            let streak = 0;
            let checkDate = new Date(); // Start checking from today
            
            // Check if we studied today or yesterday to start the streak
            const checkStr = getLocalISODate(checkDate);
            const yesterday = new Date(checkDate); yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = getLocalISODate(yesterday);

            if (dates.includes(checkStr)) {
                 // Streak active today
            } else if (dates.includes(yesterdayStr)) {
                 // Streak active yesterday, need to study today to keep it
                 checkDate = yesterday;
            } else {
                 streak = 0;
            }
            
            // If we have a valid starting point
            if (streak === 0 && (dates.includes(checkStr) || dates.includes(yesterdayStr))) {
                 // Simple consecutive count logic
                 // Re-sort dates descending
                 const sortedUniqueDates = dates; 
                 // Find index of today or yesterday
                 let startIndex = sortedUniqueDates.indexOf(checkStr);
                 if (startIndex === -1) startIndex = sortedUniqueDates.indexOf(yesterdayStr);
                 
                 if (startIndex !== -1) {
                     streak = 1; 
                     let currentDate = new Date(sortedUniqueDates[startIndex]);
                     
                     for(let i = startIndex + 1; i < sortedUniqueDates.length; i++) {
                         currentDate.setDate(currentDate.getDate() - 1);
                         const expectedDateStr = getLocalISODate(currentDate);
                         if (sortedUniqueDates[i] === expectedDateStr) {
                             streak++;
                         } else {
                             break;
                         }
                     }
                 }
            }
            
            document.getElementById('streak-count').innerText = streak;
        }
        
        function renderRecentLogs() {
            const list = document.getElementById('timer-logs-list');
            list.innerHTML = '';
            
            const logs = [...state.studyLogs].sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)).slice(0, 10);
            const today = getLocalISODate(new Date());
            const todayLogs = logs.filter(l => l.date === today);
            
            if(todayLogs.length === 0) {
                list.innerHTML = `<div class="text-center py-6 text-slate-400 italic text-xs">No study sessions logged today. Start the timer!</div>`;
                return;
            }
            
            todayLogs.forEach(log => {
                const el = document.createElement('div');
                el.className = "flex items-center justify-between p-3 bg-white dark:bg-slate-800 rounded-xl border border-slate-100 dark:border-slate-700";
                
                const colors = subjectColors[log.subject] || subjectColors.Custom;
                const badgeClass = state.settings.theme === 'dark' ? colors.dark : colors.light;
                
                el.innerHTML = `
                    <div class="flex items-center gap-3">
                         <div class="w-10 h-10 rounded-lg flex items-center justify-center font-bold text-sm ${badgeClass}">
                            ${log.durationMinutes}m
                         </div>
                         <div>
                             <div class="text-xs font-bold text-slate-700 dark:text-slate-200">${log.subject}</div>
                             <div class="text-[10px] text-slate-400">${new Date(log.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} ${log.notes ? 'â€¢ ' + log.notes : ''}</div>
                         </div>
                    </div>
                    <button onclick="requestDelete('studyLog', '${log.id}')" class="p-2 text-slate-300 hover:text-rose-500 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                `;
                list.appendChild(el);
            });
            lucide.createIcons();
        }
        
        // Manual Log Modal
        window.openManualLogModal = () => {
            const select = document.getElementById('manual-log-subject');
            const type = state.settings.examType;
            let subjects = [];
             if(type === 'NEET') subjects = ['Physics', 'Chemistry', 'Biology'];
             else if(type === 'JEE Main' || type === 'JEE Advanced') subjects = ['Physics', 'Chemistry', 'Maths'];
             else subjects = ['Physics', 'Chemistry', 'Maths', 'Biology']; 
             subjects = [...subjects, ...(state.settings.customSubjects || [])];
             
             select.innerHTML = subjects.map(s => `<option value="${s}">${s}</option>`).join('');
             
             document.getElementById('manual-log-modal').classList.remove('hidden');
             setTimeout(() => document.getElementById('manual-log-modal').classList.remove('opacity-0'), 10);
        }
        
        window.closeManualLogModal = () => {
            document.getElementById('manual-log-modal').classList.add('opacity-0');
            setTimeout(() => document.getElementById('manual-log-modal').classList.add('hidden'), 200);
        }
        
        window.saveManualLog = async () => {
            const subject = document.getElementById('manual-log-subject').value;
            const duration = parseInt(document.getElementById('manual-log-duration').value);
            const notes = document.getElementById('manual-log-notes').value;
            
            if(!duration || duration <= 0) { showToast("Invalid duration"); return; }
            
            const log = {
                subject,
                durationMinutes: duration,
                notes,
                date: getLocalISODate(new Date()),
                timestamp: new Date().toISOString(),
                type: 'manual'
            };
            
            try {
                await setDoc(doc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'studyLogs')), log);
                showToast("Log Added");
                closeManualLogModal();
                document.getElementById('manual-log-duration').value = '';
                document.getElementById('manual-log-notes').value = '';
            } catch(e) { console.error(e); }
        }

        // --- SYLLABUS LOGIC ---
        function getSyllabusMeta(id) {
            if (!state.syllabusData.meta[id]) {
                state.syllabusData.meta[id] = { rev: 0, pyq: false };
            }
            return state.syllabusData.meta[id];
        }

        async function saveSyllabusData() {
            if(!currentUser) return;
            try {
                await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'syllabus', 'progress'), state.syllabusData, { merge: true });
            } catch(e) { console.error("Error saving syllabus", e); }
        }

        function calculateSyllabusStats(chapters) {
            let total = chapters.length;
            if (total === 0) return { percent: 0, mastered: 0, completed: 0, inProgress: 0, notStarted: 0, total: 0 };

            let weightedSum = 0, mastered = 0, completed = 0, inProgress = 0;

            chapters.forEach(ch => {
                const status = state.syllabusData.status[ch.id] || 'not-started';
                const weight = syllabusStatusConfig[status].weight;
                weightedSum += weight;
                if (status === 'mastered') mastered++;
                else if (status === 'completed') completed++;
                else if (status === 'in-progress') inProgress++;
            });

            return {
                percent: Math.round((weightedSum / total) * 100),
                mastered, completed, inProgress,
                notStarted: total - (mastered + completed + inProgress),
                total
            };
        }

        // Filter Syllabus based on Exam Target
        function getFilteredSyllabus() {
            const target = state.settings.examType; // JEE Main, NEET, JEE Advanced
            const isNEET = target === 'NEET';
            
            return syllabus.filter(s => {
                if (isNEET && s.subject === 'Mathematics') return false;
                if (!isNEET && s.subject === 'Biology') return false;
                return true;
            });
        }

        // --- NEW: Helper for rendering single chapter HTML content ---
        function renderChapterContent(ch) {
            const status = state.syllabusData.status[ch.id] || 'not-started';
            const meta = getSyllabusMeta(ch.id);
            const config = syllabusStatusConfig[status];
            const isOpen = state.syllabusOpenStates[ch.id];

            // Badge HTML
            let badges = '';
            if (meta.pyq) badges += `<span class="badge badge-pyq mr-1">PYQ</span>`;
            if (meta.rev > 0) badges += `<span class="badge badge-rev">R${meta.rev}</span>`;

            // Action Panel HTML
            const actionPanel = isOpen ? `
                <div class="p-3 bg-slate-50 dark:bg-slate-900/50 border-t border-slate-100 dark:border-slate-700/50 space-y-3 animate-slide-up">
                    <div>
                        <label class="text-[10px] uppercase text-slate-400 font-bold tracking-wider mb-1.5 block">Status</label>
                        <div class="grid grid-cols-2 gap-2">
                            ${Object.keys(syllabusStatusConfig).map(key => `
                                <button onclick="updateSyllabusStatus('${ch.id}', '${key}')" 
                                    class="px-2 py-1.5 text-[10px] font-bold rounded border transition-all ${status===key ? 'bg-indigo-50 text-indigo-600 border-indigo-200 dark:bg-indigo-900/30 dark:text-indigo-300 dark:border-indigo-800' : 'bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 text-slate-500 hover:bg-slate-50'}">
                                    ${syllabusStatusConfig[key].text}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="flex-1">
                            <label class="text-[10px] uppercase text-slate-400 font-bold tracking-wider mb-1.5 block">Revisions</label>
                            <div class="flex items-center gap-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg p-1 justify-center">
                                <button onclick="modSyllabusRev('${ch.id}', -1)" class="w-6 h-6 flex items-center justify-center hover:bg-slate-100 dark:hover:bg-slate-700 rounded text-slate-400 font-bold">-</button>
                                <span class="text-xs font-bold w-4 text-center dark:text-white">${meta.rev}</span>
                                <button onclick="modSyllabusRev('${ch.id}', 1)" class="w-6 h-6 flex items-center justify-center hover:bg-slate-100 dark:hover:bg-slate-700 rounded text-indigo-500 font-bold">+</button>
                            </div>
                        </div>
                        <div class="flex-1">
                            <label class="text-[10px] uppercase text-slate-400 font-bold tracking-wider mb-1.5 block">Practice</label>
                            <button onclick="toggleSyllabusPyq('${ch.id}')" class="w-full py-1.5 flex items-center justify-center gap-2 border rounded-lg transition-colors ${meta.pyq ? 'bg-green-50 text-green-600 border-green-200 dark:bg-green-900/20 dark:text-green-400 dark:border-green-800' : 'bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 text-slate-500'}">
                                <span class="text-[10px] font-bold">PYQs</span>
                                ${meta.pyq ? '<i data-lucide="check" class="w-3 h-3"></i>' : ''}
                            </button>
                        </div>
                    </div>
                </div>
            ` : '';

            // Note the id="wrapper-${ch.id}" used for targeted updates
            return `
                <div id="wrapper-${ch.id}" class="mb-1 rounded-lg overflow-hidden border border-transparent dark:border-transparent transition-all ${isOpen ? 'bg-white dark:bg-slate-800/80 shadow-sm border-slate-200 dark:border-slate-700' : ''}">
                    <div onclick="toggleSyllabusChapter('${ch.id}')" class="chapter-leaf p-2.5 flex justify-between items-center ${isOpen ? 'bg-slate-50 dark:bg-slate-800' : ''}">
                        <div class="flex-1 pr-2">
                            <div class="flex items-center gap-2 mb-0.5">
                                <span class="text-xs font-medium ${config.color}">${ch.name}</span>
                            </div>
                            <div class="flex items-center h-4">${badges}</div>
                        </div>
                        <div class="flex items-center gap-2.5">
                            <div class="status-dot ${config.dot}"></div>
                            <i data-lucide="chevron-down" class="w-3 h-3 text-slate-400 arrow-icon ${isOpen ? 'rotate-180' : ''}"></i>
                        </div>
                    </div>
                    ${actionPanel}
                </div>
            `;
        }
        window.openEditMockModal = function(id) {
            const task = state.tasks.find(t => t.id === id);
            if(!task) return;

            document.getElementById('edit-mock-id').value = id;
            document.getElementById('edit-mock-title').innerText = `${formatDate(task.date)} - ${task.text}`;

            // Determine subjects based on settings
            const type = state.settings.examType;
            let subjects = (type === 'NEET') ? ['Physics', 'Chemistry', 'Biology'] : ['Physics', 'Chemistry', 'Maths'];

            const container = document.getElementById('edit-mock-inputs');
            let html = '';
            let currentTotal = 0;

            subjects.forEach(sub => {
                // Get existing score if available
                const val = (task.subjectMarks && task.subjectMarks[sub]) ? task.subjectMarks[sub] : '';
                if(val) currentTotal += parseInt(val);

                html += `
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 mb-1 uppercase text-center">${sub.substring(0,3)}</label>
                        <input type="number" 
                            data-sub="${sub}" 
                            value="${val}" 
                            class="edit-mock-input w-full bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl px-2 py-2 text-sm text-center outline-none dark:text-white font-bold focus:ring-2 focus:ring-indigo-500 appearance-none" 
                            oninput="recalcEditTotal()">
                    </div>
                `;
            });

            container.innerHTML = html;
            document.getElementById('edit-mock-total').innerText = task.marks || currentTotal; // Fallback to manual sum if task.marks is empty

            const modal = document.getElementById('edit-mock-modal');
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.remove('opacity-0'), 10);
        }

        window.closeEditMockModal = function() {
            const modal = document.getElementById('edit-mock-modal');
            modal.classList.add('opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 200);
        }

        window.recalcEditTotal = function() {
            let total = 0;
            document.querySelectorAll('.edit-mock-input').forEach(input => {
                const val = parseInt(input.value);
                if(!isNaN(val)) total += val;
            });
            document.getElementById('edit-mock-total').innerText = total;
        }

        window.saveMockBreakdown = async function() {
            if(!currentUser) return;
            const id = document.getElementById('edit-mock-id').value;
            
            // Gather new data
            const subjectMarks = {};
            let total = 0;
            
            document.querySelectorAll('.edit-mock-input').forEach(input => {
                const val = parseInt(input.value);
                if(!isNaN(val)) {
                    subjectMarks[input.dataset.sub] = val;
                    total += val;
                }
            });

            try {
                // Update Firestore
                // We update marks AND subjectMarks
                await updateDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'tasks', id), {
                    marks: total,
                    subjectMarks: subjectMarks,
                    completed: true // Ensure it's marked as done
                });
                showToast("Breakdown Updated");
                closeEditMockModal();
            } catch(e) {
                console.error(e);
                showToast("Error updating");
            }
        }
        // Render Syllabus View (Initial Full Render)
        window.renderSyllabusView = function() {
            const container = document.getElementById('syllabus-content');
            const progressContainer = document.getElementById('overall-progress-data');
            if(!container || !progressContainer) return;

            // Only clear HTML if we are doing a full re-render (init or search)
            // For targeted updates we will call a different function
            container.innerHTML = '';
            
            const filteredSyllabus = getFilteredSyllabus();
            const allChapters = filteredSyllabus.flatMap(s => s.units.flatMap(u => u.chapters));
            const searchLower = (document.getElementById('syllabus-search')?.value || '').trim().toLowerCase();

            // 1. Render Overall Stats
            const stats = calculateSyllabusStats(allChapters);
            progressContainer.innerHTML = `
                <div class="flex items-end justify-between mb-2">
                    <div>
                        <span class="text-5xl font-black text-slate-900 dark:text-white tracking-tighter">${stats.percent}%</span>
                        <span class="text-xs font-bold text-slate-500 uppercase tracking-wide ml-1">Covered</span>
                    </div>
                </div>
                <div class="w-full h-2.5 rounded-full flex overflow-hidden bg-slate-100 dark:bg-slate-700/50">
                    <div class="bg-indigo-500" style="width: ${(stats.mastered/stats.total)*100}%"></div>
                    <div class="bg-green-500" style="width: ${(stats.completed/stats.total)*100}%"></div>
                    <div class="bg-yellow-500" style="width: ${(stats.inProgress/stats.total)*100}%"></div>
                </div>
                <div class="grid grid-cols-2 gap-y-1 gap-x-2 text-[10px] font-bold mt-3 uppercase tracking-wide">
                    <div class="flex justify-between text-slate-500 dark:text-slate-400"><span>Mastered</span> <span class="text-indigo-500">${stats.mastered}</span></div>
                    <div class="flex justify-between text-slate-500 dark:text-slate-400"><span>Done</span> <span class="text-green-500">${stats.completed}</span></div>
                    <div class="flex justify-between text-slate-500 dark:text-slate-400"><span>Doing</span> <span class="text-yellow-500">${stats.inProgress}</span></div>
                    <div class="flex justify-between text-slate-400 dark:text-slate-500"><span>To Do</span> <span class="text-slate-600 dark:text-slate-300">${stats.notStarted}</span></div>
                </div>
            `;

            // 2. Render Cards
            filteredSyllabus.forEach((subject, idx) => {
                let hasMatch = false;
                const unitsHtml = subject.units.map(unit => {
                    const unitChapters = unit.chapters.filter(ch => 
                        !searchLower || 
                        ch.name.toLowerCase().includes(searchLower) || 
                        unit.unitName.toLowerCase().includes(searchLower) ||
                        subject.subject.toLowerCase().includes(searchLower)
                    );
                    
                    if (unitChapters.length === 0) return '';
                    hasMatch = true;

                    const unitStats = calculateSyllabusStats(unitChapters);
                    const unitId = `${subject.subject}-${unit.unitName}`.replace(/\s+/g, '-');
                    const isExpanded = state.syllabusOpenStates[unitId];

                    // FIX: Use renderChapterContent here for consistency with targeted updates
                    const chaptersHtml = unitChapters.map(ch => renderChapterContent(ch)).join('');

                    return `
                        <div class="mb-3 border border-slate-100 dark:border-slate-700 rounded-xl overflow-hidden">
                            <div onclick="toggleSyllabusGroup('${unitId}')" class="p-3 bg-slate-50/50 dark:bg-slate-800/30 flex justify-between items-center cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-700/50 transition-colors">
                                <div class="flex items-center gap-2">
                                    <i data-lucide="folder" class="w-3.5 h-3.5 text-slate-400"></i>
                                    <span class="text-xs font-bold text-slate-700 dark:text-slate-300 uppercase tracking-wide">${unit.unitName}</span>
                                </div>
                                <span class="text-[10px] font-bold ${unitStats.percent===100?'text-green-500':'text-slate-400'}">${unitStats.percent}%</span>
                            </div>
                            <div class="${isExpanded ? 'block' : 'hidden'} p-2 bg-white dark:bg-slate-900/20 border-t border-slate-100 dark:border-slate-700">
                                ${chaptersHtml}
                            </div>
                        </div>
                    `;
                }).join('');

                if (!hasMatch) return;

                const subjStats = calculateSyllabusStats(subject.units.flatMap(u => u.chapters));
                
                const card = document.createElement('div');
                card.className = "glass-card p-0 rounded-2xl overflow-hidden break-inside-avoid mb-6 flex flex-col";
                card.innerHTML = `
                    <div class="p-5 pb-0">
                        <div class="flex justify-between items-center mb-2">
                            <h2 class="text-lg font-black text-slate-800 dark:text-white">${subject.subject}</h2>
                            <span class="text-lg font-bold ${subjStats.percent===100?'text-green-500':'text-indigo-500'}">${subjStats.percent}%</span>
                        </div>
                        <div class="w-full h-1.5 rounded-full flex overflow-hidden bg-slate-100 dark:bg-slate-700">
                            <div class="bg-indigo-500" style="width: ${(subjStats.mastered/subjStats.total)*100}%"></div>
                            <div class="bg-green-500" style="width: ${(subjStats.completed/subjStats.total)*100}%"></div>
                            <div class="bg-yellow-500" style="width: ${(subjStats.inProgress/subjStats.total)*100}%"></div>
                        </div>
                    </div>
                    <div class="p-4 space-y-2">
                        ${unitsHtml}
                    </div>
                `;
                container.appendChild(card);
            });
            lucide.createIcons();
        }

        // --- NEW: Targeted Update Function to prevent full re-render flickering ---
        function refreshChapterUI(id) {
            const wrapper = document.getElementById(`wrapper-${id}`);
            if(wrapper) {
                // Find chapter object in syllabus to re-render
                let chObj = null;
                for (let s of syllabus) {
                    for (let u of s.units) {
                        const found = u.chapters.find(c => c.id === id);
                        if (found) { chObj = found; break; }
                    }
                    if (chObj) break;
                }
                
                if (chObj) {
                    wrapper.outerHTML = renderChapterContent(chObj);
                    lucide.createIcons();
                }
            }
        }

        // Window Actions for Syllabus
        window.toggleSyllabusGroup = (id) => {
            state.syllabusOpenStates[id] = !state.syllabusOpenStates[id];
            renderSyllabusView(); // Group toggle changes layout significantly, full render is safer
        }
        
        window.toggleSyllabusChapter = (id) => {
            // Close other open chapters
            Object.keys(state.syllabusOpenStates).forEach(key => {
                if (key !== id && state.syllabusOpenStates[key]) {
                    // Check if it's a chapter (has wrapper) to avoid closing groups
                    if (document.getElementById(`wrapper-${key}`)) {
                        state.syllabusOpenStates[key] = false;
                        refreshChapterUI(key);
                    }
                }
            });

            state.syllabusOpenStates[id] = !state.syllabusOpenStates[id];
            // Use targeted update instead of full render
            refreshChapterUI(id);
        }
        
        window.updateSyllabusStatus = async (id, status) => {
            state.syllabusData.status[id] = status;
            await saveSyllabusData();
            // Targeted update
            refreshChapterUI(id);
        }
        
        window.modSyllabusRev = async (id, delta) => {
            const meta = getSyllabusMeta(id);
            let val = (meta.rev || 0) + delta;
            if (val < 0) val = 0;
            state.syllabusData.meta[id].rev = val;
            await saveSyllabusData();
            refreshChapterUI(id);
        }
        
        window.toggleSyllabusPyq = async (id) => {
            const meta = getSyllabusMeta(id);
            state.syllabusData.meta[id].pyq = !meta.pyq;
            await saveSyllabusData();
            refreshChapterUI(id);
        }

        // Syllabus Search Debounce
        document.getElementById('syllabus-search').addEventListener('input', (e) => {
            clearTimeout(window.searchTimeout);
            window.searchTimeout = setTimeout(renderSyllabusView, 300);
        });

        // Reset Syllabus Data
        document.getElementById('btn-reset-syllabus').addEventListener('click', async () => {
            if(confirm("Reset all syllabus progress? This cannot be undone.")) {
                state.syllabusData = { status: {}, meta: {} };
                await saveSyllabusData();
                renderSyllabusView();
            }
        });


        // --- THEME & SETTINGS HELPERS ---
        window.applyTheme = function(theme) {
            const html = document.documentElement;
            const knob = document.getElementById('theme-knob');
            const toggle = document.getElementById('theme-toggle');
            if (theme === 'dark') {
                html.classList.add('dark');
                html.classList.remove('light');
                if(knob) knob.style.transform = 'translateX(20px)';
                if(toggle) toggle.className = "relative w-12 h-7 bg-indigo-600 rounded-full transition-all duration-300"; 
            } else {
                html.classList.remove('dark');
                html.classList.add('light');
                if(knob) knob.style.transform = 'translateX(0)';
                if(toggle) toggle.className = "relative w-12 h-7 bg-slate-200 dark:bg-slate-600 rounded-full transition-all duration-300"; 
            }
        }

        window.applyBackground = function(url) {
            const bg = document.getElementById('app-background');
            if(url && url.trim() !== '') {
                bg.style.backgroundImage = `url('${url}')`;
                bg.style.opacity = '1';
            } else {
                bg.style.opacity = '0';
                setTimeout(() => bg.style.backgroundImage = 'none', 500);
            }
        }

        window.setPresetBg = function(url) {
            document.getElementById('settings-bg-url').value = url;
            applyBackground(url);
            markSettingsDirty();
        }

        // --- Dirty State & Save Logic ---
        window.markSettingsDirty = function() {
            isSettingsDirty = true;
            document.getElementById('unsaved-changes-indicator').classList.remove('hidden');
            const btn = document.getElementById('save-settings-btn');
            btn.classList.remove('bg-slate-900', 'dark:bg-slate-700');
            btn.classList.add('bg-indigo-600', 'hover:bg-indigo-700', 'text-white');
            btn.innerText = "Save Unsaved Changes";
        }

        window.resetSettingsDirty = function() {
            isSettingsDirty = false;
            document.getElementById('unsaved-changes-indicator').classList.add('hidden');
            const btn = document.getElementById('save-settings-btn');
            btn.classList.add('bg-slate-900', 'dark:bg-slate-700');
            btn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700', 'text-white');
            btn.innerText = "Save Changes";
        }

        window.setExamType = function(type) {
             tempSettings.examType = type;
             ['jee', 'neet', 'jeeadv', 'custom'].forEach(id => {
                 const btn = document.getElementById(`btn-${id}`);
                 const map = { 'jee': 'JEE Main', 'neet': 'NEET', 'jeeadv': 'JEE Advanced', 'custom': 'Custom' };
                 if(map[id] === type) {
                     btn.classList.add('bg-indigo-600', 'text-white', 'border-indigo-600');
                     btn.classList.remove('hover:bg-indigo-50');
                 } else {
                     btn.classList.remove('bg-indigo-600', 'text-white', 'border-indigo-600');
                     btn.classList.add('hover:bg-indigo-50');
                 }
             });
             
             if(type === 'JEE Main') {
                 document.getElementById('jee-session-container').classList.remove('hidden');
                 if(!tempSettings.session) tempSettings.session = 'Jan'; 
                 updateSessionUI();
             } else {
                 document.getElementById('jee-session-container').classList.add('hidden');
             }
             document.getElementById('custom-date-container').classList.toggle('hidden', type !== 'Custom');
             updateTargetDateConfig();
             markSettingsDirty();
        }

        window.setSession = function(session) {
            tempSettings.session = session;
            updateSessionUI();
            updateTargetDateConfig();
            markSettingsDirty();
        }

        function updateSessionUI() {
            const janBtn = document.getElementById('btn-session-jan');
            const aprBtn = document.getElementById('btn-session-apr');
            if(tempSettings.session === 'Jan') {
                janBtn.classList.add('bg-indigo-600', 'text-white', 'border-indigo-600');
                aprBtn.classList.remove('bg-indigo-600', 'text-white', 'border-indigo-600');
            } else {
                aprBtn.classList.add('bg-indigo-600', 'text-white', 'border-indigo-600');
                janBtn.classList.remove('bg-indigo-600', 'text-white', 'border-indigo-600');
            }
        }

        window.updateTargetDateConfig = function() {
             const year = document.getElementById('settings-year').value;
             let date = `${year}-01-01`; 
             if(tempSettings.examType === 'JEE Main') {
                 if(tempSettings.session === 'Jan') date = `${year}-01-21`;
                 else date = `${year}-04-01`;
             }
             else if(tempSettings.examType === 'NEET') date = `${year}-05-05`;
             else if(tempSettings.examType === 'JEE Advanced') date = `${year}-05-17`;
             
             tempSettings.targetDate = date;
             tempSettings.targetYear = parseInt(year);
        }

        window.saveSettings = async function() {
            if(!currentUser) return;
            tempSettings.bgUrl = document.getElementById('settings-bg-url').value;
            updateTargetDateConfig();
            try {
                await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'settings', 'config'), {
                    ...state.settings,
                    ...tempSettings
                });
                resetSettingsDirty();
                closeSettings();
                showToast("Settings Saved");
            } catch(e) { console.error(e); }
        }

        // --- NEW: Helper to Update Mock Scores via Input ---
        window.updateTaskScore = async function(id, type, value) {
            if(!currentUser) return;
            const updateData = {};
            const numVal = value === "" ? null : parseInt(value);
            
            if(type === 'obtained') {
                updateData.marks = numVal;
                if(numVal !== null) updateData.completed = true;
            } else if (type === 'total') {
                updateData.maxMarks = numVal;
            }

            try {
                await updateDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'tasks', id), updateData);
            } catch(e) { console.error(e); }
        }

        // --- DRAG AND DROP HANDLERS ---
        window.handleDragStart = function(e, taskId) {
            draggedTaskId = taskId;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', taskId);
            setTimeout(() => e.target.classList.add('dragging'), 0);
        }

        window.handleDragOver = function(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            e.currentTarget.classList.add('drag-over');
        }

        window.handleDragLeave = function(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        window.handleDrop = async function(e, dateStr) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            const draggedEl = document.querySelector('.dragging');
            if(draggedEl) draggedEl.classList.remove('dragging');

            if(!draggedTaskId || !currentUser) return;

            try {
                const taskRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'tasks', draggedTaskId);
                await updateDoc(taskRef, { date: dateStr });
                showToast("Task Rescheduled");
            } catch(error) {
                console.error("Drop failed", error);
            }
            draggedTaskId = null;
        }

        // --- UI & LOGIC ---
        
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const parts = dateStr.split('-');
            if (parts.length !== 3) return dateStr;
            return `${parts[2]}/${parts[1]}/${parts[0]}`;
        }

        // 1. Calendar Logic
        window.renderCalendar = function() {
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            const year = state.viewDate.getFullYear();
            const month = state.viewDate.getMonth();
            const todayStr = getLocalISODate(new Date());

            document.getElementById('current-month-display').innerText = state.viewDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            for (let i = 1; i <= daysInMonth; i++) {
                const date = new Date(year, month, i);
                const dateStr = getLocalISODate(date);
                const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                const tasks = state.tasks.filter(t => t.date === dateStr);
                
                const isToday = dateStr === todayStr;
                const completedCount = tasks.filter(t => t.completed).length;
                const totalCount = tasks.length;
                const progress = totalCount ? Math.round((completedCount/totalCount)*100) : 0;
                
                const card = document.createElement('div');
                // Updated Card classes for mobile responsiveness
                card.className = `day-card group relative p-3 md:p-4 rounded-2xl md:rounded-3xl flex md:flex-col min-h-[60px] md:min-h-[160px] h-auto border transition-all items-center md:items-stretch gap-3 md:gap-0 ${isToday ? 'bg-white dark:bg-slate-800 border-indigo-500 shadow-glow-sm ring-1 ring-indigo-500/50' : 'bg-white/80 dark:bg-slate-800/80 border-slate-200 dark:border-slate-700 md:hover:border-indigo-300 md:dark:hover:border-slate-600'}`;
                if(isToday) card.id = 'today-card';

                card.setAttribute('ondragover', 'handleDragOver(event)');
                card.setAttribute('ondragleave', 'handleDragLeave(event)');
                card.setAttribute('ondrop', `handleDrop(event, '${dateStr}')`);

                const progBar = totalCount > 0 ? `<div class="w-full h-1 bg-slate-100 dark:bg-slate-700 rounded-full mt-2 mb-2 overflow-hidden hidden md:block"><div class="h-full bg-indigo-500 transition-all duration-500" style="width: ${progress}%"></div></div>` : '';
                
                // Mobile Progress Dot
                const mobileDot = totalCount > 0 
                    ? `<div class="md:hidden w-2 h-2 rounded-full ${progress === 100 ? 'bg-green-500' : 'bg-indigo-500'}"></div>` 
                    : '';

                let taskListHTML = '';
                
                // Desktop Task List
                if (tasks.length > 0) {
                    taskListHTML = '<div class="space-y-1.5 flex-1 mt-1 hidden md:block">';
                    tasks.forEach(t => {
                        const styleClass = t.completed ? 'line-through opacity-60 grayscale' : '';
                        const colors = subjectColors[t.subject] || subjectColors.Custom;
                        const colorClass = state.settings.theme === 'dark' ? colors.dark : colors.light;

                        taskListHTML += `
                            <div draggable="true" ondragstart="handleDragStart(event, '${t.id}')" class="task-item text-xs font-medium flex items-center gap-2 p-1.5 rounded-lg border transition-all cursor-grab active:cursor-grabbing hover:shadow-sm ${colorClass} ${styleClass}">
                                <i data-lucide="grip-vertical" class="w-3 h-3 opacity-40 shrink-0 cursor-grab"></i>
                                <span class="truncate pointer-events-none flex-1">${t.text}</span>
                            </div>
                        `;
                    });
                    taskListHTML += '</div>';
                }

                // Mobile Task Summary Text
                let mobileTaskSummary = '';
                if(tasks.length > 0) {
                    mobileTaskSummary = `<div class="md:hidden text-xs text-slate-500 dark:text-slate-400 truncate flex-1 text-left">${completedCount}/${totalCount} completed</div>`;
                } else {
                    mobileTaskSummary = `<div class="md:hidden text-xs text-slate-300 dark:text-slate-600 italic flex-1 text-left">No tasks</div>`;
                }

                card.onclick = () => openDayView(dateStr);
                
                // CHANGE HERE: Removed "opacity-0 group-hover:opacity-100 transition-opacity" from the button class
                card.innerHTML = `
                    <div class="flex flex-col md:flex-row md:justify-between items-center md:items-start md:mb-1 pointer-events-none shrink-0 md:w-full">
                        <div class="text-center md:text-left">
                            <span class="text-[10px] font-bold uppercase tracking-wider text-slate-400 block">${dayName}</span>
                            <div class="text-xl font-bold ${isToday ? 'text-indigo-600 dark:text-indigo-400' : 'text-slate-700 dark:text-slate-200'}">${i}</div>
                        </div>
                        ${totalCount > 0 ? `<div class="text-[10px] font-bold text-slate-400 hidden md:block">${completedCount}/${totalCount}</div>` : ''}
                    </div>
                    ${progBar}
                    ${taskListHTML}
                    ${mobileTaskSummary}
                    ${mobileDot}
                    <button onclick="event.stopPropagation(); selectDateForAdd('${dateStr}')" class="mt-auto pt-2 text-[10px] text-indigo-500 font-bold text-left pointer-events-auto hidden md:block hover:text-indigo-600">+ Add Task</button>
                    <i data-lucide="chevron-right" class="w-4 h-4 text-slate-300 md:hidden ml-auto"></i>
                `;
                
                grid.appendChild(card);
            }
            lucide.createIcons();
        }

        window.selectDateForAdd = function(dateStr) {
            if(window.innerWidth >= 768) {
                // Desktop
                document.getElementById('task-date').value = dateStr;
                document.getElementById('task-input').focus();
            } else {
                // Mobile
                document.getElementById('task-date-mobile').value = dateStr;
                openAddTaskModal();
            }
        }

        // 2. Weekly Targets Logic
        function getStartOfWeek(d) {
            const date = new Date(d);
            const day = date.getDay(); // 0 (Sun) to 6 (Sat)
            const diff = date.getDate() - day + (day === 0 ? -6 : 1); // Adjust to Monday
            const monday = new Date(date.setDate(diff));
            monday.setHours(0,0,0,0);
            return monday;
        }

        window.renderWeeklyView = function() {
            const list = document.getElementById('weekly-list');
            list.innerHTML = '';
            
            const startOfWeek = getStartOfWeek(state.weeklyViewDate);
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            
            const weekId = getLocalISODate(startOfWeek);
            
            document.getElementById('weekly-date-range').innerText = `${startOfWeek.getDate()} ${startOfWeek.toLocaleString('default',{month:'short'})} - ${endOfWeek.getDate()} ${endOfWeek.toLocaleString('default',{month:'short'})}`;

            const targets = state.targets.filter(t => t.weekId === weekId);
            const total = targets.length;
            const completed = targets.filter(t => t.completed).length;
            const percent = total === 0 ? 0 : Math.round((completed/total)*100);
            
            document.getElementById('weekly-progress-text').innerText = `${percent}%`;
            document.getElementById('weekly-count-text').innerText = `${completed}/${total} Targets Completed`;
            
            const ring = document.getElementById('weekly-ring');
            const circumference = 251.2;
            const offset = circumference - (percent / 100) * circumference;
            setTimeout(() => ring.style.strokeDashoffset = offset, 100);

            if(targets.length === 0) {
                list.innerHTML = `<div class="text-center py-10 opacity-50"><p>No targets for this week yet.</p></div>`;
                return;
            }

            targets.forEach(t => {
                const el = document.createElement('div');
                el.className = `flex items-center gap-4 p-4 rounded-2xl border transition-all ${t.completed ? 'bg-green-50/50 dark:bg-green-900/10 border-green-200 dark:border-green-800' : 'bg-white dark:bg-slate-800 border-slate-100 dark:border-slate-700'}`;
                el.innerHTML = `
                    <div onclick="toggleTarget('${t.id}', ${t.completed})" class="w-6 h-6 rounded-lg border-2 flex items-center justify-center cursor-pointer transition-colors shrink-0 ${t.completed ? 'bg-green-500 border-green-500' : 'border-slate-300 dark:border-slate-600'}">
                        ${t.completed ? '<i data-lucide="check" class="w-4 h-4 text-white"></i>' : ''}
                    </div>
                    <div class="flex-1 text-sm font-medium ${t.completed ? 'line-through text-slate-400' : 'text-slate-800 dark:text-slate-200'}">${t.text}</div>
                    <button onclick="requestDelete('target', '${t.id}')" class="text-slate-300 hover:text-rose-500 p-2"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                `;
                list.appendChild(el);
            });
            lucide.createIcons();
        }

        window.addWeeklyTarget = async function() {
            const input = document.getElementById('target-input');
            const text = input.value.trim();
            if(!text) return;
            
            const weekId = getLocalISODate(getStartOfWeek(state.weeklyViewDate));
            
            try {
                await setDoc(doc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'weeklyTargets')), {
                    text, weekId, completed: false, createdAt: new Date().toISOString()
                });
                input.value = '';
                showToast("Target Set!");
            } catch(e) { console.error(e); }
        }
        window.updateTargetDateConfig = function() {
            const year = document.getElementById('settings-year').value;
            let date = `${year}-01-01`; 

            if (tempSettings.examType === 'JEE Main') {
                date = (tempSettings.session === 'Jan') ? `${year}-01-21` : `${year}-04-01`;
            } else if (tempSettings.examType === 'NEET') {
                date = `${year}-05-05`;
            } else if (tempSettings.examType === 'JEE Advanced') {
                date = `${year}-05-17`;
            } else if (tempSettings.examType === 'Custom') {
                // Pull from the manual picker
                const manualDate = document.getElementById('settings-custom-date').value;
                if (manualDate) date = manualDate;
            }
            
            tempSettings.targetDate = date;
            tempSettings.targetYear = parseInt(year);
        }
        window.toggleTarget = async function(id, status) {
            try {
                await updateDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'weeklyTargets', id), { completed: !status });
                if(!status) {
                    confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }, colors: ['#6366f1', '#a855f7', '#ec4899'] });
                }
            } catch(e) { console.error(e); }
        }

        window.requestDelete = function(type, id) {
            itemToDelete = { type, id };
            const modal = document.getElementById('confirm-modal');
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.remove('opacity-0'), 10);
        }
        
        document.getElementById('confirm-delete-btn').onclick = async () => {
            if(!itemToDelete) return;
            const { type, id } = itemToDelete;
            let col = '';
            
            // Optimistic UI Update & Collection selection
            if (type === 'task') {
                col = 'tasks';
                state.tasks = state.tasks.filter(t => t.id !== id);
                renderCalendar(); 
                if(state.currentView === 'stats') renderMockStats();
                if(currentDayViewDate && !document.getElementById('day-view-modal').classList.contains('hidden')) {
                    openDayView(currentDayViewDate);
                }
            } else if (type === 'target') {
                col = 'weeklyTargets';
                state.targets = state.targets.filter(t => t.id !== id);
                renderWeeklyView();
            } else if (type === 'studyLog') {
                col = 'studyLogs';
                state.studyLogs = state.studyLogs.filter(t => t.id !== id);
                renderRecentLogs();
                updateTimerStats();
            }
            
            closeConfirmModal();

            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, col, id));
            } catch(e) {
                console.error("Delete failed", e);
                showToast("Error deleting item");
            }
        };

        window.changeWeek = function(delta) {
            state.weeklyViewDate.setDate(state.weeklyViewDate.getDate() + (delta * 7));
            renderWeeklyView();
        }

        // 3. Mock Stats Logic (Raw Scores)
        window.renderMockStats = function() {
            // 1. Prepare Data
            const mockTasks = state.tasks
                .filter(t => t.subject === 'MockTest')
                .sort((a,b) => new Date(a.date) - new Date(b.date));
            
            const scored = mockTasks.filter(t => t.marks !== undefined && t.marks !== null && t.marks !== "");
            const marks = scored.map(t => parseInt(t.marks));
            
            // Extract Subject Data
            const physicsData = scored.map(t => t.subjectMarks?.Physics || null);
            const chemData = scored.map(t => t.subjectMarks?.Chemistry || null);
            const mathsData = scored.map(t => t.subjectMarks?.Maths || null);
            const bioData = scored.map(t => t.subjectMarks?.Biology || null);

            // Calculate Stats
            const total = scored.length;
            const globalMax = scored.length > 0 ? Math.max(...scored.map(t => parseInt(t.maxMarks || 300))) : 300;
            
            document.getElementById('stats-total-tests').innerText = total;
            document.getElementById('stats-avg-score').innerText = total ? Math.round(marks.reduce((a,b)=>a+b,0)/total) : 0;
            document.getElementById('stats-max-score').innerText = total ? Math.max(...marks) : 0;
            document.getElementById('stats-last-5').innerText = marks.slice(-5).length ? Math.round(marks.slice(-5).reduce((a,b)=>a+b,0)/marks.slice(-5).length) : 0;

            // 2. Chart Configuration
            const ctx = document.getElementById('mockChart');
            if(mockChartInstance) mockChartInstance.destroy();
            
            const datasets = [];

            // Always add Total
            datasets.push({
                label: 'Total',
                data: marks,
                borderColor: '#6366f1',
                backgroundColor: (context) => {
                    const ctx = context.chart.ctx;
                    const gradient = ctx.createLinearGradient(0, 0, 0, 300);
                    gradient.addColorStop(0, 'rgba(99, 102, 241, 0.4)');
                    gradient.addColorStop(1, 'rgba(99, 102, 241, 0.0)');
                    return gradient;
                },
                borderWidth: 3,
                pointBackgroundColor: '#fff',
                pointBorderColor: '#6366f1',
                fill: true,
                tension: 0.4,
                hidden: false // Total is always visible
            });

            // Add Subjects (Hidden by default)
            const subjectConfig = [
                { label: 'Physics', data: physicsData, color: '#f43f5e' },   // Rose
                { label: 'Chemistry', data: chemData, color: '#f59e0b' }, // Amber
                { label: 'Maths', data: mathsData, color: '#3b82f6' },    // Blue
                { label: 'Biology', data: bioData, color: '#10b981' }     // Emerald
            ];

            subjectConfig.forEach(sub => {
                // Only add dataset if there is at least one non-null score
                if(sub.data.some(d => d !== null)) {
                    datasets.push({
                        label: sub.label,
                        data: sub.data,
                        borderColor: sub.color,
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        pointBackgroundColor: sub.color,
                        pointRadius: 3,
                        tension: 0.4,
                        hidden: true // Start hidden
                    });
                }
            });

            mockChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: scored.map(t => new Date(t.date).toLocaleDateString('en-GB', {day: '2-digit', month: '2-digit'})),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { 
                        legend: { display: false }, // Hide default legend
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.9)',
                            padding: 12,
                            titleFont: { size: 13 },
                            bodyFont: { size: 12 },
                            cornerRadius: 8,
                            displayColors: true,
                            usePointStyle: true,
                            filter: function(tooltipItem) {
                                // Only show tooltip for visible datasets
                                return tooltipItem.dataset.hidden !== true; 
                            }
                        }
                    },
                    scales: { 
                        y: { beginAtZero: true, max: globalMax, grid: { display: true, color: 'rgba(0,0,0,0.05)' }, ticks: { font: { size: 10 } } }, 
                        x: { grid: { display: false }, ticks: { font: { size: 10 } } } 
                    }
                }
            });

            // 3. Render Custom Filter Buttons (FIXED LOGIC)
            const filterContainer = document.getElementById('chart-filters');
            filterContainer.innerHTML = '';

            datasets.forEach((ds, index) => {
                const btn = document.createElement('button');
                const color = ds.borderColor;
                
                btn.className = `px-3 py-1.5 rounded-lg text-[10px] font-bold border transition-all flex items-center gap-2 select-none`;
                
                // Function to sync button style with chart state
                const updateBtnStyle = () => {
                    // CRITICAL FIX: Check if dataset is visible using Chart.js API
                    const isVisible = mockChartInstance.isDatasetVisible(index);
                    
                    if (isVisible) {
                        btn.style.backgroundColor = color;
                        btn.style.borderColor = color;
                        btn.style.color = '#fff';
                        btn.style.opacity = '1';
                    } else {
                        btn.style.backgroundColor = 'transparent';
                        btn.style.borderColor = 'rgba(148, 163, 184, 0.5)';
                        btn.style.color = 'rgba(148, 163, 184, 1)';
                        btn.style.opacity = '0.7';
                    }
                };

                btn.onclick = () => {
                    // CRITICAL FIX: Toggle visibility using Chart.js API
                    mockChartInstance.setDatasetVisibility(index, !mockChartInstance.isDatasetVisible(index));
                    mockChartInstance.update();
                    updateBtnStyle();
                };

                btn.innerHTML = `<span class="w-2 h-2 rounded-full bg-white"></span> ${ds.label}`;
                
                // Run once to set initial state
                updateBtnStyle(); 
                filterContainer.appendChild(btn);
            });

            // 4. Render History List (Oldest to Newest)
            const list = document.getElementById('mock-history-list');
            list.innerHTML = '';
            
            [...mockTasks].sort((a,b) => new Date(a.date) - new Date(b.date)).forEach(t => {
                const el = document.createElement('div');
                el.className = "flex flex-col p-4 bg-white dark:bg-slate-800 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm gap-3 relative overflow-hidden";
                
                const marksVal = t.marks !== undefined && t.marks !== null ? t.marks : '--';
                const maxVal = t.maxMarks || 300;
                
                let breakdownHtml = '';
                if(t.subjectMarks) {
                    breakdownHtml = '<div class="flex flex-wrap gap-2 mt-2">';
                    Object.entries(t.subjectMarks).forEach(([sub, score]) => {
                        let colorClass = 'bg-slate-100 text-slate-600 dark:bg-slate-700 dark:text-slate-300';
                        if(sub === 'Physics') colorClass = 'bg-rose-50 text-rose-600 dark:bg-rose-900/20 dark:text-rose-300';
                        if(sub === 'Chemistry') colorClass = 'bg-amber-50 text-amber-600 dark:bg-amber-900/20 dark:text-amber-300';
                        if(sub === 'Maths') colorClass = 'bg-blue-50 text-blue-600 dark:bg-blue-900/20 dark:text-blue-300';
                        if(sub === 'Biology') colorClass = 'bg-emerald-50 text-emerald-600 dark:bg-emerald-900/20 dark:text-emerald-300';

                        breakdownHtml += `<span class="text-[10px] font-bold px-2 py-1 rounded-md border border-transparent ${colorClass}">${sub.substring(0,1)}: ${score}</span>`;
                    });
                    breakdownHtml += '</div>';
                } else {
                    breakdownHtml = `<div class="mt-2 text-[10px] text-amber-500 font-bold flex items-center gap-1"><i data-lucide="alert-circle" class="w-3 h-3"></i> No subject data</div>`;
                }

                el.innerHTML = `
                    <div class="flex justify-between items-start w-full relative z-10">
                        <div class="flex-1">
                            <div class="text-xs font-bold text-slate-400 mb-0.5">${formatDate(t.date)}</div>
                            <div class="font-bold text-sm text-slate-800 dark:text-white">${t.text || 'Mock Test'}</div>
                            ${breakdownHtml}
                        </div>
                        <div class="flex flex-col items-end gap-1">
                            <div class="flex items-baseline gap-0.5">
                                <span class="text-2xl font-black text-indigo-600 dark:text-indigo-400">${marksVal}</span>
                                <span class="text-xs font-bold text-slate-400">/${maxVal}</span>
                            </div>
                            <button onclick="openEditMockModal('${t.id}')" class="text-[10px] font-bold text-slate-500 hover:text-indigo-500 bg-slate-100 dark:bg-slate-700 hover:bg-indigo-50 dark:hover:bg-indigo-900/30 px-2 py-1 rounded-lg transition-colors flex items-center gap-1">
                                <i data-lucide="edit-2" class="w-3 h-3"></i> Edit
                            </button>
                        </div>
                    </div>
                `;
                list.appendChild(el);
            });
            lucide.createIcons();
        }

        window.switchView = function(view) {
            state.currentView = view;
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-container-${view}`).classList.remove('hidden');
            
            // Desktop Nav
            ['calendar', 'weekly', 'stats', 'syllabus', 'timer'].forEach(v => {
                const btn = document.getElementById(`nav-desktop-${v}`);
                if(v === view) {
                    btn.classList.add('bg-white', 'dark:bg-slate-700', 'shadow-sm', 'text-indigo-600', 'dark:text-indigo-300');
                    btn.classList.remove('text-slate-500', 'dark:text-slate-400');
                } else {
                    btn.classList.remove('bg-white', 'dark:bg-slate-700', 'shadow-sm', 'text-indigo-600', 'dark:text-indigo-300');
                    btn.classList.add('text-slate-500', 'dark:text-slate-400');
                }
            });

            // Mobile Nav
            ['calendar', 'weekly', 'stats', 'syllabus', 'timer'].forEach(v => {
                 const btn = document.getElementById(`nav-mobile-${v}`);
                 if(v === view) {
                     btn.classList.remove('text-slate-400', 'dark:text-slate-500');
                     btn.classList.add('text-indigo-600', 'dark:text-indigo-400');
                 } else {
                     btn.classList.add('text-slate-400', 'dark:text-slate-500');
                     btn.classList.remove('text-indigo-600', 'dark:text-indigo-400');
                 }
            });

            if(view === 'calendar') renderCalendar();
            if(view === 'weekly') renderWeeklyView();
            if(view === 'stats') renderMockStats();
            if(view === 'syllabus') renderSyllabusView();
            if(view === 'timer') {
                updateSubjectSelectors(); // Ensure timer subjects are up to date
                updateTimerStats();
                renderRecentLogs();
            }
        }

        // --- NEW MODAL LOGIC FOR MOBILE ---
        window.openAddTaskModal = function() {
             // Populate Subject Selector
             updateSubjectSelectors();

             const modal = document.getElementById('add-task-modal');
             modal.classList.remove('hidden');
             setTimeout(() => {
                 modal.classList.remove('opacity-0');
                 modal.querySelector('.mobile-sheet').classList.add('open');
             }, 10);
        }

        window.closeAddTaskModal = function() {
            const modal = document.getElementById('add-task-modal');
            modal.querySelector('.mobile-sheet').classList.remove('open');
            modal.classList.add('opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }
        
        // --- NEW: Helper to Render Subject-wise Mock Inputs ---
        window.renderMockSubjectFields = function(containerId, suffix) {
            const container = document.getElementById(containerId);
            const type = state.settings.examType;
            let subjects = [];

            // Determine subjects based on Exam Type
            if(type === 'NEET') subjects = ['Physics', 'Chemistry', 'Biology'];
            else subjects = ['Physics', 'Chemistry', 'Maths']; // Default to JEE/Custom

            let html = `<div class="grid grid-cols-3 gap-2 mb-3">`;
            
            subjects.forEach(sub => {
                // Shorten names for mobile UI
                const label = sub.substring(0, 3); 
                html += `
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 mb-1 uppercase text-center">${label}</label>
                        <input type="number" data-subject="${sub}" class="mock-subject-input${suffix} w-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg px-2 py-2 text-sm text-center outline-none dark:text-white font-bold focus:ring-2 focus:ring-indigo-500 appearance-none" placeholder="0" oninput="calculateMockTotal('${suffix}')">
                    </div>
                `;
            });
            html += `</div>`;

            // Prepend this to the existing Score/Total fields
            // We keep the Total fields but make "Obtained" read-only
            html += `
                <div class="flex items-center gap-2 mb-1 text-purple-700 dark:text-purple-300">
                     <i data-lucide="calculator" class="w-3.5 h-3.5"></i>
                     <span class="text-xs font-bold">Total Score</span>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-[10px] font-bold text-purple-600 dark:text-purple-400 mb-1 uppercase">Obtained</label>
                        <input type="number" id="task-marks${suffix}" placeholder="0" class="w-full bg-slate-100 dark:bg-slate-700/50 border border-purple-200 dark:border-slate-600 rounded-lg px-3 py-2 text-sm outline-none dark:text-white font-bold text-purple-600 text-center cursor-not-allowed" readonly>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-purple-600 dark:text-purple-400 mb-1 uppercase">Max Marks</label>
                        <input type="number" id="task-max-marks${suffix}" value="${type === 'NEET' ? 720 : 300}" class="w-full bg-white dark:bg-slate-800 border border-purple-200 dark:border-slate-600 rounded-lg px-3 py-2 text-sm outline-none dark:text-white font-bold text-purple-600 focus:ring-2 focus:ring-purple-500 text-center">
                    </div>
                </div>
            `;

            container.innerHTML = html;
            lucide.createIcons();
        }

        // --- NEW: Auto-Calculate Total ---
        window.calculateMockTotal = function(suffix) {
            const inputs = document.querySelectorAll(`.mock-subject-input${suffix}`);
            let total = 0;
            inputs.forEach(input => {
                const val = parseInt(input.value);
                if(!isNaN(val)) total += val;
            });
            document.getElementById(`task-marks${suffix}`).value = total > 0 ? total : '';
        }

        function updateSubjectSelectors() {
             const type = state.settings.examType;
             let subjects = [];
             
             if(type === 'NEET') subjects = ['Physics', 'Chemistry', 'Biology'];
             else if(type === 'JEE Main' || type === 'JEE Advanced') subjects = ['Physics', 'Chemistry', 'Maths'];
             else subjects = ['Physics', 'Chemistry', 'Maths', 'Biology']; 
             
             subjects = [...subjects, ...(state.settings.customSubjects || [])];
             
             // 1. Render for Add Task Forms (Desktop & Mobile)
             const fullSubjects = [...subjects, 'MockTest'];
             const renderRadios = (containerId, formSuffix) => {
                 const container = document.getElementById(containerId);
                 if(!container) return;
                 let html = '';
                 fullSubjects.forEach((sub, i) => {
                     const isMock = sub === 'MockTest';
                     const style = isMock ? 'bg-purple-50 text-purple-700 border-purple-200 dark:bg-purple-900/20 dark:text-purple-300 dark:border-purple-800' : 'bg-slate-50 text-slate-600 border-slate-200 dark:bg-slate-800 dark:text-slate-300 dark:border-slate-700';
                     const padding = formSuffix === '-mobile' ? 'py-3 rounded-xl' : 'py-2 rounded-lg'; // Taller touch target on mobile
                     html += `
                     <label class="cursor-pointer">
                         <input type="radio" name="subject" value="${sub}" class="peer sr-only ${isMock?'radio-MockTest':`radio-${sub}`}" ${i===0?'checked':''}>
                         <div class="text-center px-2 ${padding} text-xs font-bold border transition-all hover:opacity-80 peer-checked:ring-2 peer-checked:ring-offset-1 ${style}">${isMock ? 'ðŸ† Mock' : sub}</div>
                     </label>`;
                 });
                 container.innerHTML = html;
                 
                 // Mock toggle listener
                 container.querySelectorAll('input').forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        const isMobile = formSuffix === '-mobile';
                        const mockContainerId = isMobile ? 'mock-fields-container-mobile' : 'mock-fields-container';
                        const mockFields = document.getElementById(mockContainerId);
                        
                        if(e.target.value === 'MockTest') {
                            mockFields.classList.remove('hidden');
                            // CALL THE NEW RENDER FUNCTION HERE
                            renderMockSubjectFields(mockContainerId, formSuffix);
                        }
                        else {
                            mockFields.classList.add('hidden');
                        }
                    });
             });
             };

             renderRadios('subject-selector-mobile', '-mobile');
             renderRadios('subject-selector', '');
             
             // 2. Render for Timer Subject Selector
             const timerContainer = document.getElementById('timer-subject-selector');
             if(timerContainer) {
                 let timerHtml = '';
                 subjects.forEach((sub) => {
                     const isActive = timerSubject === sub;
                     const activeClass = isActive ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white dark:bg-slate-800 text-slate-500 dark:text-slate-400 hover:bg-slate-50';
                     timerHtml += `
                         <button onclick="setTimerSubject('${sub}')" data-sub="${sub}" class="timer-subject-pill px-3 py-1.5 rounded-full border border-slate-200 dark:border-slate-700 text-xs font-bold transition-all ${activeClass}">
                            ${sub}
                         </button>
                     `;
                 });
                 timerContainer.innerHTML = timerHtml;
             }
        }

        // Handle Add Task Form Submission (Mobile)
        document.getElementById('add-task-form-mobile').addEventListener('submit', async (e) => {
            e.preventDefault();
            await handleTaskSubmit('mobile');
        });

        // Handle Add Task Form Submission (Desktop)
        document.getElementById('add-task-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            await handleTaskSubmit('desktop');
        });

        async function handleTaskSubmit(mode) {
            if(!currentUser) return;
            const suffix = mode === 'mobile' ? '-mobile' : '';
            const btn = document.getElementById(`btn-add-task${suffix}`);
            const originalContent = btn.innerHTML;
            btn.innerHTML = `<div class="btn-spinner"></div>`;
            btn.disabled = true;

            const date = document.getElementById(`task-date${suffix}`).value;
            const text = document.getElementById(`task-input${suffix}`).value;
            const selectorId = mode === 'mobile' ? 'subject-selector-mobile' : 'subject-selector';
            const subject = document.querySelector(`#${selectorId} input[name="subject"]:checked`)?.value;
            
            if(!date || !text || !subject) {
                showToast("Missing details!");
                btn.innerHTML = originalContent;
                btn.disabled = false;
                lucide.createIcons();
                return;
            }

            const newTask = { text, date, subject, completed: false, createdAt: new Date().toISOString() };
            
            if(subject === 'MockTest') {
                const marksId = `task-marks${suffix}`;
                const maxMarksId = `task-max-marks${suffix}`;
                const marks = document.getElementById(marksId).value;
                
                // --- NEW: Gather Subject Breakdown ---
                const subjectInputs = document.querySelectorAll(`.mock-subject-input${suffix}`);
                let subjectMarks = {};
                subjectInputs.forEach(input => {
                    const sub = input.dataset.subject;
                    const val = parseInt(input.value);
                    if(!isNaN(val)) subjectMarks[sub] = val;
                });

                if(Object.keys(subjectMarks).length > 0) newTask.subjectMarks = subjectMarks;
                // -------------------------------------

                if(marks) { newTask.marks = marks; newTask.completed = true; }
                newTask.maxMarks = document.getElementById(maxMarksId).value || 300;
            }

            try {
                await setDoc(doc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'tasks')), newTask);
                showToast("Added to Plan!");
                
                // Reset Fields
                document.getElementById(`task-input${suffix}`).value = '';
                if(mode === 'mobile') {
                    // document.getElementById('task-marks-mobile').value = ''; // No longer exists directly
                    closeAddTaskModal();
                } else {
                    // document.getElementById('task-marks').value = ''; // No longer exists directly
                }
                
                const addedDate = new Date(date);
                if(addedDate.getMonth() !== state.viewDate.getMonth()) {
                    state.viewDate = addedDate;
                    if(state.currentView === 'calendar') renderCalendar();
                }
            } catch(e) { console.error(e); }
            
            btn.innerHTML = originalContent;
            btn.disabled = false;
            lucide.createIcons();
        }

        window.changeMonth = function(d) { state.viewDate.setMonth(state.viewDate.getMonth() + d); renderCalendar(); }
        window.goToToday = function() { 
            state.viewDate = new Date(); 
            renderCalendar(); 
            setTimeout(() => {
                const card = document.getElementById('today-card');
                if(card) card.scrollIntoView({behavior: 'smooth', block: 'center'});
            }, 100);
        }
        
        window.openDayView = function(dateStr) {
            currentDayViewDate = dateStr; 
            const modal = document.getElementById('day-view-modal');
            const list = document.getElementById('day-view-tasks');
            const dateObj = new Date(dateStr);
            document.getElementById('day-view-date').innerText = dateObj.toLocaleDateString('en-GB', {weekday:'long', day: 'numeric', month: 'short'});
            
            const tasks = state.tasks.filter(t => t.date === dateStr);
            list.innerHTML = '';
            
            if(tasks.length === 0) list.innerHTML = `<div class="text-center text-slate-400 italic py-8 flex flex-col items-center justify-center h-full"><i data-lucide="coffee" class="w-10 h-10 mb-2 opacity-20"></i><p>Free Day! No tasks scheduled.</p></div>`;
            
            tasks.forEach(t => {
                const el = document.createElement('div');
                const isMock = t.subject === 'MockTest';
                el.className = "flex items-center gap-3 p-4 bg-slate-50 dark:bg-slate-800 rounded-xl border border-slate-100 dark:border-slate-700";
                
                const badgeClass = state.settings.theme === 'dark' ? (subjectColors[t.subject]?.dark || subjectColors.Custom.dark) : (subjectColors[t.subject]?.light || subjectColors.Custom.light);
                
                let contentHTML = '';
                if(isMock) {
                    const marksVal = t.marks !== undefined && t.marks !== null ? t.marks : '';
                    const maxVal = t.maxMarks || 300;
                    contentHTML = `
                        <div class="flex-1">
                            <span class="text-[10px] font-bold px-1.5 py-0.5 rounded ${badgeClass}">${t.subject}</span>
                            <div class="text-sm font-medium mb-1.5 ${t.completed ? 'line-through opacity-50' : ''}">${t.text}</div>
                            <div class="flex items-center gap-2">
                                <span class="text-[10px] font-bold text-slate-400 uppercase">Score:</span>
                                <input type="number" value="${marksVal}" onchange="updateTaskScore('${t.id}', 'obtained', this.value)" placeholder="--" class="w-12 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-600 rounded px-1 py-1 text-xs text-center font-bold text-indigo-600 focus:ring-1 focus:ring-indigo-500 outline-none appearance-none">
                                <span class="text-slate-400 text-xs">/</span>
                                <input type="number" value="${maxVal}" onchange="updateTaskScore('${t.id}', 'total', this.value)" class="w-12 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-600 rounded px-1 py-1 text-xs text-center font-bold text-slate-500 focus:ring-1 focus:ring-indigo-500 outline-none appearance-none">
                            </div>
                        </div>
                    `;
                } else {
                    contentHTML = `
                        <div class="flex-1">
                            <span class="text-[10px] font-bold px-1.5 py-0.5 rounded ${badgeClass}">${t.subject}</span>
                            <div class="text-sm font-medium ${t.completed ? 'line-through opacity-50' : ''}">${t.text}</div>
                        </div>
                    `;
                }

                el.innerHTML = `
                    <input type="checkbox" ${t.completed ? 'checked' : ''} class="w-6 h-6 rounded accent-indigo-600 shrink-0" onclick="toggleTask('${t.id}', ${t.completed})">
                    ${contentHTML}
                    <button onclick="requestDelete('task', '${t.id}')" class="text-slate-300 hover:text-rose-500 p-2"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                `;
                list.appendChild(el);
            });
            lucide.createIcons();
            
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modal.querySelector('.mobile-sheet').classList.add('open');
            }, 10);
        }

        window.addTaskFromDayView = function() {
            if (currentDayViewDate) {
                // FIX: Capture the date locally BEFORE closing the view
                // This prevents the race condition where closeDayView() sets the global variable to null
                const dateToUse = currentDayViewDate; 
                
                closeDayView();
                
                // Wait for the close animation to finish, then open the Add Task modal
                setTimeout(() => {
                    selectDateForAdd(dateToUse); // Use the captured local variable
                }, 300);
            }
        }

        window.toggleTask = async function(id, status) {
            if(!currentUser) return;
            await updateDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'tasks', id), { completed: !status });
            const task = state.tasks.find(t=>t.id===id);
            if(task && document.getElementById('day-view-modal').classList.contains('hidden') === false) {
                 setTimeout(() => openDayView(task.date), 200);
            }
        }

        window.closeDayView = () => { 
            const modal = document.getElementById('day-view-modal');
            modal.querySelector('.mobile-sheet').classList.remove('open');
            modal.classList.add('opacity-0'); 
            setTimeout(() => {
                modal.classList.add('hidden');
                currentDayViewDate = null;
            }, 300); 
        }
        
        window.closeConfirmModal = () => { document.getElementById('confirm-modal').classList.add('opacity-0'); setTimeout(() => document.getElementById('confirm-modal').classList.add('hidden'), 200); }
        
        window.openCustomSubjectModal = () => {
             document.getElementById('custom-subject-input').value = '';
             document.getElementById('custom-subject-modal').classList.remove('hidden');
             setTimeout(() => document.getElementById('custom-subject-modal').classList.remove('opacity-0'), 10);
             document.getElementById('custom-subject-input').focus();
             
             // NEW: Render the list of existing custom subjects
             renderCustomSubjectsList();
        }

        // NEW: Function to render the list
        function renderCustomSubjectsList() {
            const list = document.getElementById('custom-subjects-list');
            const subjects = state.settings.customSubjects || [];
            
            list.innerHTML = '';

            if(subjects.length === 0) {
                list.innerHTML = `<p class="text-xs text-slate-400 italic text-center py-2">No custom subjects added.</p>`;
                return;
            }

            subjects.forEach(sub => {
                const el = document.createElement('div');
                el.className = "flex justify-between items-center p-2 bg-slate-50 dark:bg-slate-700/30 rounded-lg group";
                el.innerHTML = `
                    <span class="text-sm font-medium text-slate-700 dark:text-slate-300 pl-1">${sub}</span>
                    <button onclick="deleteCustomSubject('${sub}')" class="p-1.5 text-slate-400 hover:text-rose-500 hover:bg-rose-50 dark:hover:bg-rose-900/20 rounded-md transition-colors" title="Remove Subject">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                `;
                list.appendChild(el);
            });
            lucide.createIcons();
        }

        // NEW: Function to delete a custom subject
        window.deleteCustomSubject = async (sub) => {
            if(!currentUser) return;
            
            // UI Feedback (Optimistic update)
            const newSubjects = state.settings.customSubjects.filter(s => s !== sub);
            state.settings.customSubjects = newSubjects;
            
            // Re-render the list in modal and the main selector
            renderCustomSubjectsList();
            updateSubjectSelectors();

            try {
                // Update Firestore
                await updateDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'settings', 'config'), { 
                    customSubjects: arrayRemove(sub) 
                });
                showToast("Subject removed");
            } catch(e) {
                console.error("Error removing subject:", e);
                showToast("Error removing subject");
            }
        }

        window.confirmAddSubject = async () => {
            const sub = document.getElementById('custom-subject-input').value.trim();
            if(sub) {
                if(!state.settings.customSubjects.includes(sub)) {
                    // Update Local State immediately
                    if (!state.settings.customSubjects) state.settings.customSubjects = [];
                    state.settings.customSubjects.push(sub);
                    
                    // Update UI immediately
                    renderCustomSubjectsList();
                    updateSubjectSelectors();

                    // Update Firestore
                    try {
                        await updateDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'settings', 'config'), { customSubjects: arrayUnion(sub) });
                        showToast(`${sub} added!`);
                        document.getElementById('custom-subject-input').value = ''; // Clear input
                    } catch(e) {
                        console.error(e);
                    }
                } else {
                    showToast("Subject already exists");
                }
            }
        }

        window.closeCustomSubjectModal = () => {
             document.getElementById('custom-subject-modal').classList.add('opacity-0');
             setTimeout(() => document.getElementById('custom-subject-modal').classList.add('hidden'), 200);
        }

        function updateStats() { }

        function renderCountdown() {
            const card = document.getElementById('desktop-countdown-card');
            const pill = document.getElementById('mobile-countdown-pill');
            
            if(!state.settings.showCountdown) {
                card.classList.add('hidden');
                pill.classList.add('hidden');
                return;
            } else {
                card.classList.remove('hidden');
                pill.classList.remove('hidden');
            }

            const target = new Date(state.settings.targetDate);
            const now = new Date();
            const diff = target - now;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            
            // Desktop
            document.getElementById('days-left-desktop').innerText = days > 0 ? days : 0;
            document.getElementById('target-date-display-desktop').innerText = `Goal: ${target.toLocaleDateString('en-GB')}`;
            
            // Mobile
            document.getElementById('days-left-mobile').innerText = `${days > 0 ? days : 0} days left`;
        }
        
        function getLocalISODate(d) { const z = d.getTimezoneOffset() * 60000; return new Date(d.getTime() - z).toISOString().split('T')[0]; }
        function showToast(msg) { 
            const t = document.getElementById('toast'); 
            document.getElementById('toast-msg').innerText = msg; 
            t.classList.remove('opacity-0', 'translate-y-[-20px]', 'md:translate-y-4'); 
            setTimeout(() => t.classList.add('opacity-0', 'translate-y-[-20px]', 'md:translate-y-4'), 3000); 
        }
        

        
        window.openSettings = () => { 
            tempSettings = { ...state.settings };
            document.getElementById('settings-bg-url').value = tempSettings.bgUrl || '';
            document.getElementById('settings-year').value = tempSettings.targetYear || 2026;
            setExamType(tempSettings.examType || 'JEE Main');
            
            const isShown = tempSettings.showCountdown !== false;
            const knob = document.getElementById('countdown-knob');
            const toggle = document.getElementById('countdown-toggle');
            if(isShown) {
                knob.style.transform = 'translateX(20px)';
                toggle.className = "relative w-12 h-7 bg-indigo-600 rounded-full transition-all duration-300";
            } else {
                knob.style.transform = 'translateX(0)';
                toggle.className = "relative w-12 h-7 bg-slate-200 dark:bg-slate-600 rounded-full transition-all duration-300";
            }
            
            resetSettingsDirty(); 
            // Correctly set toggle UI based on current theme state when opening
            applyTheme(tempSettings.theme || 'light');

            const modal = document.getElementById('settings-modal');
            modal.classList.remove('hidden'); 
            setTimeout(()=> {
                modal.classList.remove('opacity-0');
                modal.querySelector('.mobile-sheet').classList.add('open');
            }, 10); 
            if (tempSettings.examType === 'Custom') {
                document.getElementById('custom-date-container').classList.remove('hidden');
                document.getElementById('settings-custom-date').value = tempSettings.targetDate || '';
            } else {
                document.getElementById('custom-date-container').classList.add('hidden');
            }
        }
        
        window.closeSettings = () => { 
            // Revert theme if changes weren't saved
            if(state.settings.theme) applyTheme(state.settings.theme);

            const modal = document.getElementById('settings-modal');
            modal.querySelector('.mobile-sheet').classList.remove('open');
            modal.classList.add('opacity-0'); 
            setTimeout(()=>modal.classList.add('hidden'), 200); 
        }
        
        window.toggleCountdownSetting = () => {
            tempSettings.showCountdown = !tempSettings.showCountdown;
            const isShown = tempSettings.showCountdown;
            const knob = document.getElementById('countdown-knob');
            const toggle = document.getElementById('countdown-toggle');
            
            if(isShown) {
                knob.style.transform = 'translateX(20px)';
                toggle.className = "relative w-12 h-7 bg-indigo-600 rounded-full transition-all duration-300";
            } else {
                knob.style.transform = 'translateX(0)';
                toggle.className = "relative w-12 h-7 bg-slate-200 dark:bg-slate-600 rounded-full transition-all duration-300";
            }
            markSettingsDirty();
        }

        window.toggleTheme = () => { 
            const currentTheme = tempSettings.theme || state.settings.theme || 'light';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            tempSettings.theme = newTheme;
            applyTheme(newTheme);
            markSettingsDirty();
        }
        
        // --- KEYBOARD & TOUCH NAVIGATION ---
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Ignore if typing in input/textarea
                if (['INPUT', 'TEXTAREA', 'SELECT'].includes(document.activeElement.tagName)) return;
                
                // Helper: Is any modal open?
                const isModalOpen = !document.getElementById('add-task-modal').classList.contains('hidden') ||
                                    !document.getElementById('settings-modal').classList.contains('hidden') ||
                                    !document.getElementById('day-view-modal').classList.contains('hidden') ||
                                    !document.getElementById('custom-subject-modal').classList.contains('hidden');

                switch(e.key) {
                    case 'ArrowRight':
                        if (isModalOpen) return;
                        if (state.currentView === 'calendar') { changeMonth(1); showToast('Next Month'); }
                        else if (state.currentView === 'weekly') { changeWeek(1); showToast('Next Week'); }
                        break;
                    case 'ArrowLeft':
                        if (isModalOpen) return;
                        if (state.currentView === 'calendar') { changeMonth(-1); showToast('Previous Month'); }
                        else if (state.currentView === 'weekly') { changeWeek(-1); showToast('Previous Week'); }
                        break;
                    case 'n':
                    case 'N':
                        if (isModalOpen) return;
                        e.preventDefault();
                        if (window.innerWidth < 768) openAddTaskModal();
                        else document.getElementById('task-input').focus();
                        break;
                    case 't':
                    case 'T':
                         if (isModalOpen) return;
                         goToToday();
                         showToast('Today');
                         break;
                    case 'Escape':
                        if (!document.getElementById('add-task-modal').classList.contains('hidden')) closeAddTaskModal();
                        if (!document.getElementById('settings-modal').classList.contains('hidden')) closeSettings();
                        if (!document.getElementById('day-view-modal').classList.contains('hidden')) closeDayView();
                        if (!document.getElementById('custom-subject-modal').classList.contains('hidden')) closeCustomSubjectModal();
                        break;
                    case '1': switchView('calendar'); showToast('Planner View'); break;
                    case '2': switchView('weekly'); showToast('Targets View'); break;
                    case '3': switchView('stats'); showToast('Stats View'); break;
                    case '4': switchView('syllabus'); showToast('Syllabus View'); break;
                }
            });
        }

        function setupTouchGestures() {
            // Main View Swipes (Left/Right)
            const mainContent = document.getElementById('main-content-area');
            let touchStartX = 0;
            let touchStartY = 0;

            mainContent.addEventListener('touchstart', e => {
                touchStartX = e.changedTouches[0].screenX;
                touchStartY = e.changedTouches[0].screenY;
            }, {passive: true});

            mainContent.addEventListener('touchend', e => {
                const touchEndX = e.changedTouches[0].screenX;
                const touchEndY = e.changedTouches[0].screenY;
                const diffX = touchEndX - touchStartX;
                const diffY = touchEndY - touchStartY;
                
                // Horizontal Swipe threshold
                if (Math.abs(diffX) > 50 && Math.abs(diffX) > Math.abs(diffY)) {
                     // Check if modal is open (don't swipe view if modal is up)
                    const isModalOpen = !document.getElementById('add-task-modal').classList.contains('hidden') ||
                                        !document.getElementById('settings-modal').classList.contains('hidden') ||
                                        !document.getElementById('day-view-modal').classList.contains('hidden');
                    
                    if(isModalOpen) return;

                    if (diffX < 0) {
                        // Swipe Left -> Next
                        if (state.currentView === 'calendar') changeMonth(1);
                        else if (state.currentView === 'weekly') changeWeek(1);
                    } else {
                        // Swipe Right -> Prev
                        if (state.currentView === 'calendar') changeMonth(-1);
                        else if (state.currentView === 'weekly') changeWeek(-1);
                    }
                }
            }, {passive: true});
            
            // Bottom Sheet Swipe Down to Close Logic
            const attachSwipeDown = (modalId, closeFn) => {
                const modal = document.getElementById(modalId);
                const sheet = modal.querySelector('.mobile-sheet');
                let startY = 0;
                let currentY = 0;

                sheet.addEventListener('touchstart', (e) => {
                    const scrollEl = sheet.querySelector('.overflow-y-auto');
                    const scrollTop = scrollEl ? scrollEl.scrollTop : 0;
                    
                    // 1. Must be at the top of the scroll content
                    if (scrollTop > 0) {
                        startY = -1;
                        return;
                    }

                    // 2. FIX: Don't trigger drag on interactive elements
                    // This prevents the modal from closing when interacting with inputs, subject selectors (labels), or buttons
                    if (e.target.closest('input, textarea, select, label, button, .no-drag')) {
                        startY = -1;
                        return;
                    }

                    startY = e.touches[0].clientY;
                }, {passive: true});

                sheet.addEventListener('touchmove', (e) => {
                    if (startY === -1) return;
                    currentY = e.touches[0].clientY;
                    const diff = currentY - startY;
                    
                    // Only move if pulling down
                    if (diff > 0) {
                        // Prevent default only if we are actually dragging the sheet
                        // This allows natural scrolling behavior if the intent wasn't a sheet drag
                        if (e.cancelable) e.preventDefault(); 
                        sheet.style.transform = `translateY(${diff}px)`;
                    }
                }, {passive: false});

                sheet.addEventListener('touchend', (e) => {
                    if (startY === -1) return;
                    const diff = currentY - startY;
                    sheet.style.transform = ''; // Clear inline style to let CSS class take over
                    if (diff > 100) { // Threshold to close
                        closeFn();
                    } else {
                        sheet.classList.add('open'); // Snap back
                    }
                    startY = -1;
                    currentY = 0;
                });
            }

            attachSwipeDown('add-task-modal', closeAddTaskModal);
            attachSwipeDown('day-view-modal', closeDayView);
            attachSwipeDown('settings-modal', closeSettings);
        }

        // Initialize Desktop Date Input
        document.getElementById('task-date').value = getLocalISODate(new Date());
        document.getElementById('task-date-mobile').value = getLocalISODate(new Date());
        initAuth();
        lucide.createIcons();
    </script>
</body>
</html>
